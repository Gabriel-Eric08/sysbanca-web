<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cadastro de Regi√µes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .botao-estiloso, .botao-voltar, .botao-salvar {
      font-size: 18px;
      color: white;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      border: none;
      padding: 6px 20px;
      cursor: pointer;
    }
    .botao-estiloso { background-color: #072749; }
    .botao-estiloso:hover { background-color: #0056b3; }
    .botao-voltar { background-color: #1fa53c; }
    .botao-voltar:hover { background-color: #128d2e; }
    .botao-salvar { background-color: #be0d0d; }
    .botao-salvar:hover { background-color: #ec5050; }
    .botao-estiloso::after, .botao-voltar::after, .botao-salvar::after {
      content: "";
      position: absolute;
      top: 0; left: -100%;
      width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.2);
      transform: skewX(-20deg);
      transition: left 0.5s ease;
    }
    .botao-estiloso:hover::after,
    .botao-voltar:hover::after,
    .botao-salvar:hover::after {
      left: 100%;
    }
  </style>
</head>
<body class="bg-light p-4">
  <div class="container">
    <h2 class="mb-4">Cadastro de Regi√µes</h2>

    <div class="row g-3 align-items-center mb-3">
      <div class="col-md-3">
        <label for="regiao" class="form-label">Regi√£o</label>
        <input type="text" class="form-control" id="regiao" />
      </div>
      <div class="col-md-3">
        <label for="desc_regiao" class="form-label">Descri√ß√£o</label>
        <input type="text" class="form-control" id="desc_regiao" />
      </div>
      <div class="col-md-2">
        <label for="ativo" class="form-label">Ativar</label>
        <select class="form-select" id="ativo">
          <option value=""></option>
          <option value="sim">Sim</option>
          <option value="nao">N√£o</option>
        </select>
      </div>
      <div class="col-md-4">
        <label for="busca" class="form-label">Buscar Regi√£o</label>
        <input type="text" class="form-control" id="busca" placeholder="üîç Digite a Regi√£o" />
      </div>
    </div>

    <div class="d-flex gap-3 mb-4">
      <button type="button" class="botao-estiloso" onclick="adicionarLinha()">‚ûï Adicionar</button>
      <button type="button" class="botao-voltar" onclick="salvartabela()">üíæ Salvar</button>
      <a href="{{ url_for('Home.home') }}" class="btn botao-salvar">üö™ Sair</a>
    </div>

    <table class="table table-bordered table-hover bg-white" id="tabela">
      <thead class="table-success">
        <tr>
          <th>Regi√£o</th>
          <th>Descri√ß√£o</th>
          <th>Ativar Regi√£o</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        {% if regioes %}
        {% for r in regioes %}
        <tr>
          <td>{{ r.regiao }}</td>
          <td>{{ r.desc_regiao }}</td>
          <td>{{ 'Sim' if r.ativo else 'N√£o' }}</td>
          <td>
            <button type="button" class="botao-estiloso" onclick="editarLinhaInline(this)">‚úèÔ∏è Editar</button>
            <button type="button" class="botao-salvar ms-2" onclick="excluirLinhaServidor('{{ r.regiao }}', this)">üóëÔ∏è Excluir</button>
          </td>
        </tr>
        {% endfor %}
        {% endif %}
      </tbody>
    </table>

    {% if not regioes %}
    <div class="alert alert-success">Nenhuma regi√£o cadastrada.</div>
    {% endif %}
  </div>

  <script>
    function adicionarLinha() {
      const regiao = document.getElementById('regiao').value.trim();
      const desc_regiao = document.getElementById('desc_regiao').value.trim();
      const ativo = document.getElementById('ativo').value;

      if (!regiao || !desc_regiao || !ativo) {
        alert('Preencha todos os campos!');
        return;
      }

      const tabela = document.getElementById('tabela').querySelector('tbody');
      const novaLinha = tabela.insertRow();

      novaLinha.innerHTML = `
        <td>${regiao}</td>
        <td>${desc_regiao}</td>
        <td>${ativo === 'sim' ? 'Sim' : 'N√£o'}</td>
        <td>
          <button type="button" class="botao-estiloso" onclick="editarLinhaInline(this)">‚úèÔ∏è Editar</button>
          <button type="button" class="botao-salvar ms-2" onclick="excluirLinha(this)">üóëÔ∏è Excluir</button>
        </td>
      `;

      document.getElementById('regiao').value = '';
      document.getElementById('desc_regiao').value = '';
      document.getElementById('ativo').value = '';
    }

    function editarLinhaInline(botao) {
      const linha = botao.closest("tr");

      const regiao = linha.cells[0].textContent.trim();
      const desc_regiao = linha.cells[1].textContent.trim();
      const ativo = linha.cells[2].textContent.trim().toLowerCase();

      linha.innerHTML = `
        <td><input type="text" class="form-control" value="${regiao}"></td>
        <td><input type="text" class="form-control" value="${desc_regiao}" /></td>
        <td>
          <select class="form-select">
            <option value="sim" ${ativo === 'sim' ? 'selected' : ''}>Sim</option>
            <option value="nao" ${ativo === 'nao' ? 'selected' : ''}>N√£o</option>
          </select>
        </td>
        <td>
          <button type="button" class="botao-voltar" onclick="salvarEdicao(this)">üíæ Salvar</button>
          <button type="button" class="botao-salvar ms-2" onclick="cancelarEdicao(this, '${regiao}', '${desc_regiao}', '${ativo}')">‚ùå Cancelar</button>
        </td>
      `;
    }

    function cancelarEdicao(botao, regiao, desc_regiao, ativo) {
      const linha = botao.closest("tr");

      linha.innerHTML = `
        <td>${regiao}</td>
        <td>${desc_regiao}</td>
        <td>${ativo === 'sim' ? 'Sim' : 'N√£o'}</td>
        <td>
          <button type="button" class="botao-estiloso" onclick="editarLinhaInline(this)">‚úèÔ∏è Editar</button>
          <button type="button" class="botao-salvar ms-2" onclick="excluirLinhaServidor('${regiao}', this)">üóëÔ∏è Excluir</button>
        </td>
      `;
    }

    function salvarEdicao(botao) {
      const linha = botao.closest("tr");

      const regiao = linha.cells[0].querySelector("input").value.trim();
      const desc_regiao = linha.cells[1].querySelector("input").value.trim();
      const ativo = linha.cells[2].querySelector("select").value;

      if (!desc_regiao || !ativo) {
        alert("Preencha todos os campos.");
        return;
      }

      fetch('/regiao/editar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ regiao, desc_regiao, ativo })
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message || "Regi√£o atualizada com sucesso!");

        linha.innerHTML = `
          <td>${regiao}</td>
          <td>${desc_regiao}</td>
          <td>${ativo === 'sim' ? 'Sim' : 'N√£o'}</td>
          <td>
            <button type="button" class="botao-estiloso" onclick="editarLinhaInline(this)">‚úèÔ∏è Editar</button>
            <button type="button" class="botao-salvar ms-2" onclick="excluirLinhaServidor('${regiao}', this)">üóëÔ∏è Excluir</button>
          </td>
        `;
      })
      .catch(err => {
        console.error("Erro ao salvar edi√ß√£o:", err);
        alert("Erro ao salvar edi√ß√£o.");
      });
    }

    function excluirLinha(botao) {
      const linha = botao.closest("tr");
      if (confirm("Tem certeza que deseja excluir esta regi√£o?")) {
        linha.remove();
      }
    }

    function excluirLinhaServidor(regiao, botao) {
      if (confirm(`Tem certeza que deseja excluir a regi√£o "${regiao}"?`)) {
        fetch('/regiao/', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ Regiao: regiao })
        })
        .then(res => res.json())
        .then(data => {
          alert(data.message);
          botao.closest("tr").remove();
        })
        .catch(err => {
          console.error("Erro ao excluir:", err);
          alert("Erro ao excluir regi√£o.");
        });
      }
    }

    function salvartabela() {
  const linhas = document.querySelectorAll("#tabela tbody tr");
  const regioes = [];

  linhas.forEach(linha => {
    // Ignora linhas em modo edi√ß√£o (com input/select vis√≠vel)
    if (linha.querySelector("input") || linha.querySelector("select")) return;

    const regiao = linha.cells[0].textContent.trim();
    const desc_regiao = linha.cells[1].textContent.trim();
    const ativo = linha.cells[2].textContent.trim().toLowerCase();

    // Evita salvar linhas vazias
    if (!regiao || !desc_regiao || (ativo !== 'sim' && ativo !== 'n√£o')) return;

    regioes.push({ regiao, desc_regiao, ativo });
  });

  if (regioes.length === 0) {
    alert("Nenhuma linha v√°lida para salvar.");
    return;
  }

  fetch('/regiao/', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ regioes })
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message);
    location.reload();
  })
  .catch(err => {
    console.error("Erro ao salvar regi√µes:", err);
    alert("Erro ao salvar regi√µes.");
  });
}
    function filtrarTabela() {
      const termo = document.getElementById("busca").value.toLowerCase();
      const linhas = document.querySelectorAll("#tabela tbody tr");

      linhas.forEach(linha => {
        const regiao = linha.cells[0].textContent.toLowerCase();
        linha.style.display = regiao.includes(termo) ? "" : "none";
      });
    }

    document.getElementById("busca").addEventListener("input", filtrarTabela);
  </script>
</body>
</html>
