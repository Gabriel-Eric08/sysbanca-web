<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cadastro de √Åreas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <style>
    .botao-estiloso, .botao-voltar, .botao-salvar {
      font-size: 18px;
      color: white;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      border: none;
      padding: 6px 20px;
      cursor: pointer;
    }
    .botao-estiloso { background-color: #072749; }
    .botao-estiloso:hover { background-color: #0056b3; }
    .botao-voltar { background-color: #1fa53c; }
    .botao-voltar:hover { background-color: #128d2e; }
    .botao-salvar { background-color: #be0d0d; }
    .botao-salvar:hover { background-color: #ec5050; }
    .botao-estiloso::after, .botao-voltar::after, .botao-salvar::after {
      content: "";
      position: absolute;
      top: 0; left: -100%;
      width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.2);
      transform: skewX(-20deg);
      transition: left 0.5s ease;
    }
    .botao-estiloso:hover::after,
    .botao-voltar:hover::after,
    .botao-salvar:hover::after {
      left: 100%;
    }
    tbody > tr:nth-child(odd) {
      background-color: #f2f2f2;
    }
  </style>
</head>
<body class="p-4">

<div class="container">
  <h2 class="mb-4">Cadastro de √Åreas</h2>

  <form id="form-area">
    <div class="row g-3 mb-3">
      <div class="col-md-4">
        <label class="form-label" for="regiao_area">√Årea:</label>
        <input type="text" class="form-control" id="regiao_area" />
      </div>

      <div class="col-md-4">
        <label class="form-label" for="desc_area">Complemento:</label>
        <input type="text" class="form-control" id="desc_area" />
      </div>

      <div class="col-md-4">
        <label class="form-label" for="ativo">Ativo:</label>
        <select id="ativo" class="form-select">
          <option value="sim">Sim</option>
          <option value="nao">N√£o</option>
        </select>
      </div>
    </div>

    <div class="d-flex flex-wrap gap-2 mb-3">
      <button type="button" class="botao-estiloso" onclick="adicionarArea()">‚ûï Adicionar</button>
      <input type="text" id="busca" placeholder="Digite a √Årea" class="form-control w-auto" />
      <button type="button" class="botao-estiloso" onclick="buscarArea()">üîé  Buscar</button>
      <button type="button" class="botao-voltar" onclick="prepararEnvioArea()">üíæ Salvar</button>
      <a href="{{ url_for('Home.home') }}" class="btn botao-salvar">‚ùå Sair</a>
    </div>
  </form>

  <table class="table table-bordered table-striped">
    <thead class="table-success">
      <tr>
        <th>√Årea</th>
        <th>Complemento</th>
        <th>Ativo</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody id="tabela-area">
      {% if areas %}
        {% for a in areas %}
          <tr data-id="{{ a.id }}">
            <td>{{ a.regiao_area }}</td>
            <td>{{ a.desc_area }}</td>
            <td>{% if a.ativar_area in [1, '1', 'sim', 'Sim', 'SIM'] %}Sim{% else %}N√£o{% endif %}</td>
            <td>
              <button type="button" class="botao-estiloso">‚úèÔ∏è Editar</button>
              <button type="button" class="botao-salvar" onclick="excluirArea('{{ a.regiao_area }}', this)">üóëÔ∏è Excluir</button>
            </td>
          </tr>
        {% endfor %}
    </tbody>
      {% else %}
      <div colspan="4" class="text-center"> Nenhuma √°rea cadastrada. </div>
      {% endif %}
  </table>
</div>

<script>
function adicionarArea() {
  const regiao = document.getElementById('regiao_area').value.trim();
  const desc = document.getElementById('desc_area').value.trim();
  const ativo = document.getElementById('ativo').value.trim();

  if (!regiao || !desc || !ativo) {
    alert("Preencha todos os campos!");
    return;
  }

  const tabela = document.getElementById('tabela-area');
  const novaLinha = tabela.insertRow();

  novaLinha.insertCell(0).textContent = regiao;
  novaLinha.insertCell(1).textContent = desc;
  novaLinha.insertCell(2).textContent = ativo;

  const acoes = novaLinha.insertCell(3);
  acoes.innerHTML = `
    <button type="button" class="botao-estiloso">‚úèÔ∏è Editar</button>
    <button type="button" class="botao-salvar" onclick="excluirArea('${regiao}', this)">üóëÔ∏è Excluir</button>
  `;

  document.getElementById('regiao_area').value = "";
  document.getElementById('desc_area').value = "";
  document.getElementById('ativo').value = "sim";
}

function buscarArea() {
  const termo = document.getElementById("busca").value.toLowerCase();
  const linhas = document.querySelectorAll("#tabela-area tr");

  let encontrado = false;

  linhas.forEach(linha => {
    const area = linha.cells[0]?.textContent.toLowerCase();
    if (area && area.includes(termo)) {
      document.getElementById("regiao_area").value = linha.cells[0].textContent;
      document.getElementById("desc_area").value = linha.cells[1].textContent;
      document.getElementById("ativo").value = linha.cells[2].textContent.toLowerCase();
      encontrado = true;
    }
  });

  if (!encontrado) {
    alert("√Årea n√£o encontrada na tabela.");
  }
}

function prepararEnvioArea() {
  const tabela = document.getElementById('tabela-area');
  const areas = [];

  for (let i = 0; i < tabela.rows.length; i++) {
    const cells = tabela.rows[i].cells;
    areas.push({
      regiao_area: cells[0].textContent.trim(),
      desc_area: cells[1].textContent.trim(),
      ativar_area: cells[2].textContent.trim().toLowerCase() === "sim"
    });
  }

  fetch('/area/', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(areas)
  })
  .then(response => response.json())
  .then(data => {
    alert(data.message);
    if (data.success) {
      window.location.reload();
    }
  })
  .catch(error => {
    console.error('Erro:', error);
    alert('Erro ao salvar as √°reas.');
  });
}

function excluirArea(areaNome, botao) {
  const row = botao.closest('tr');
  const id = row.getAttribute('data-id');

  if (!confirm(`Deseja excluir a √°rea "${areaNome}"?`)) return;

  fetch('/area/', {
    method: 'DELETE',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ id })
  })
  .then(response => response.json())
  .then(data => {
    alert(data.message);
    if (data.success) {
      row.remove();
    }
  })
  .catch(error => {
    console.error('Erro:', error);
    alert('Erro ao excluir a √°rea.');
  });
}

document.getElementById("busca").addEventListener("input", function () {
  const termo = this.value.toLowerCase();
  const linhas = document.querySelectorAll("#tabela-area tr");

  linhas.forEach(linha => {
    const area = linha.cells[0]?.textContent.toLowerCase() || "";
    linha.style.display = area.includes(termo) ? "" : "none";
  });
});
document.querySelectorAll('#tabela-area button').forEach(btn => {
  if (btn.textContent.includes('‚úèÔ∏è')) {
    btn.onclick = () => editarLinha(btn);
  }
});

function editarLinha(botao) {
  const linha = botao.closest('tr');
  const celulas = linha.querySelectorAll('td');
  const id = linha.getAttribute('data-id');

  const regiao = celulas[0].textContent.trim();
  const desc = celulas[1].textContent.trim();
  const ativo = celulas[2].textContent.trim();

  celulas[0].innerHTML = `<input type="text" class="form-control" value="${regiao}">`;
  celulas[1].innerHTML = `<input type="text" class="form-control" value="${desc}">`;
  celulas[2].innerHTML = `
    <select class="form-select">
      <option value="sim" ${ativo.toLowerCase() === "sim" ? "selected" : ""}>Sim</option>
      <option value="nao" ${ativo.toLowerCase() === "nao" ? "selected" : ""}>N√£o</option>
    </select>`;

  celulas[3].innerHTML = `
    <button class="botao-voltar" onclick="salvarEdicao('${id}', this)">üíæ Salvar</button>
    <button class="botao-salvar" onclick="cancelarEdicao(this)">‚úñ Cancelar</button>
  `;
}

function cancelarEdicao(botao) {
  const linha = botao.closest('tr');
  window.location.reload(); // Simples e eficaz pra restaurar a tabela original
}

function salvarEdicao(id, botao) {
  const linha = botao.closest('tr');
  const inputs = linha.querySelectorAll('td');

  const dados = {
    id,
    regiao_area: inputs[0].querySelector('input').value.trim(),
    desc_area: inputs[1].querySelector('input').value.trim(),
    ativar_area: inputs[2].querySelector('select').value.trim()
  };

  fetch('/area/editar', {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(dados)
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message);
    if (data.success) {
      window.location.reload();
    }
  })
  .catch(err => {
    console.error('Erro ao editar:', err);
    alert('Erro ao editar a √°rea.');
  });
}
</script>

</body>
</html>
