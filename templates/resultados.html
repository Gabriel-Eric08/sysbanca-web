<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Resultados</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .animal-nome {
            color: red;
            font-weight: bold;
        }
    </style>
</head>

<body class="container py-4">
    <h2 class="mb-4">Resultados</h2>

    <div class="mb-3">
        <label class="form-label">Extração</label>
        <select id="extracao_select" class="form-select w-auto d-inline-block me-3">
            {% for extrac in extracoes %}
                <option value="{{ extrac.extracao }}" {% if extracao_selecionada == extrac.extracao %}selected{% endif %}>
                    {{ extrac.extracao }}
                </option>
            {% endfor %}
        </select>
        
        <input type="date" id="data_extracao" class="form-control d-inline-block w-auto me-3" value="{{ data_selecionada or '' }}">
        <button class="btn btn-primary" onclick="buscarEPreencher()">Consultar</button>
    </div>

    <div class="mb-4">
        <div class="mb-2">
            <label>1º Prêmio:</label>
            <input type="text" id="premio1" maxlength="4" class="form-control d-inline-block w-auto premio-input"
                   {% if not pode_salvar %}readonly{% endif %}
                   oninput="gerarAutomaticos()">
            Grupo:
            <input type="text" id="grupo1" maxlength="2" class="form-control d-inline-block w-auto" readonly>
            Bicho:
            <span id="animal1" class="animal-nome"></span>
        </div>
        <div class="mb-2">
            <label>2º Prêmio:</label>
            <input type="text" id="premio2" maxlength="4" class="form-control d-inline-block w-auto premio-input"
                   {% if not pode_salvar %}readonly{% endif %}
                   oninput="gerarAutomaticos()">
            Grupo:
            <input type="text" id="grupo2" maxlength="2" class="form-control d-inline-block w-auto" readonly>
            Bicho:
            <span id="animal2" class="animal-nome"></span>
        </div>
        <div class="mb-2">
            <label>3º Prêmio:</label>
            <input type="text" id="premio3" maxlength="4" class="form-control d-inline-block w-auto premio-input"
                   {% if not pode_salvar %}readonly{% endif %}
                   oninput="gerarAutomaticos()">
            Grupo:
            <input type="text" id="grupo3" maxlength="2" class="form-control d-inline-block w-auto" readonly>
            Bicho:
            <span id="animal3" class="animal-nome"></span>
        </div>
        <div class="mb-2">
            <label>4º Prêmio:</label>
            <input type="text" id="premio4" maxlength="4" class="form-control d-inline-block w-auto premio-input"
                   {% if not pode_salvar %}readonly{% endif %}
                   oninput="gerarAutomaticos()">
            Grupo:
            <input type="text" id="grupo4" maxlength="2" class="form-control d-inline-block w-auto" readonly>
            Bicho:
            <span id="animal4" class="animal-nome"></span>
        </div>
        <div class="mb-2">
            <label>5º Prêmio:</label>
            <input type="text" id="premio5" maxlength="4" class="form-control d-inline-block w-auto premio-input"
                   {% if not pode_salvar %}readonly{% endif %}
                   oninput="gerarAutomaticos()">
            Grupo:
            <input type="text" id="grupo5" maxlength="2" class="form-control d-inline-block w-auto" readonly>
            Bicho:
            <span id="animal5" class="animal-nome"></span>
        </div>

        <div class="mb-2">
            <label>6º Prêmio:</label>
            <input type="text" id="premio6" class="form-control d-inline-block w-auto premio-input" readonly>
            Grupo:
            <input type="text" id="grupo6" maxlength="2" class="form-control d-inline-block w-auto" readonly>
            Bicho:
            <span id="animal6" class="animal-nome"></span>
        </div>
        <div class="mb-2">
            <label>7º Prêmio:</label>
            <input type="text" id="premio7" class="form-control d-inline-block w-auto premio-input" readonly>
            Grupo:
            <input type="text" id="grupo7" maxlength="2" class="form-control d-inline-block w-auto" readonly>
            Bicho:
            <span id="animal7" class="animal-nome"></span>
        </div>
        <div class="mb-2">
            <label>8º Prêmio:</label>
            <input type="text" id="premio8" class="form-control d-inline-block w-auto premio-input" readonly>
            Grupo:
            <input type="text" id="grupo8" maxlength="2" class="form-control d-inline-block w-auto" readonly>
            Bicho:
            <span id="animal8" class="animal-nome"></span>
        </div>
        <div class="mb-2">
            <label>9º Prêmio:</label>
            <input type="text" id="premio9" class="form-control d-inline-block w-auto premio-input" readonly>
            Grupo:
            <input type="text" id="grupo9" maxlength="2" class="form-control d-inline-block w-auto" readonly>
            Bicho:
            <span id="animal9" class="animal-nome"></span>
        </div>
        <div class="mb-2">
            <label>10º Prêmio:</label>
            <input type="text" id="premio10" class="form-control d-inline-block w-auto premio-input" readonly>
            Grupo:
            <input type="text" id="grupo10" maxlength="2" class="form-control d-inline-block w-auto" readonly>
            Bicho:
            <span id="animal10" class="animal-nome"></span>
        </div>
    </div>

    <div class="mb-4">
        <a href="{{ url_for('Home.home') }}" class="btn btn-success">Voltar</a>
        {% if pode_salvar %}
            <button type="button" class="btn btn-secondary me-2" onclick="gerarNumeros()">Gerar números</button> 
            <button class="btn btn-primary" onclick="salvarTabela()">Salvar</button>
        {% endif %}
    </div>

    <script>
        const animais = [
            'AVESTRUZ', 'ÁGUIA', 'BURRO', 'BORBOLETA', 'CACHORRO', 'CABRA',
            'CARNEIRO', 'CAMELO', 'COBRA', 'COELHO', 'CAVALO', 'ELEFANTE',
            'GALO', 'GATO', 'JACARÉ', 'LEÃO', 'MACACO', 'PORCO', 'PAVÃO',
            'PERU', 'TOURO', 'TIGRE', 'URSO', 'VEADO', 'VACA'
        ];

        function gerarGrupoBicho(inputId, grupoId, animalId) {
            const valor = document.getElementById(inputId).value.trim();
            if (/^\d{4}$/.test(valor)) {
                let ultimosDois = valor.slice(2);
                let numero = parseInt(ultimosDois, 10);
                if (numero === 0) numero = 100;
                const grupo = Math.ceil(numero / 4);
                document.getElementById(grupoId).value = String(grupo).padStart(2, '0');
                document.getElementById(animalId).innerText = animais[grupo - 1] || '';
            } else {
                document.getElementById(grupoId).value = '';
                document.getElementById(animalId).innerText = '';
            }
        }

        function gerarAutomaticos() {
            // Atualiza os grupos e bichos dos 5 primeiros prêmios
            for (let idx = 1; idx <= 5; idx++) {
                gerarGrupoBicho(`premio${idx}`, `grupo${idx}`, `animal${idx}`);
            }

            const premios = [
                document.getElementById('premio1').value,
                document.getElementById('premio2').value,
                document.getElementById('premio3').value,
                document.getElementById('premio4').value,
                document.getElementById('premio5').value
            ];

            // Lógica para os prêmios 6 a 9, com preenchimento incremental
            for (let i = 0; i < 4; i++) {
                const premioAuto = document.getElementById(`premio${i + 6}`);
                const premioGrupo = document.getElementById(`grupo${i + 6}`);
                const premioAnimal = document.getElementById(`animal${i + 6}`);
                let novoValor = '';

                if (premios[0].length > i) novoValor += premios[0][i];
                if (premios[1].length > i) novoValor += premios[1][i];
                if (premios[2].length > i) novoValor += premios[2][i];
                if (premios[3].length > i) novoValor += premios[3][i];

                premioAuto.value = novoValor;
                if (novoValor.length === 4) {
                    gerarGrupoBicho(premioAuto.id, premioGrupo.id, premioAnimal.id);
                } else {
                    premioGrupo.value = '';
                    premioAnimal.innerText = '';
                }
            }

            // Lógica para o prêmio 10, que se baseia na soma dos 5 primeiros prêmios
            const premio10 = document.getElementById('premio10');
            const premio10Grupo = document.getElementById('grupo10');
            const premio10Animal = document.getElementById('animal10');
            const todosCompletos = premios.every(p => p.length === 4);

            if (todosCompletos) {
                const soma = premios.reduce((acc, p) => acc + parseInt(p), 0);
                const somaFormatada = String(soma % 10000).padStart(4, '0');
                premio10.value = somaFormatada;
                gerarGrupoBicho(premio10.id, premio10Grupo.id, premio10Animal.id);
            } else {
                premio10.value = '';
                premio10Grupo.value = '';
                premio10Animal.innerText = '';
            }
        }

        function gerarNumeros() {
            for (let idx = 1; idx <= 5; idx++) {
                const numero = String(Math.floor(1000 + Math.random() * 9000));
                document.getElementById(`premio${idx}`).value = numero;
            }
            gerarAutomaticos();
        }

        async function salvarTabela() {
            const extracao = document.getElementById("extracao_select").value;
            const data = document.getElementById("data_extracao").value;

            const premios = [];
            for (let i = 1; i <= 10; i++) {
                premios.push(document.getElementById(`premio${i}`).value.trim());
            }

            if (!extracao || !data || premios.some(p => p.length !== 4)) {
                alert('Por favor, preencha todos os 10 prêmios de 4 dígitos antes de salvar.');
                return;
            }

            try {
                const response = await fetch("{{ url_for('Resultado.salvar') }}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        extracao: extracao,
                        data: data,
                        premios: premios
                    })
                });
                const result = await response.json();
                alert(result.message);
                if (response.ok) {
                    for (let i = 1; i <= 5; i++) {
                        document.getElementById(`premio${i}`).value = '';
                    }
                    gerarAutomaticos();
                }
            } catch (err) {
                console.error("Erro ao salvar:", err);
                alert("Erro ao salvar os dados.");
            }
        }

        async function buscarEPreencher() {
            const extracao = document.getElementById("extracao_select").value;
            const data = document.getElementById("data_extracao").value;

            if (!extracao || !data) {
                alert("Por favor, selecione uma extração e uma data.");
                return;
            }

            try {
                const response = await fetch(`/resultado/consultar_json/${extracao}/${data}/`);
                
                for (let i = 1; i <= 10; i++) {
                    const premioInput = document.getElementById(`premio${i}`);
                    if (premioInput) {
                        premioInput.value = '';
                        if (i <= 5) {
                            premioInput.readOnly = {% if not pode_salvar %}true{% else %}false{% endif %};
                        } else {
                            premioInput.readOnly = true;
                        }
                    }
                    const grupoInput = document.getElementById(`grupo${i}`);
                    if (grupoInput) grupoInput.value = '';
                    const animalSpan = document.getElementById(`animal${i}`);
                    if (animalSpan) animalSpan.innerText = '';
                }

                if (response.status === 404) {
                    alert('Nenhum resultado encontrado para a data e extração selecionadas.');
                    return;
                }

                if (!response.ok) {
                    throw new Error('Erro ao consultar os dados.');
                }

                const premios = await response.json();
                
                for (let i = 1; i <= 10; i++) {
                    const premioKey = `premio_${i}`;
                    if (premios[premioKey]) {
                        document.getElementById(`premio${i}`).value = premios[premioKey];
                        gerarGrupoBicho(`premio${i}`, `grupo${i}`, `animal${i}`);
                    }
                    document.getElementById(`premio${i}`).readOnly = true;
                }
                
                alert('Dados carregados com sucesso!');
            } catch (error) {
                console.error('Erro na requisição:', error);
                alert('Erro ao consultar os dados.');
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const resultado = {{ resultado|tojson|safe if resultado else '{}' }};
            if (Object.keys(resultado).length > 0) {
                for (let i = 1; i <= 10; i++) {
                    const premioKey = `premio_${i}`;
                    const premioValue = resultado[premioKey] || '';
                    document.getElementById(`premio${i}`).value = premioValue;
                    if (premioValue) {
                        gerarGrupoBicho(`premio${i}`, `grupo${i}`, `animal${i}`);
                    }
                    document.getElementById(`premio${i}`).readOnly = true;
                }
            }
        });
    </script>
</body>
</html>