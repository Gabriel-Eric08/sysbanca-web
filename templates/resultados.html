<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Resultados</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .animal-nome {
            color: red;
            font-weight: bold;
        }
    </style>
</head>

<body class="container py-4">
    <h2 class="mb-4">Resultados</h2>

    <div class="mb-3">
        <label class="form-label">Extração</label>
        <select id="extracao_select" class="form-select w-auto d-inline-block me-3">
            {% for extrac in extracoes %}
                <option value="{{ extrac.extracao }}" {% if extracao_selecionada == extrac.extracao %}selected{% endif %}>
                    {{ extrac.extracao }}
                </option>
            {% endfor %}
        </select>
        
        <input type="date" id="data_extracao" class="form-control d-inline-block w-auto me-3" value="{{ data_selecionada or '' }}">
        <button class="btn btn-primary" onclick="buscarEPreencher()">Consultar</button>
    </div>

    <div class="mb-4">
        <div class="mb-2">
            <label>1º Prêmio:</label>
            <input type="text" id="premio1" maxlength="4" class="form-control d-inline-block w-auto premio-input"
                    {% if not pode_salvar %}readonly{% endif %}
                    oninput="gerarAutomaticos(); gerarGrupoBicho(this.id, 'grupo1', 'animal1');">
            Grupo:
            <input type="text" id="grupo1" maxlength="2" class="form-control d-inline-block w-auto" readonly>
            Bicho:
            <span id="animal1" class="animal-nome"></span>
        </div>
        <div class="mb-2">
            <label>2º Prêmio:</label>
            <input type="text" id="premio2" maxlength="4" class="form-control d-inline-block w-auto premio-input"
                    {% if not pode_salvar %}readonly{% endif %}
                    oninput="gerarAutomaticos(); gerarGrupoBicho(this.id, 'grupo2', 'animal2');">
            Grupo:
            <input type="text" id="grupo2" maxlength="2" class="form-control d-inline-block w-auto" readonly>
            Bicho:
            <span id="animal2" class="animal-nome"></span>
        </div>
        <div class="mb-2">
            <label>3º Prêmio:</label>
            <input type="text" id="premio3" maxlength="4" class="form-control d-inline-block w-auto premio-input"
                    {% if not pode_salvar %}readonly{% endif %}
                    oninput="gerarAutomaticos(); gerarGrupoBicho(this.id, 'grupo3', 'animal3');">
            Grupo:
            <input type="text" id="grupo3" maxlength="2" class="form-control d-inline-block w-auto" readonly>
            Bicho:
            <span id="animal3" class="animal-nome"></span>
        </div>
        <div class="mb-2">
            <label>4º Prêmio:</label>
            <input type="text" id="premio4" maxlength="4" class="form-control d-inline-block w-auto premio-input"
                    {% if not pode_salvar %}readonly{% endif %}
                    oninput="gerarAutomaticos(); gerarGrupoBicho(this.id, 'grupo4', 'animal4');">
            Grupo:
            <input type="text" id="grupo4" maxlength="2" class="form-control d-inline-block w-auto" readonly>
            Bicho:
            <span id="animal4" class="animal-nome"></span>
        </div>
        <div class="mb-2">
            <label>5º Prêmio:</label>
            <input type="text" id="premio5" maxlength="4" class="form-control d-inline-block w-auto premio-input"
                    {% if not pode_salvar %}readonly{% endif %}
                    oninput="gerarAutomaticos(); gerarGrupoBicho(this.id, 'grupo5', 'animal5');">
            Grupo:
            <input type="text" id="grupo5" maxlength="2" class="form-control d-inline-block w-auto" readonly>
            Bicho:
            <span id="animal5" class="animal-nome"></span>
        </div>

        <div class="mb-2">
            <label>6º Prêmio:</label>
            <input type="text" id="premio6" maxlength="4" class="form-control d-inline-block w-auto premio-input"
                    oninput="gerarGrupoBicho(this.id, 'grupo6', 'animal6')">
            Grupo:
            <input type="text" id="grupo6" maxlength="2" class="form-control d-inline-block w-auto" readonly>
            Bicho:
            <span id="animal6" class="animal-nome"></span>
        </div>
        <div class="mb-2">
            <label>7º Prêmio:</label>
            <input type="text" id="premio7" maxlength="4" class="form-control d-inline-block w-auto premio-input"
                    oninput="gerarGrupoBicho(this.id, 'grupo7', 'animal7')">
            Grupo:
            <input type="text" id="grupo7" maxlength="2" class="form-control d-inline-block w-auto" readonly>
            Bicho:
            <span id="animal7" class="animal-nome"></span>
        </div>
        <div class="mb-2">
            <label>8º Prêmio:</label>
            <input type="text" id="premio8" maxlength="4" class="form-control d-inline-block w-auto premio-input"
                    oninput="gerarGrupoBicho(this.id, 'grupo8', 'animal8')">
            Grupo:
            <input type="text" id="grupo8" maxlength="2" class="form-control d-inline-block w-auto" readonly>
            Bicho:
            <span id="animal8" class="animal-nome"></span>
        </div>
        <div class="mb-2">
            <label>9º Prêmio:</label>
            <input type="text" id="premio9" maxlength="4" class="form-control d-inline-block w-auto premio-input"
                    oninput="gerarGrupoBicho(this.id, 'grupo9', 'animal9')">
            Grupo:
            <input type="text" id="grupo9" maxlength="2" class="form-control d-inline-block w-auto" readonly>
            Bicho:
            <span id="animal9" class="animal-nome"></span>
        </div>
        <div class="mb-2">
            <label>10º Prêmio:</label>
            <input type="text" id="premio10" maxlength="4" class="form-control d-inline-block w-auto premio-input"
                    oninput="gerarGrupoBicho(this.id, 'grupo10', 'animal10')">
            Grupo:
            <input type="text" id="grupo10" maxlength="2" class="form-control d-inline-block w-auto" readonly>
            Bicho:
            <span id="animal10" class="animal-nome"></span>
        </div>
    </div>

    <div class="mb-4">
        <a href="{{ url_for('Home.home') }}" class="btn btn-success">Voltar</a>
        {% if pode_salvar %}
            <button type="button" class="btn btn-secondary me-2" onclick="gerarNumeros()">Gerar números</button> 
            <button class="btn btn-primary" onclick="salvarTabela()">Salvar</button>
            <button class="btn btn-info" onclick="consultarLucro()">Consultar Lucro</button>
        {% endif %}
    </div>

    <script>
        // Mapeamento de grupos e animais
        const animais = [
            'AVESTRUZ', 'ÁGUIA', 'BURRO', 'BORBOLETA', 'CACHORRO', 'CABRA',
            'CARNEIRO', 'CAMELO', 'COBRA', 'COELHO', 'CAVALO', 'ELEFANTE',
            'GALO', 'GATO', 'JACARÉ', 'LEÃO', 'MACACO', 'PORCO', 'PAVÃO',
            'PERU', 'TOURO', 'TIGRE', 'URSO', 'VEADO', 'VACA'
        ];

        // Função para gerar o grupo e bicho a partir do prêmio
        function gerarGrupoBicho(inputId, grupoId, animalId) {
            const valor = document.getElementById(inputId).value.trim();
            // A propriedade .value de um input de texto sempre retorna uma string
            if (/^\d{4}$/.test(valor)) {
                let ultimosDois = valor.slice(2);
                let numero = parseInt(ultimosDois, 10);
                if (numero === 0) numero = 100;
                const grupo = Math.ceil(numero / 4);
                document.getElementById(grupoId).value = String(grupo).padStart(2, '0');
                document.getElementById(animalId).innerText = animais[grupo - 1] || '';
            } else {
                document.getElementById(grupoId).value = '';
                document.getElementById(animalId).innerText = '';
            }
        }

        // Função para gerar os prêmios automáticos
        function gerarAutomaticos() {
            const premiosManuais = [];
            for (let i = 1; i <= 5; i++) {
                const input = document.getElementById(`premio${i}`);
                premiosManuais.push(input.value.trim());
                gerarGrupoBicho(input.id, `grupo${i}`, `animal${i}`);
            }

            // Gera os prêmios automáticos 6 a 9
            const premiosAutomaticos = [];
            for (let i = 0; i < 4; i++) {
                const digitos = premiosManuais.slice(0, 4).map(p => p[i]).filter(Boolean).join('');
                document.getElementById(`premio${i + 6}`).value = digitos;
                premiosAutomaticos.push(digitos);
                gerarGrupoBicho(`premio${i + 6}`, `grupo${i + 6}`, `animal${i + 6}`);
            }

            // Gera o 10º prêmio
            const todosPremiosParaSoma = premiosManuais.filter(Boolean).concat(premiosAutomaticos.filter(Boolean));
            if (todosPremiosParaSoma.length > 0) {
                // Ao usar parseInt, os valores string são convertidos para números para o cálculo
                const soma = todosPremiosParaSoma.reduce((acc, p) => acc + parseInt(p), 0);
                const somaFormatada = String(soma % 10000).padStart(4, '0');
                // O resultado da soma é convertido de volta para string antes de ser atribuído ao input
                document.getElementById('premio10').value = somaFormatada;
                gerarGrupoBicho('premio10', 'grupo10', 'animal10');
            } else {
                // Limpa o 10º prêmio se não houver dados
                document.getElementById('premio10').value = '';
                document.getElementById('grupo10').value = '';
                document.getElementById('animal10').innerText = '';
            }
        }
        
        // Gera números aleatórios para os primeiros 5 prêmios
        function gerarNumeros() {
            for (let idx = 1; idx <= 5; idx++) {
                const numero = String(Math.floor(1000 + Math.random() * 9000));
                document.getElementById(`premio${idx}`).value = numero;
            }
            gerarAutomaticos();
        }

        // Função para salvar a tabela, enviando os dados como strings
        async function salvarTabela() {
            const extracao = document.getElementById("extracao_select").value;
            const data = document.getElementById("data_extracao").value;

            // Coleta os valores dos inputs. A propriedade .value já retorna uma string.
            const premios = [];
            for (let i = 1; i <= 10; i++) {
                premios.push(document.getElementById(`premio${i}`).value.trim());
            }

            if (!extracao || !data || premios.some(p => p.length !== 4)) {
                // Substituindo o alert nativo por uma função customizada para aprimorar a UX
                showCustomAlert('Por favor, preencha todos os 10 prêmios de 4 dígitos antes de salvar.');
                return;
            }

            try {
                const response = await fetch("{{ url_for('Resultado.salvar') }}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        extracao: extracao,
                        data: data,
                        // O array de prêmios já contém strings, e JSON.stringify() os mantém como strings.
                        premios: premios
                    })
                });
                const result = await response.json();
                showCustomAlert(result.message);
                if (response.ok) {
                    for (let i = 1; i <= 5; i++) {
                        document.getElementById(`premio${i}`).value = '';
                    }
                    gerarAutomaticos();
                }
            } catch (err) {
                console.error("Erro ao salvar:", err);
                showCustomAlert("Erro ao salvar os dados.");
            }
        }

        // Função para buscar e preencher os dados
        async function buscarEPreencher() {
            const extracao = document.getElementById("extracao_select").value;
            const data = document.getElementById("data_extracao").value;
            const pode_salvar = "{{ pode_salvar }}" === 'True';

            if (!extracao || !data) {
                showCustomAlert("Por favor, selecione uma extração e uma data.");
                return;
            }

            try {
                const response = await fetch(`/resultado/consultar_json/${extracao}/${data}/`);
                
                // Limpa todos os campos
                for (let i = 1; i <= 10; i++) {
                    document.getElementById(`premio${i}`).value = '';
                    document.getElementById(`grupo${i}`).value = '';
                    document.getElementById(`animal${i}`).innerText = '';
                }

                if (response.status === 404) {
                    showCustomAlert('Nenhum resultado encontrado para a data e extração selecionadas. Os campos estão liberados para preenchimento.');
                    if (pode_salvar) {
                        for (let i = 1; i <= 10; i++) {
                            document.getElementById(`premio${i}`).readOnly = false;
                        }
                    }
                    return;
                }

                if (!response.ok) {
                    throw new Error('Erro ao consultar os dados.');
                }

                const premios = await response.json();
                
                for (let i = 1; i <= 10; i++) {
                    const premioKey = `premio_${i}`;
                    const premioInput = document.getElementById(`premio${i}`);
                    
                    if (premios[premioKey]) {
                        const valorFormatado = String(premios[premioKey]).padStart(4, '0');
                        premioInput.value = valorFormatado;
                        gerarGrupoBicho(premioInput.id, `grupo${i}`, `animal${i}`);
                    }
                    premioInput.readOnly = true;
                }
                
                showCustomAlert('Dados carregados com sucesso!');
            } catch (error) {
                console.error('Erro na requisição:', error);
                showCustomAlert('Erro ao consultar os dados.');
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const resultado = {{ resultado|tojson|safe if resultado else '{}' }};
            const pode_salvar = "{{ pode_salvar }}" === 'True';

            if (Object.keys(resultado).length > 0) {
                for (let i = 1; i <= 10; i++) {
                    const premioKey = `premio_${i}`;
                    const premioValue = resultado[premioKey] || '';
                    const premioInput = document.getElementById(`premio${i}`);
                    premioInput.value = premioValue;
                    if (premioValue) {
                        gerarGrupoBicho(premioInput.id, `grupo${i}`, `animal${i}`);
                    }
                    premioInput.readOnly = true;
                }
            } else if (pode_salvar) {
                for (let i = 1; i <= 10; i++) {
                    document.getElementById(`premio${i}`).readOnly = false;
                }
            } else {
                for (let i = 1; i <= 10; i++) {
                    document.getElementById(`premio${i}`).readOnly = true;
                }
            }
        });

        async function consultarLucro() {
            const extracao = document.getElementById("extracao_select").value;
            const data = document.getElementById("data_extracao").value;

            const premios = [];
            for (let i = 1; i <= 10; i++) {
                premios.push(document.getElementById(`premio${i}`).value.trim());
            }

            if (!extracao || !data || premios.some(p => p.length !== 4)) {
                showCustomAlert('Por favor, preencha a extração, data e todos os 10 prêmios para consultar.');
                return;
            }

            try {
                const response = await fetch("{{ url_for('Resultado.consultar_lucro') }}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        extracao: extracao,
                        data: data,
                        premios: premios
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showCustomAlert(`
Relatório de Lucro:
Total de Apostas: R$ ${result.total_apostas.toFixed(2)}
Total de Prêmios: R$ ${result.total_premios.toFixed(2)}
Lucro: R$ ${result.lucro.toFixed(2)}
Porcentagem de Lucro: ${result.porcentagem_lucro.toFixed(2)}%
                    `);
                } else {
                    showCustomAlert(`Erro: ${result.message}`);
                }
            } catch (err) {
                console.error("Erro ao consultar lucro:", err);
                showCustomAlert("Erro ao consultar o lucro. Verifique a conexão ou os dados.");
            }
        }
        // Custom modal implementation to replace alert()
        function showCustomAlert(message) {
          const modalId = 'customAlertModal';
          let modalElement = document.getElementById(modalId);
          if (!modalElement) {
            modalElement = document.createElement('div');
            modalElement.id = modalId;
            modalElement.className = 'modal fade';
            modalElement.setAttribute('tabindex', '-1');
            modalElement.innerHTML = `
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Aviso</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body" id="customAlertMessage"></div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                  </div>
                </div>
              </div>
            `;
            document.body.appendChild(modalElement);
          }
          document.getElementById('customAlertMessage').innerText = message;
          const bootstrapModal = new bootstrap.Modal(modalElement);
          bootstrapModal.show();
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>