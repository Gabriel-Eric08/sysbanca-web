<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tela de Apostas - Sysbanca</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #070707, #161d16, #00a000);
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      gap: 30px;
    }

    .container {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
      width: 600px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: transform 0.3s ease;
    }

    .container:hover {
      transform: translateY(-5px);
    }

    .bilhete-container {
      position: relative;
      width: 400px;
    }

    .bilhete {
      background: linear-gradient(135deg, #000000, #1a1a1a, #2d2d2d);
      color: #fff;
      padding: 15px;
      border-radius: 12px;
      width: 100%;
      font-family: 'Helvetica', 'Arial', sans-serif;
      font-weight: bold;
      font-size: 15px;
      line-height: 1.5;
      white-space: pre-line;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      min-height: 400px;
      display: flex;
      align-items: center;
      border: 1px solid #444;
      overflow: auto;
      transition: all 0.3s ease;
    }

    h2 {
      text-align: center;
      margin-bottom: 15px;
      font-size: 30px;
      color: #fff;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
    }

    .numero-poule {
      text-align: center;
      margin-bottom: 20px;
      font-size: 18px;
      font-weight: bold;
      color: #ffcc00;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }

    .form-group {
      margin-bottom: 22.5px;
      position: relative;
    }

    label {
      display: block;
      margin-top: 18px;
      font-weight: bold;
      font-size: 18px;
      color: #fff;
    }

    input, select, textarea {
      width: 100%;
      padding: 15px;
      margin-top: 7.5px;
      border: none;
      border-radius: 12px;
      outline: none;
      font-size: 18px;
      background: rgba(255, 255, 255, 0.9);
      transition: all 0.3s ease;
    }

    input:focus, select:focus, textarea:focus {
      box-shadow: 0 0 0 3px rgba(255, 204, 0, 0.5);
    }

    textarea {
      resize: none;
      height: 105px;
      font-family: 'Courier New', monospace;
    }

    #total {
      background: #222;
      color: #0f0;
      font-weight: bold;
      font-size: 21px;
      text-align: center;
      padding: 15px;
    }

    .button-group {
      display: flex;
      gap: 15px;
      margin-top: 30px;
    }

    button {
      flex: 1;
      padding: 15px;
      color: white;
      border: none;
      border-radius: 15px;
      font-size: 21px;
      cursor: pointer;
      transition: 0.3s;
      font-weight: bold;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
    }

    #btnConfirmar {
      background: #ffcc00;
      color: #000;
    }

    #btnConfirmar:hover {
      background: #e6b800;
      transform: translateY(-2px);
    }

    #btnPdf {
      display: none;
      background: #ff3333;
    }

    #btnPdf:hover {
      background: #cc0000;
      transform: translateY(-2px);
    }

    #btnLimpar {
      background: #666;
    }

    #btnLimpar:hover {
      background: #555;
      transform: translateY(-2px);
    }

    .valor-info {
      font-size: 15px;
      color: #ddd;
      margin-top: 4.5px;
    }

    .operacao-group {
      display: flex;
      gap: 15px;
      margin-top: 15px;
    }

    .operacao-btn {
      flex: 1;
      padding: 12px;
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      color: white;
      cursor: pointer;
      text-align: center;
      font-size: 15px;
      transition: all 0.3s ease;
    }

    .operacao-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .operacao-btn.active {
      background: #00c6ff;
      font-weight: bold;
    }

    .aposta-info {
      font-size: 14px;
      color: #ffcc00;
      margin-top: 5px;
      font-weight: bold;
    }

    .aposta-error {
      font-size: 14px;
      color: #ff6666;
      margin-top: 5px;
      font-weight: bold;
    }

    .aposta-success {
      font-size: 14px;
      color: #66ff66;
      margin-top: 5px;
      font-weight: bold;
    }

    .input-hint {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 3px 8px;
      border-radius: 5px;
      font-size: 12px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    input:focus + .input-hint {
      opacity: 1;
    }

    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .toast.show {
      opacity: 1;
    }

    .switch-container {
      display: flex;
      align-items: center;
      margin-top: 15px;
      gap: 10px;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 30px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 4px;
      background-color: #ccc;
      transition: .4s;
      border-radius: 30px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: #2196F3;
    }

    input:checked + .slider:before {
      transform: translateX(30px);
    }

    @media print {
      body * {
        visibility: hidden;
      }
      .bilhete, .bilhete * {
        visibility: visible;
        font-family: 'Helvetica', 'Arial', sans-serif !important;
        font-weight: bold !important;
        color: #000 !important;
        background: #fff !important;
      }
      .bilhete {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        box-shadow: none;
        border: none;
        font-size: 12px;
        padding: 10px;
        min-height: auto;
        height: auto !important;
      }
    }

    @media (max-width: 1300px) {
      body {
        flex-direction: column;
        align-items: center;
      }
      
      .container, .bilhete-container {
        width: 90%;
        max-width: 600px;
      }
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
        gap: 20px;
      }
      
      .container {
        padding: 20px;
      }
      
      h2 {
        font-size: 24px;
      }
      
      input, select, textarea {
        padding: 12px;
        font-size: 16px;
      }
      
      button {
        font-size: 18px;
        padding: 12px;
      }
      
      .button-group {
        flex-direction: column;
      }
    }

    .shake {
      animation: shake 0.5s;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    .fade-in {
      animation: fadeIn 0.5s;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modalidade-info {
      background: rgba(255, 255, 255, 0.1);
      padding: 10px;
      border-radius: 8px;
      margin-top: 5px;
      font-size: 14px;
      display: none;
    }

    .bilhete-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .bilhete-actions {
      display: flex;
      gap: 10px;
    }

    .bilhete-action-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 5px;
      color: white;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 12px;
    }

    .bilhete-action-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .valor-sugerido {
      display: flex;
      gap: 5px;
      margin-top: 5px;
      flex-wrap: wrap;
    }

    .valor-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 5px;
      color: white;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 12px;
    }

    .valor-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .valor-btn.active {
      background: #ffcc00;
      color: #000;
    }

    .historico-apostas {
      position: absolute;
      background: white;
      color: #000;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      padding: 0px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      display: none;
    }

    .historico-item {
      padding: 5px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    .historico-item:hover {
      background: #f0f0f0;
    }

    .premiacao-info {
      font-size: 12px;
      color: #ddd;
      margin-top: 5px;
    }

    .currency-input {
      text-align: right;
      direction: rtl;
    }
    
    .aposta-formatada {
      letter-spacing: 0.5px;
      font-family: 'Courier New', monospace;
    }
    
    .switch-group {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 15px;
    }
    
    .switch-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .date-picker-container {
      margin-top: 10px;
      display: none;
    }
    
    .date-picker {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: none;
      background: rgba(255, 255, 255, 0.9);
      color: #000;
      font-size: 16px;
    }

    /* Estilo para o cursor personalizado */
    .cursor-helper {
      position: absolute;
      width: 2px;
      height: 20px;
      background-color: #ffcc00;
      animation: blink 1s infinite;
      display: none;
      z-index: 10;
    }
    
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>🎲 Apostas Sysbanca</h2>
    <div class="numero-poule" id="numeroPoule1">Poule: {{ poule }}</div>

    <div class="form-group">
      <label for="extracao">Escolha a Extração</label>
      <select id="extracao">
        {% for extracao in extracoes %}
        <option value="{{ extracao.extracao }}">{{ extracao.extracao }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="form-group">
      <label for="modalidade">Escolha a Modalidade</label>
      <select id="modalidade" onchange="atualizarValidacaoAposta()">
        {% for modalidade in modalidades %}
        <option value="{{ modalidade.modalidade }}">{{ modalidade.modalidade }}</option>
        {% endfor %}
      </select>
      <div id="modalidadeInfo" class="modalidade-info"></div>
    </div>

    <div class="form-group">
      <label for="aposta">Digite a(s) Aposta(s)</label>
      <div style="position: relative;">
        <textarea id="aposta" class="aposta-formatada" placeholder="Ex: 1234 5678 9012 (separadas por espaço)" oninput="formatarAposta()" onkeydown="limitarCaracteres(event)" onpaste="handlePaste(event)" onfocus="mostrarCursorHelper()" onblur="esconderCursorHelper()" onkeyup="atualizarCursorHelper()" onclick="atualizarCursorHelper()"></textarea>
        <div id="cursorHelper" class="cursor-helper"></div>
      </div>
      <div id="aposta-info" class="aposta-info"></div>
      <div id="apostaError" class="aposta-error"></div>
      <div id="apostaSuccess" class="aposta-success"></div>
      
      <div class="switch-group">
        <div class="switch-item">
          <label class="switch">
            <input type="checkbox" id="repetirAposta">
            <span class="slider"></span>
          </label>
          <span>Repetir aposta com outra premiação</span>
        </div>
        
        <div class="switch-item">
          <label class="switch">
            <input type="checkbox" id="apostaPredatada" onchange="toggleDatePicker()">
            <span class="slider"></span>
          </label>
          <span>Aposta Pré-datada</span>
        </div>
      </div>
      
      <div class="date-picker-container" id="datePickerContainer">
        <label for="dataAposta">Data da Aposta:</label>
        <input type="date" id="dataAposta" class="date-picker" onchange="hideDatePicker()">
      </div>
    </div>

    <div class="form-group">
      <label for="premiacao">Premiação</label>
      <select id="premiacao" onchange="calcularTotal()">
        <option value="1P">1P</option>
        <option value="1/2P">1/2p</option>
        <option value="1/3P">1/3P</option>
        <option value="1/4P">1/4P</option>
        <option value="1/5P">1/5P</option>
        <option value="1/6P">1/6P</option>
        <option value="1/7P">1/7P</option>
        <option value="1/8P">1/8P</option>
        <option value="1/9P">1/9P</option>
        <option value="1/10P">1/10P</option>
        <option value="6/10P">6/10P</option>
        <option value="1P e 1/5P">1P e 1/5P</option>
        <option value="1P e 1/10P">1P e 1/10P</option>
      </select>
      <div class="premiacao-info" id="premiacaoInfo"></div>
    </div>

    <div class="form-group">
      <label for="valor">Valor Unitário (R$)</label>
      <input type="text" id="valor" class="currency-input" placeholder="0,00" oninput="formatarMoeda(this); calcularTotal()">
      <span class="input-hint">0,00</span>
           
      <div class="valor-sugerido">
        <button class="valor-btn" onclick="definirValor(1)">R$ 1,00</button>
        <button class="valor-btn" onclick="definirValor(2)">R$ 2,00</button>
        <button class="valor-btn" onclick="definirValor(5)">R$ 5,00</button>
        <button class="valor-btn" onclick="definirValor(10)">R$ 10,00</button>
      </div>
      
      <div class="operacao-group">
        <div class="operacao-btn active" id="btnMultiplicar" onclick="toggleOperacao('multiplicar')">Multiplicar</div>
        <div class="operacao-btn" id="btnDividir" onclick="toggleOperacao('dividir')">Dividir</div>
      </div>
    </div>

    <div class="form-group">
        <label for="quantidade">Quantidade de Jogos</label>
        <input type="number" id="quantidade" readonly>
    </div>

    <div class="form-group">
      <label for="total">Valor Total</label>
      <input type="text" id="total" readonly>
    </div>

    <div class="button-group">
      <button id="btnConfirmar" onclick="exibirResultado()">
        <span class="icon">✓</span> Confirmar Aposta
      </button>
      <button id="btnPdf" onclick="imprimirPDF()">
        <span class="icon">📄</span> Imprimir PDF
      </button>
      <button id="btnLimpar" onclick="limparFormulario()">
        <span class="icon">🗑️</span> Limpar
      </button>
    </div>
  </div>

  <div class="bilhete-container">
    <div class="bilhete-header">
      <h3>Bilhete de Aposta</h3>
      <div class="bilhete-actions">
        <button class="bilhete-action-btn" onclick="copiarBilhete()">Copiar</button>
        <button class="bilhete-action-btn" onclick="limparBilhete()">Limpar</button>
      </div>
    </div>
    <div class="bilhete" id="bilhete">Seu bilhete aparecerá aqui após confirmar a aposta.</div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    let operacao = 'multiplicar';
    let numeroBilhete = 1;
    let modalidadeAtual = 'Milhar';
    let maxCaracteres = 4;
    let todasApostas = [];
    let bilheteCompleto = "";
    let valorTotalBilhete = 0;
    let milharBrinde = "";
    let ultimaAposta = null;
    let repetindoAposta = false;
    let apostasComMilharBrinde = [];
    let historicoApostas = [];
    let primeiraAposta = true;
    let formatoDuqueTerno = false;
    let apostaPredatada = false;
    let dataApostaSelecionada = "";
    let numeroPoule = Math.random().toString().substring(2, 10);
    let ultimoCursorPos = 0;
    
    document.getElementById('numeroPoule').innerText = `Poule: ${numeroPoule}`;
    
    const tabelaCombinacoes = {
      "123": [3, 6, 0, 6],
      "112": [3, 3, 0, 3],
      "1234": [4, 24, 24, 48],
      "1123": [4, 12, 12, 24],
      "1122": [4, 6, 6, 12],
      "1112": [4, 4, 4, 8],
      "12345": [5, 60, 120, 180],
      "11234": [5, 33, 60, 93],
      "11223": [5, 18, 30, 48],
      "11123": [5, 13, 20, 33],
      "11122": [5, 8, 10, 18],
      "123456": [6, 120, 360, 480],
      "112345": [6, 72, 192, 264],
      "112234": [6, 42, 102, 144],
      "112233": [6, 24, 54, 78],
      "111234": [6, 34, 72, 106],
      "111223": [6, 19, 38, 57],
      "111222": [6, 8, 14, 22],
      "1234567": [7, 210, 840, 1050],
      "1123456": [7, 135, 480, 615],
      "1122345": [7, 90, 270, 360],
      "1122334": [7, 51, 150, 201],
      "1112345": [7, 73, 208, 281],
      "1122344": [7, 43, 114, 157],
      "1112233": [7, 25, 70, 95],
      "1112232": [7, 20, 46, 66],
      "11112": [5, 0, 5, 5],
      "111123": [6, 0, 21, 21],
      "111122": [6, 0, 11, 11],
      "1112222": [7, 0, 15, 15]
    };
    
    const tabelaCombinacoesTernos = {
      3: 1,
      4: 4,
      5: 10,
      6: 20,
      7: 35,
      8: 56,
      9: 84,
      10: 120
    };

    const tabelaCombinacoesDuques = {
      2: 1,
      3: 3,
      4: 6,
      5: 10,
      6: 15,
      7: 21,
      8: 28,
      9: 36,
      10: 45
    };
    
    const infoModalidades = {
      "Milhar": "Aposta em 4 dígitos. Ex: 1234",
      "Centena": "Aposta em 3 dígitos. Ex: 123",
      "Dezena": "Aposta em 2 dígitos. Ex: 12",
      "Grupo": "Aposta em 2 dígitos representando um grupo (01-25). Ex: 12",
      "Milhar Invertida": "Aposta em 3 a 7 dígitos que gera combinações de milhar. Ex: 1234",
      "Centena Invertida": "Aposta em 3 a 7 dígitos que gera combinações de centena. Ex: 123",
      "Milhar e Centena Invertida": "Aposta em 3 a 7 dígitos que gera combinações de milhar e centena. Ex: 1234",
      "Milhar e Centena": "Aposta em 4 dígitos que vale para milhar e centena (cada aposta conta como 2 jogos). Ex: 1234",
      "Dezena Combinada Cercada": "Dezenas combinadas e cercadas. Ex: 12, 34",
      "Duque de Dezena": "Par de dezenas. Ex: 12 x 34 (cada 2 dezenas = 1 aposta em 1/5P ou 6/10P)",
      "Duque de Dezena Combinado": "Pares de dezenas combinados. Ex: 12 x 34, 56 x 78",
      "Terno de Dezena": "Trio de dezenas. Ex: 12 x 34 x 56 (cada 3 dezenas = 1 aposta em 1/5P ou 6/10P)",
      "Terno de Dezena Combinado": "Trios de dezenas combinados. Ex: 12 x 34 x 56",
      "Terno de Dezena Cercado": "Trios de dezenas cercados. Ex: 12 x 34 x 56",
      "Grupo Combinado": "Combinação de grupos (01-25). Ex: 12, 34",
      "Grupo Combinado Cercado": "Grupos combinados e cercados. Ex: 12, 34",
      "Duque de Grupo": "Par de grupos (01-25). Ex: 12 x 34",
      "Terno de Grupo": "Trio de grupos (01-25). Ex: 12 x 34 x 56",
      "Terno de Grupo Combinado": "Trios de grupos combinados. Ex: 12 x 34 x 56",
      "Terno de Grupo Cercado": "Trios de grupos cercados. Ex: 12 x 34 x 56",
      "Passe Vai": "Aposta em 2 dígitos para passe vai. Ex: 12",
      "Passe Vai e Vem": "Aposta em 2 dígitos para passe vai e vem. Ex: 12"
    };
    
    const infoPremiacoes = {
      "1P": "Prêmio integral - 1 vez o valor",
      "1/2P": "Meio prêmio - 2 vezes o valor",
      "1/3P": "Terço do prêmio - 3 vezes o valor",
      "1/4P": "Quarto do prêmio - 4 vezes o valor",
      "1/5P": "Quinto do prêmio - 5 vezes o valor (para duques: cada 2 dezenas = 1 aposta, para ternos: cada 3 dezenas = 1 aposta)",
      "1/6P": "Sexto do prêmio - 6 vezes o valor",
      "1/7P": "Sétimo do prêmio - 7 vezes o valor",
      "1/8P": "Oitavo do prêmio - 8 vezes o valor",
      "1/9P": "Nono do prêmio - 9 vezes o valor",
      "1/10P": "Décimo do prêmio - 10 vezes o valor",
      "6/10P": "Seis décimos do prêmio - valor especial (para duques: cada 2 dezenas = 1 aposta, para ternos: cada 3 dezenas = 1 aposta)",
      "1P e 1/5P": "Prêmio integral mais quinto do prêmio",
      "1P e 1/10P": "Prêmio integral mais décimo do prêmio"
    };
    
    function formatarMoeda(input) {
      let value = input.value.replace(/\D/g, '');
      value = value.padStart(3, '0');
      const formattedValue = (parseInt(value) / 100).toLocaleString('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
      input.value = formattedValue;
      setTimeout(() => {
        input.selectionStart = input.selectionEnd = input.value.length;
      }, 0);
    }
    
    function gerarMilharBrinde() {
      return Math.floor(Math.random() * 10000).toString().padStart(4, '0');
    }
    
    function identificarPadraoAposta(aposta) {
      const digitos = aposta.split('');
      let contador = {};
      let padrao = '';
      
      for (let i = 0; i < digitos.length; i++) {
        const digito = digitos[i];
        if (!contador[digito]) {
          contador[digito] = Object.keys(contador).length + 1;
        }
        padrao += contador[digito];
      }
      return padrao;
    }
    
    function calcularCombinacoesPorPadrao(aposta, modalidade) {
      const padrao = identificarPadraoAposta(aposta);
      
      if (tabelaCombinacoes.hasOwnProperty(padrao)) {
        const [digitos, centenas, milhares, total] = tabelaCombinacoes[padrao];
        
        if (modalidade === "Milhar Invertida") {
          return milhares;
        } else if (modalidade === "Centena Invertida") {
          return centenas;
        } else if (modalidade === "Milhar e Centena Invertida") {
          return total;
        }
      }
      
      return aposta.length;
    }
    
    function calcularCombinacoesDuqueTerno(apostas, modalidade) {
      let numerosApenas = apostas.replace(/\s/g, '').replace(/x/gi, '');
      
      let dezenas = [];
      for (let i = 0; i < numerosApenas.length; i += 2) {
        if (i + 2 <= numerosApenas.length) {
          dezenas.push(numerosApenas.substring(i, i + 2));
        }
      }
      
      let numerosUnicos = [...new Set(dezenas)];
      const quantidadeNumeros = numerosUnicos.length;
      
      if (modalidade.includes('Duque')) {
        return tabelaCombinacoesDuques[quantidadeNumeros] || 0;
      } else if (modalidade.includes('Terno')) {
        return tabelaCombinacoesTernos[quantidadeNumeros] || 0;
      }
      
      return 0;
    }
    
    // Função completamente reformulada para corrigir o problema do cursor
    function formatarAposta() {
      const apostaInput = document.getElementById('aposta');
      const cursorPosition = apostaInput.selectionStart;
      let texto = apostaInput.value;
      
      // Salva a posição do cursor antes de qualquer formatação
      ultimoCursorPos = cursorPosition;
      
      // Remove todos os caracteres não numéricos
      let textoLimpo = texto.replace(/\D/g, '');
      
      let textoFormatado = '';
      
      if (formatoDuqueTerno) {
        if (modalidadeAtual.includes('Duque')) {
          for (let i = 0; i < textoLimpo.length; i += 4) {
            if (i > 0) textoFormatado += ' ';
            if (i + 4 <= textoLimpo.length) {
              textoFormatado += textoLimpo.substring(i, i + 4);
            } else {
              textoFormatado += textoLimpo.substring(i);
            }
          }
        } else if (modalidadeAtual.includes('Terno')) {
          for (let i = 0; i < textoLimpo.length; i += 6) {
            if (i > 0) textoFormatado += ' ';
            if (i + 6 <= textoLimpo.length) {
              textoFormatado += textoLimpo.substring(i, i + 6);
            } else {
              textoFormatado += textoLimpo.substring(i);
            }
          }
        }
      } else {
        const modalidadesCombinadas = ["Dezena Combinada Cercada", "Grupo Combinado", "Grupo Combinado Cercado"];
        
        if (modalidadesCombinadas.includes(modalidadeAtual)) {
          for (let i = 0; i < textoLimpo.length; i += 2) {
            if (i > 0) textoFormatado += ' ';
            if (i + 2 <= textoLimpo.length) {
              textoFormatado += textoLimpo.substring(i, i + 2);
            } else {
              textoFormatado += textoLimpo.substring(i);
            }
          }
        } else {
          for (let i = 0; i < textoLimpo.length; i += maxCaracteres) {
            if (i > 0) textoFormatado += ' ';
            if (i + maxCaracteres <= textoLimpo.length) {
              textoFormatado += textoLimpo.substring(i, i + maxCaracteres);
            } else {
              textoFormatado += textoLimpo.substring(i);
            }
          }
        }
      }
      
      // Atualiza o valor do textarea
      apostaInput.value = textoFormatado;
      
      // Calcula a nova posição do cursor
      let novaPosicao = calcularNovaPosicaoCursor(texto, textoFormatado, cursorPosition);
      
      // Define a nova posição do cursor
      apostaInput.selectionStart = apostaInput.selectionEnd = novaPosicao;
      
      // Atualiza o cursor helper
      atualizarCursorHelper();
      
      validarAposta();
    }
    
    // Função auxiliar para calcular a nova posição do cursor
    function calcularNovaPosicaoCursor(textoAntigo, textoNovo, posicaoAntiga) {
      // Se o texto está vazio, cursor no início
      if (!textoAntigo && !textoNovo) return 0;
      
      // Conta quantos dígitos existiam antes do cursor na versão antiga
      const textoAteCursor = textoAntigo.substring(0, posicaoAntiga);
      const digitosAteCursor = textoAteCursor.replace(/\D/g, '').length;
      
      // Encontra a posição no novo texto que corresponde ao mesmo número de dígitos
      let digitosEncontrados = 0;
      for (let i = 0; i < textoNovo.length; i++) {
        if (digitosEncontrados >= digitosAteCursor) {
          return i;
        }
        if (textoNovo[i].match(/\d/)) {
          digitosEncontrados++;
        }
      }
      
      // Se chegou ao final, retorna o final do texto
      return textoNovo.length;
    }
    
    function handlePaste(event) {
      event.preventDefault();
      const texto = (event.clipboardData || window.clipboardData).getData('text');
      const apostaInput = document.getElementById('aposta');
      
      const inicio = apostaInput.selectionStart;
      const fim = apostaInput.selectionEnd;
      const textoAtual = apostaInput.value;
      
      // Insere apenas os dígitos do texto colado
      const textoColadoLimpo = texto.replace(/\D/g, '');
      apostaInput.value = textoAtual.substring(0, inicio) + textoColadoLimpo + textoAtual.substring(fim);
      
      // Reposiciona o cursor
      apostaInput.selectionStart = apostaInput.selectionEnd = inicio + textoColadoLimpo.length;
      
      formatarAposta();
    }
    
    // Funções para gerenciar o cursor helper personalizado
    function mostrarCursorHelper() {
      const cursorHelper = document.getElementById('cursorHelper');
      cursorHelper.style.display = 'block';
      atualizarCursorHelper();
    }
    
    function esconderCursorHelper() {
      const cursorHelper = document.getElementById('cursorHelper');
      cursorHelper.style.display = 'none';
    }
    
    function atualizarCursorHelper() {
      const apostaInput = document.getElementById('aposta');
      const cursorHelper = document.getElementById('cursorHelper');
      
      // Obtém a posição do cursor
      const cursorPosition = apostaInput.selectionStart;
      
      // Obtém as coordenadas do cursor
      const coordinates = getCursorCoordinates(apostaInput, cursorPosition);
      
      if (coordinates) {
        cursorHelper.style.left = coordinates.x + 'px';
        cursorHelper.style.top = coordinates.y + 'px';
        cursorHelper.style.height = coordinates.height + 'px';
      }
    }
    
    // Função para obter as coordenadas do cursor
    function getCursorCoordinates(input, pos) {
      // Cria um elemento temporário para medir a posição
      const tempDiv = document.createElement('div');
      const style = getComputedStyle(input);
      
      // Aplica o mesmo estilo do textarea
      tempDiv.style.font = style.font;
      tempDiv.style.padding = style.padding;
      tempDiv.style.width = input.offsetWidth + 'px';
      tempDiv.style.whiteSpace = 'pre-wrap';
      tempDiv.style.wordWrap = 'break-word';
      tempDiv.style.visibility = 'hidden';
      tempDiv.style.position = 'absolute';
      tempDiv.style.top = '0';
      tempDiv.style.left = '0';
      
      // Insere o texto até a posição do cursor
      const text = input.value.substring(0, pos);
      tempDiv.textContent = text;
      
      // Adiciona ao DOM para calcular as dimensões
      document.body.appendChild(tempDiv);
      
      // Obtém as coordenadas
      const range = document.createRange();
      const selection = window.getSelection();
      range.selectNodeContents(tempDiv);
      range.collapse(false);
      selection.removeAllRanges();
      selection.addRange(range);
      
      const rect = range.getBoundingClientRect();
      const inputRect = input.getBoundingClientRect();
      
      // Remove o elemento temporário
      document.body.removeChild(tempDiv);
      
      if (rect) {
        return {
          x: rect.left - inputRect.left + input.scrollLeft,
          y: rect.top - inputRect.top + input.scrollTop,
          height: rect.height
        };
      }
      
      return null;
    }
    
    function atualizarValidacaoAposta() {
      modalidadeAtual = document.getElementById('modalidade').value;
      
      document.getElementById('modalidadeInfo').innerText = infoModalidades[modalidadeAtual] || "";
      document.getElementById('modalidadeInfo').style.display = infoModalidades[modalidadeAtual] ? "block" : "none";
      
      const modalidadesInvertidas = ["Milhar Invertida", "Centena Invertida", "Milhar e Centena Invertida"];
      const modalidadesCombinadas = ["Dezena Combinada Cercada", "Grupo Combinado", "Grupo Combinado Cercado"];
      const modalidadesDuqueTerno = ["Duque de Dezena", "Duque de Dezena Combinado", "Terno de Dezena", 
                                   "Terno de Dezena Combinado", "Terno de Dezena Cercado", "Duque de Grupo", 
                                   "Terno de Grupo", "Terno de Grupo Combinado", "Terno de Grupo Cercado"];

      if (modalidadesCombinadas.includes(modalidadeAtual)) {
        maxCaracteres = 10;
        formatoDuqueTerno = false;
      } 
      else if (modalidadesInvertidas.includes(modalidadeAtual)) {
        maxCaracteres = 7;
        formatoDuqueTerno = false;
      } 
      else if (modalidadesDuqueTerno.includes(modalidadeAtual)) {
        maxCaracteres = 100;
        formatoDuqueTerno = true;
      }
      else {
        switch(modalidadeAtual) {
          case 'Milhar':
          case 'Milhar e Centena':
            maxCaracteres = 4;
            formatoDuqueTerno = false;
            break;
          case 'Centena':
            maxCaracteres = 3;
            formatoDuqueTerno = false;
            break;
          case 'Dezena':
          case 'Grupo':
          case 'Passe Vai':
          case 'Passe Vai e Vem':
            maxCaracteres = 2;
            formatoDuqueTerno = false;
            break;
        }
      }
      
      const premiacaoSelect = document.getElementById('premiacao');
      if (modalidadeAtual.includes('Duque') || modalidadeAtual.includes('Terno')) {
        for (let i = 0; i < premiacaoSelect.options.length; i++) {
          const option = premiacaoSelect.options[i];
          if (option.value === '1/5P' || option.value === '6/10P') {
            option.style.display = '';
          } else {
            option.style.display = 'none';
          }
        }
        premiacaoSelect.value = '1/5P';
      } else {
        for (let i = 0; i < premiacaoSelect.options.length; i++) {
          premiacaoSelect.options[i].style.display = '';
        }
      }
      
      document.getElementById('apostaInfo').innerText = getMensagemInfo();
      
      formatarAposta();
    }
    
    function getMensagemInfo() {
      const modalidadesInvertidas = ["Milhar Invertida", "Centena Invertida", "Milhar e Centena Invertida"];
      const modalidadesCombinadas = ["Dezena Combinada Cercada", "Grupo Combinado", "Grupo Combinado Cercado"];
      const modalidadesDuqueTerno = ["Duque de Dezena", "Duque de Dezena Combinado", "Terno de Dezena", 
                                   "Terno de Dezena Combinado", "Terno de Dezena Cercado", "Duque de Grupo", 
                                   "Terno de Grupo", "Terno de Grupo Combinado", "Terno de Grupo Cercado"];

      if (modalidadesInvertidas.includes(modalidadeAtual)) {
        return 'Digite números de 3 a 7 dígitos (ex: 123 1234 12345)';
      }
      
      if (modalidadesCombinadas.includes(modalidadeAtual)) {
        return 'Digite até 10 dígitos (ex: 1234567890).';
      }
      
      if (modalidadesDuqueTerno.includes(modalidadeAtual)) {
        if (modalidadeAtual.includes('Duque')) {
          return 'Digite números em pares para duque (ex: 1234 5678). Cada 2 dezenas = 1 aposta em 1/5P ou 6/10P.';
        } else {
          return 'Digite números em trios para terno (ex: 123456 789012). Cada 3 dezenas = 1 aposta em 1/5P ou 6/10P.';
        }
      }
      
      switch(modalidadeAtual) {
        case 'Milhar': 
          return 'Digite números de 4 dígitos (ex: 1234 5678).';
        case 'Milhar e Centena':
          return 'Digite números de 4 dígitos (ex: 1234 5678). Cada aposta conta como 2 jogos.';
        case 'Centena':
          return 'Digite números de 3 dígitos (ex: 123 456).';
        case 'Dezena':
          return 'Digite números de 2 dígitos (ex: 12 34).';
        case 'Grupo':
          return 'Digite números de 2 dígitos (01-25) representando grupos (ex: 12 34).';
        case 'Passe Vai':
        case 'Passe Vai e Vem':
          return 'Digite números de 2 dígitos (ex: 12 34).';
        default: return '';
      }
    }
    
    function limitarCaracteres(event) {
      const apostaInput = document.getElementById('aposta');
      const cursorPosition = apostaInput.selectionStart;
      let texto = apostaInput.value;
      
      if (event.key === 'Backspace' || event.key === 'Delete' || event.key === 'Tab') {
        return true;
      }
      
      if (event.ctrlKey || event.altKey || event.metaKey) {
        return true;
      }
      
      if (event.key === 'ArrowLeft' || event.key === 'ArrowRight' || event.key === 'ArrowUp' || event.key === 'ArrowDown') {
        return true;
      }
      
      if (!/^\d$/.test(event.key)) {
        event.preventDefault();
        return false;
      }
      
      if (!formatoDuqueTerno) {
        const textoAteCursor = texto.substring(0, cursorPosition);
        const ultimoEspaco = textoAteCursor.lastIndexOf(' ');
        const inicioApostaAtual = ultimoEspaco !== -1 ? ultimoEspaco + 1 : 0;
        const apostaAtual = texto.substring(inicioApostaAtual, cursorPosition).replace(/\D/g, '');
        
        if (apostaAtual.length >= maxCaracteres) {
          event.preventDefault();
          const newText = texto.substring(0, cursorPosition) + ' ' + texto.substring(cursorPosition);
          apostaInput.value = newText;
          apostaInput.selectionStart = apostaInput.selectionEnd = cursorPosition + 1;
          return false;
        }
      }
      
      return true;
    }
    
    function validarAposta() {
      const apostaInput = document.getElementById('aposta');
      const apostaError = document.getElementById('apostaError');
      const apostaInfo = document.getElementById('apostaInfo');
      const apostaSuccess = document.getElementById('apostaSuccess');
      const btnConfirmar = document.getElementById('btnConfirmar');
      
      apostaInfo.innerText = getMensagemInfo();
      apostaError.innerText = '';
      apostaSuccess.innerText = '';
      
      if (apostaInput.value.trim() === '') {
        btnConfirmar.disabled = false;
        btnConfirmar.style.opacity = '1';
        return;
      }
      
      const modalidadesCombinadas = ["Dezena Combinada Cercada", "Grupo Combinado", "Grupo Combinado Cercado"];
      const modalidadesDuqueTerno = ["Duque de Dezena", "Duque de Dezena Combinado", "Terno de Dezena", 
                                   "Terno de Dezena Combinado", "Terno de Dezena Cercado", "Duque de Grupo", 
                                   "Terno de Grupo", "Terno de Grupo Combinado", "Terno de Grupo Cercado"];
      
      let apostas = [];
      let todasValidas = true;
      let mensagemErro = '';
      
      if (modalidadesCombinadas.includes(modalidadeAtual)) {
        const apostaTexto = apostaInput.value.replace(/\s/g, '');
        for (let i = 0; i < apostaTexto.length; i += 2) {
          if (i + 2 <= apostaTexto.length) {
            apostas.push(apostaTexto.substring(i, i + 2));
          }
        }
        
        if (apostas.length > 7) {
          mensagemErro = `${modalidadeAtual} permite no máximo 7 dezenas. Você digitou ${apostas.length}.`;
          todasValidas = false;
        }
      } 
      else if (modalidadesDuqueTerno.includes(modalidadeAtual)) {
        apostas = apostaInput.value.split(' ').map(a => a.trim()).filter(a => a !== '');
        
        for (let aposta of apostas) {
          if (modalidadeAtual.includes('Duque') && aposta.length !== 4) {
            mensagemErro = `Cada duque deve ter exatamente 4 dígitos. "${aposta}" tem ${aposta.length}.`;
            todasValidas = false;
            break;
          }
          
          if (modalidadeAtual.includes('Terno') && aposta.length !== 6) {
            mensagemErro = `Cada terno deve ter exatamente 6 dígitos. "${aposta}" tem ${aposta.length}.`;
            todasValidas = false;
            break;
          }
          
          if (modalidadeAtual.toLowerCase().includes('grupo')) {
            let numeros = [];
            for (let i = 0; i < aposta.length; i += 2) {
              let num = aposta.substring(i, i+2);
              numeros.push(num);
              
              const numeroInt = parseInt(num);
              if (numeroInt < 1 || numeroInt > 25) {
                mensagemErro = `Grupo "${num}" inválido. Os grupos devem ser entre 01 e 25.`;
                todasValidas = false;
                break;
              }
            }
            if (!todasValidas) break;
          }
        }
      } 
      else {
        apostas = apostaInput.value.split(' ').map(a => a.trim()).filter(a => a !== '');
      }
      
      for (let i = 0; i < apostas.length && todasValidas; i++) {
        const aposta = apostas[i];
        
        if (!/^\d+$/.test(aposta)) {
          mensagemErro = `Aposta "${aposta}" não é um número válido.`;
          todasValidas = false;
          break;
        }
        
        if (modalidadeAtual.toLowerCase().includes('grupo') && !modalidadesDuqueTerno.includes(modalidadeAtual)) {
          const numero = parseInt(aposta);
          if (numero < 1 || numero > 25) {
            mensagemErro = `Grupo "${aposta}" inválido. Os grupos devem ser entre 01 e 25.`;
            todasValidas = false;
            break;
          }
        }
        
        const modalidadesInvertidas = ["Milhar Invertida", "Centena Invertida", "Milhar e Centena Invertida"];
        
        if (modalidadesInvertidas.includes(modalidadeAtual)) {
          if (aposta.length < 3 || aposta.length > 7) {
            mensagemErro = `${modalidadeAtual} deve ter entre 3 e 7 dígitos. "${aposta}" tem ${aposta.length}.`;
            todasValidas = false;
            break;
          }
        } 
        else if (!modalidadesDuqueTerno.includes(modalidadeAtual) && aposta.length !== maxCaracteres) {
          mensagemErro = `${modalidadeAtual} deve ter exatamente ${maxCaracteres} dígitos. "${aposta}" tem ${aposta.length}.`;
          todasValidas = false;
          break;
        }
      }
      
      if (mensagemErro) {
        apostaError.innerText = mensagemErro;
        btnConfirmar.disabled = true;
        btnConfirmar.style.opacity = '0.6';
        
        apostaInput.classList.add('shake');
        setTimeout(() => {
          apostaInput.classList.remove('shake');
        }, 500);
      } else {
        apostaError.innerText = '';
        const mensagemSucesso = `${apostas.length} número(s) válido(s) para ${modalidadeAtual}.`;
        apostaSuccess.innerText = mensagemSucesso;
        btnConfirmar.disabled = false;
        btnConfirmar.style.opacity = '1';
        calcularTotal();
      }
    }
    
    function toggleOperacao(tipo) {
      operacao = tipo;
      document.getElementById('btnMultiplicar').classList.toggle('active', tipo === 'multiplicar');
      document.getElementById('btnDividir').classList.toggle('active', tipo === 'dividir');
      calcularTotal();
    }

    function calcularTotal() {
      let valorInput = document.getElementById('valor').value;
      let valor = parseFloat(valorInput.replace(/\./g, '').replace(',', '.')) || 0;
      let premiacao = document.getElementById('premiacao').value;
      let aposta = document.getElementById('aposta').value;
      let modalidade = document.getElementById('modalidade').value;
      
      document.getElementById('premiacaoInfo').innerText = infoPremiacoes[premiacao] || "";
      
      let numerosApostados = 0;
      let quantidadeJogos = 0;
      
      if (aposta.trim() !== '') {
        const modalidadesCombinadas = ["Dezena Combinada Cercada", "Grupo Combinado", "Grupo Combinado Cercado"];
        const modalidadesDuqueTerno = ["Duque de Dezena", "Duque de Dezena Combinado", "Terno de Dezena", 
                                     "Terno de Dezena Combinado", "Terno de Dezena Cercado", "Duque de Grupo", 
                                     "Terno de Grupo", "Terno de Grupo Combinado", "Terno de Grupo Cercado"];
        const modalidadesInvertidas = ["Milhar Invertida", "Centena Invertida", "Milhar e Centena Invertida"];
        const modalidadesCercadas = ["Dezena Combinada Cercada", "Terno de Dezena Cercado", "Grupo Combinado Cercado", "Terno de Grupo Cercado"];
        
        if (modalidadesCombinadas.includes(modalidade)) {
          let apostasArray = [];
          const apostaTexto = aposta.replace(/\s/g, '');
          for (let i = 0; i < apostaTexto.length; i += 2) {
            if (i + 2 <= apostaTexto.length) {
              apostasArray.push(apostaTexto.substring(i, i + 2));
            }
          }
          numerosApostados = apostasArray.length;
          
          if (modalidade === "Grupo Combinado") {
            quantidadeJogos = numerosApostados;
          } else if (modalidade === "Dezena Combinada Cercada" || modalidade === "Grupo Combinado Cercado") {
            quantidadeJogos = numerosApostados * 3;
          }
        } 
        else if (modalidadesDuqueTerno.includes(modalidade)) {
          if (modalidade.includes('Combinado')) {
            quantidadeJogos = calcularCombinacoesDuqueTerno(aposta, modalidade);
          } else {
            const apostasArray = aposta.split(' ').map(a => a.trim()).filter(a => a !== '');
            if (modalidade.includes('Duque')) {
              quantidadeJogos = apostasArray.length;
            } else if (modalidade.includes('Terno')) {
              quantidadeJogos = apostasArray.length;
            }
          }
          
          if (modalidadesCercadas.includes(modalidade)) {
            quantidadeJogos *= 3;
          }
        } 
        else if (modalidadesInvertidas.includes(modalidade)) {
          const apostasArray = aposta.split(' ').map(a => a.trim()).filter(a => a !== '');
          numerosApostados = 0;
          
          for (let i = 0; i < apostasArray.length; i++) {
            numerosApostados += calcularCombinacoesPorPadrao(apostasArray[i], modalidade);
          }
          
          quantidadeJogos = numerosApostados;
        } 
        else {
          const apostasArray = aposta.split(' ').map(a => a.trim()).filter(a => a !== '');
          numerosApostados = apostasArray.length;
          quantidadeJogos = apostasArray.length;
          
          if (modalidade === "Milhar e Centena") {
            quantidadeJogos = quantidadeJogos * 2;
          }
        }
      }
      
      let multiplicador = 1;
      if (premiacao === "1/2P") multiplicador = 2;
      if (premiacao === "1/3P") multiplicador = 3;
      if (premiacao === "1/4P") multiplicador = 4;
      if (premiacao === "1/5P") multiplicador = 5;
      if (premiacao === "1/6P") multiplicador = 6;
      if (premiacao === "1/7P") multiplicador = 7;
      if (premiacao === "1/8P") multiplicador = 8;
      if (premiacao === "1/9P") multiplicador = 9;
      if (premiacao === "1/10P") multiplicador = 10;
      if (premiacao === "6/10P") multiplicador = 5;
      
      const modalidadesDuqueTerno = ["Duque de Dezena", "Duque de Dezena Combinado", "Terno de Dezena", 
                                   "Terno de Dezena Combinado", "Terno de Dezena Cercado", "Duque de Grupo", 
                                   "Terno de Grupo", "Terno de Grupo Combinado", "Terno de Grupo Cercado"];
      
      let quantidade = quantidadeJogos;
      if (!modalidadesDuqueTerno.includes(modalidade)) {
        quantidade = quantidadeJogos * multiplicador;
      }
      
      document.getElementById('quantidade').value = quantidade;

      let total;
      if (operacao === 'dividir') {
        const valorUnitarioPoule = valor / quantidade;
        total = valor;
        
        document.getElementById('valor').value = valorUnitarioPoule.toLocaleString('pt-BR', { 
          minimumFractionDigits: 2, 
          maximumFractionDigits: 2 
        });
      } else {
        total = valor * quantidade;
      }
      
      document.getElementById('total').value = "R$ " + total.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function formatarApostasComX(apostas, modalidade) {
      if (apostas.length === 0) return '';
      
      let resultado = '';
      
      const modalidadesComX = [
        'Duque de Dezena', 'Duque de Dezena Combinado', 
        'Duque de Grupo', 'Terno de Dezena', 
        'Terno de Dezena Combinado', 'Terno de Dezena Cercado',
        'Terno de Grupo', 'Terno de Grupo Combinado', 'Terno de Grupo Cercado'
      ];
      
      if (!modalidadesComX.includes(modalidade)) {
        return apostas.join(' ');
      }
      
      if (modalidade.includes('Duque')) {
        for (let i = 0; i < apostas.length; i += 2) {
          if (i + 1 < apostas.length) {
            resultado += `${apostas[i]} x ${apostas[i+1]}`;
            if (i + 2 < apostas.length) resultado += ' ';
          } else {
            resultado += `${apostas[i]}`;
          }
        }
      } 
      else if (modalidade.includes('Terno')) {
        for (let i = 0; i < apostas.length; i += 3) {
          if (i + 2 < apostas.length) {
            resultado += `${apostas[i]} x ${apostas[i+1]} x ${apostas[i+2]}`;
            if (i + 3 < apostas.length) resultado += ' ';
          } else if (i + 1 < apostas.length) {
            resultado += `${apostas[i]} x ${apostas[i+1]}`;
          } else {
            resultado += `${apostas[i]}`;
          }
        }
      }
      
      return resultado;
    }

    function toggleDatePicker() {
      apostaPredatada = document.getElementById('apostaPredatada').checked;
      const datePickerContainer = document.getElementById('datePickerContainer');
      
      if (apostaPredatada) {
        datePickerContainer.style.display = 'block';
        const hoje = new Date().toISOString().split('T')[0];
        document.getElementById('dataAposta').min = hoje;
      } else {
        datePickerContainer.style.display = 'none';
        dataApostaSelecionada = "";
      }
    }
    
    function hideDatePicker() {
      dataApostaSelecionada = document.getElementById('dataAposta').value;
    }

    function exibirResultado() {
      let extracao = document.getElementById('extracao').value;
      let modalidade = document.getElementById('modalidade').value;
      let aposta = document.getElementById('aposta').value;
      let premiacao = document.getElementById('premiacao').value;
      let valorInput = document.getElementById('valor').value;
      let valor = parseFloat(valorInput.replace(/\./g, '').replace(',', '.')) || 0;
      let quantidade = document.getElementById('quantidade').value;
      let total = document.getElementById('total').value;
      const repetirAposta = document.getElementById('repetirAposta').checked;
      apostaPredatada = document.getElementById('apostaPredatada').checked;

      if (aposta.trim() === '' || valor <= 0) {
        mostrarToast('Por favor, preencha todas as informações corretamente.', 'error');
        return;
      }

      if (apostaPredatada && !dataApostaSelecionada) {
        mostrarToast('Por favor, selecione uma data para a aposta pré-datada.', 'error');
        return;
      }

      const modalidadesDuqueTerno = ["Duque de Dezena", "Duque de Dezena Combinado", "Terno de Dezena", 
                                   "Terno de Dezena Combinado", "Terno de Dezena Cercado", "Duque de Grupo", 
                                   "Terno de Grupo", "Terno de Grupo Combinado", "Terno de Grupo Cercado"];
      
      let apostasArray = [];
      
      if (modalidadesDuqueTerno.includes(modalidade)) {
        const grupos = aposta.split(' ').map(a => a.trim()).filter(a => a !== '');
        
        for (let grupo of grupos) {
          let numeros = [];
          for (let i = 0; i < grupo.length; i += 2) {
            numeros.push(grupo.substring(i, i+2));
          }
          apostasArray = [...apostasArray, ...numeros];
        }
      } else {
        if (modalidade.includes("Combinada") || modalidade.includes("Combinado")) {
          const apostaTexto = aposta.replace(/\s/g, '');
          for (let i = 0; i < apostaTexto.length; i += 2) {
            if (i + 2 <= apostaTexto.length) {
              apostasArray.push(apostaTexto.substring(i, i + 2));
            }
          }
        } else {
          apostasArray = aposta.split(' ').map(a => a.trim()).filter(a => a !== '');
        }
      }
      
      if (modalidade.includes('Duque') && apostasArray.length % 2 !== 0) {
        mostrarToast('Duque precisa de números em pares (2, 4, 6, etc). Complete com mais um número.', 'error');
        return;
      } else if (modalidade.includes('Terno') && apostasArray.length % 3 !== 0) {
        const numerosFaltantes = 3 - (apostasArray.length % 3);
        mostrarToast(`Terno precisa de números em grupos de 3. Faltam ${numerosFaltantes} número(s).`, 'error');
        return;
      }

      repetindoAposta = repetirAposta && ultimaAposta && ultimaAposta.apostas.join(' ') === apostasArray.join(' ');

      todasApostas = [...todasApostas, ...apostasArray];
      
      historicoApostas.push({
        numeros: apostasArray,
        modalidade: modalidade,
        premiacao: premiacao,
        valor: valor,
        predatada: apostaPredatada,
        dataAposta: dataApostaSelecionada
      });
      
      const valorTotalAposta = parseFloat(total.replace("R$ ", "").replace(".", "").replace(",", "."));
      valorTotalBilhete += valorTotalAposta;

      const apostasFormatadas = formatarApostasComX(apostasArray, modalidade);

      let temMilharBrinde = false;
      if (valor > 2 && modalidade === "Milhar") {
        milharBrinde = gerarMilharBrinde();
        temMilharBrinde = true;
        apostasComMilharBrinde.push({
          numeros: apostasArray,
          milharBrinde: milharBrinde
        });
      }

      let apostaAtualTexto = '';
      
      if (repetindoAposta) {
        apostaAtualTexto = `${modalidade} - ${premiacao}
Unitario: R$ ${valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} Total: R$ ${parseFloat(total.replace("R$ ", "").replace(".", "").replace(",", ".")).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      } else {
        apostaAtualTexto = `${modalidade} - ${premiacao}
${apostasFormatadas}
Unitario: R$ ${valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} Total: R$ ${parseFloat(total.replace("R$ ", "").replace(".", "").replace(",", ".")).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      }

      let dataHoraTexto = `Data e Hora: ${new Date().toLocaleString('pt-BR')}`;
      let dataPredatadaTexto = '';
      if (apostaPredatada && dataApostaSelecionada) {
        const dataFormatada = new Date(dataApostaSelecionada).toLocaleDateString('pt-BR');
        dataPredatadaTexto = `Pré-datada: ${dataFormatada}`;
      }




      if (primeiraAposta) {
        bilheteCompleto = `          LOTERIA ESPERANCA
-------------------------------------------------------
EXT: ${extracao}
Poule: ${numeroPoule}
NSU: ${Math.floor(Math.random() * 1000000).toString().padStart(7, '0')}
Vendedor: ELIENE
Área: RONA
${dataHoraTexto}${dataPredatadaTexto ? '\n' + dataPredatadaTexto : ''}
-------------------------------------------------------`;
        primeiraAposta = false;
      } else if (!repetindoAposta) {
        bilheteCompleto += "\n------------------------------------------------------";
      }

      bilheteCompleto += `\n${apostaAtualTexto}`;

      

      const bilheteElement = document.getElementById('bilhete');
      
      let bilheteExibicao = bilheteCompleto;
      
      bilheteExibicao += `
-------------------------------------------------------
TOTAL DO BILHETE: R$ ${valorTotalBilhete.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
------------------------------------------------------
PREMIAÇÃO APENAS VÁLIDA COM 
APRESENTAÇÃO DESSE BILHETE. 
VÁLIDO POR 7 DIAS.
-------------------------------------------------------
         BOA SORTE!
--------------------------------------------------------`;
      
      bilheteExibicao = bilheteExibicao.split('\n').map(line => {
        return line.trim();
      }).join('\n').trim();
      
      bilheteElement.innerText = bilheteExibicao;
      bilheteElement.classList.add('fade-in');
      
      bilheteElement.style.height = 'auto';
      bilheteElement.style.minHeight = '400px';
      
      document.getElementById('btnPdf').style.display = "block";
      
      ultimaAposta = {
        apostas: apostasArray,
        modalidade: modalidade,
        premiacao: premiacao,
        valor: valor,
        quantidade: quantidade,
        total: total,
        predatada: apostaPredatada,
        dataAposta: dataApostaSelecionada
      };
      
      if (!repetirAposta) {
        limparCamposAposConfirmacao();
      } else {
        document.getElementById('premiacao').selectedIndex = 0;
        document.getElementById('valor').value = '';
        document.getElementById('quantidade').value = '';
        document.getElementById('total').value = '';
        calcularTotal();
      }
      
      mostrarToast('Aposta adicionada ao bilhete!', 'success');
    }

    function imprimirPDF() {
      const { jsPDF } = window.jspdf;
      
      const bilheteTexto = document.getElementById('bilhete').innerText;
      const numeroLinhas = bilheteTexto.split('\n').length;
      const alturaPorLinha = 5;
      const alturaMinima = 80;
      const alturaMaxima = 2000;
      const alturaCalculada = Math.min(alturaMaxima, Math.max(alturaMinima, numeroLinhas * alturaPorLinha + 1));
      
      const doc = new jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: [80, alturaCalculada]
      });
      
      doc.setProperties({
        title: 'LOTERIA ESPERANCA',
      });
      
      doc.setFont("helvetica", "bold");
      doc.setFontSize(10);
      
      let bilheteParaPDF = bilheteCompleto;
      
      bilheteParaPDF += `
-------------------------------------------------------
TOTAL DO BILHETE: R$ ${valorTotalBilhete.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
-------------------------------------------------------
PREMIAÇÃO APENAS VÁLIDA COM 
APRESENTAÇÃO DESSE BILHETE. 
VÁLIDO POR 7 DIAS.
-------------------------------------------------------
         BOA SORTE!
-------------------------------------------------------`;
      
      bilheteParaPDF = bilheteParaPDF.split('\n').map(line => {
        return line.trim();
      }).join('\n').trim();
      
      const lines = doc.splitTextToSize(bilheteParaPDF, 70);
      doc.text(lines, 5, 5);
      
      doc.setFontSize(8);
      doc.text(`Emitido: ${new Date().toLocaleString('pt-BR')}`, 5, alturaCalculada - 10);
      
      doc.save(`bilhete-sysbanca-${numeroBilhete}.pdf`);
      mostrarToast('PDF gerado com sucesso!', 'success');
      
      numeroBilhete++;
      
      limparFormulario();
    }
    
    function limparFormulario() {
      const repetirAposta = document.getElementById('repetirAposta').checked;
      
      if (!repetirAposta) {
        document.getElementById('aposta').value = '';
        document.getElementById('valor').value = '';
        document.getElementById('quantidade').value = '';
        document.getElementById('total').value = '';
        document.getElementById('apostaError').innerText = '';
        document.getElementById('apostaSuccess').innerText = '';
        document.getElementById('bilhete').innerText = 'Seu bilhete aparecerá aqui após confirmar a aposta.';
        document.getElementById('btnPdf').style.display = 'none';
        document.getElementById('repetirAposta').checked = false;
        
        document.getElementById('apostaPredatada').checked = false;
        document.getElementById('dataAposta').value = '';
        document.getElementById('datePickerContainer').style.display = 'none';
        apostaPredatada = false;
        dataApostaSelecionada = "";
        
        document.getElementById('extracao').selectedIndex = 0;
        document.getElementById('modalidade').selectedIndex = 0;
        document.getElementById('premiacao').selectedIndex = 0;
        operacao = 'multiplicar';
        document.getElementById('btnMultiplicar').classList.add('active');
        document.getElementById('btnDividir').classList.remove('active');
        
        todasApostas = [];
        bilheteCompleto = "";
        valorTotalBilhete = 0;
        milharBrinde = "";
        ultimaAposta = null;
        repetindoAposta = false;
        apostasComMilharBrinde = [];
        primeiraAposta = true;
        
        atualizarValidacaoAposta();
        mostrarToast('Formulário limpo com sucesso!', 'success');
      } else {
        mostrarToast('Desative "Repetir aposta" para limpar o formulário', 'info');
      }
    }
    
    function limparBilhete() {
      document.getElementById('bilhete').innerText = 'Seu bilhete aparecerá aqui após confirmar a aposta.';
      document.getElementById('btnPdf').style.display = 'none';
      
      todasApostas = [];
      bilheteCompleto = "";
      valorTotalBilhete = 0;
      milharBrinde = "";
      apostasComMilharBrinde = [];
      primeiraAposta = true;
      
      mostrarToast('Bilhete limpo com sucesso!', 'success');
    }
    
    function copiarBilhete() {
      const bilheteText = document.getElementById('bilhete').innerText;
      navigator.clipboard.writeText(bilheteText)
        .then(() => {
          mostrarToast('Bilhete copiado para a área de transferência!', 'success');
        })
        .catch(err => {
          mostrarToast('Falha ao copiar o bilhete.', 'error');
        });
    }
    
    function limparCamposAposConfirmacao() {
      document.getElementById('aposta').value = '';
      document.getElementById('valor').value = '';
      document.getElementById('quantidade').value = '';
      document.getElementById('total').value = '';
      document.getElementById('apostaError').innerText = '';
      document.getElementById('apostaSuccess').innerText = '';
      document.getElementById('repetirAposta').checked = false;
      
      document.getElementById('apostaPredatada').checked = false;
      document.getElementById('dataAposta').value = '';
      document.getElementById('datePickerContainer').style.display = 'none';
      apostaPredatada = false;
      dataApostaSelecionada = "";
    }
    
    function mostrarToast(mensagem, tipo = 'info') {
      const toast = document.getElementById('toast');
      toast.innerText = mensagem;
      
      if (tipo === 'error') {
        toast.style.background = 'rgba(204, 0, 0, 0.8)';
      } else if (tipo === 'success') {
        toast.style.background = 'rgba(0, 102, 0, 0.8)';
      } else {
        toast.style.background = 'rgba(0, 0, 0, 0.8)';
      }
      
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }
    
    function definirValor(valor) {
      document.getElementById('valor').value = valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      calcularTotal();
      
      document.querySelectorAll('.valor-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
    }

    window.onload = function() {
      const valorInput = document.getElementById('valor');
      valorInput.classList.add('currency-input');
      
      atualizarValidacaoAposta();
      
      valorInput.addEventListener('blur', function() {
        formatarMoeda(this);
      });
      
      document.getElementById('premiacao').addEventListener('change', function() {
        document.getElementById('premiacaoInfo').innerText = infoPremiacoes[this.value] || "";
      });
      
      document.getElementById('premiacaoInfo').innerText = infoPremiacoes[document.getElementById('premiacao').value] || "";
    };
  </script>
</body>
</html>