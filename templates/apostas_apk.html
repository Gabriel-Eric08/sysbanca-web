<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tela de Apostas - Sysbanca</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* ESTILOS EXISTENTES (mantidos intactos) */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #004d00, #007300, #00a000);
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      gap: 30px;
    }

    .container {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
      width: 600px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: transform 0.3s ease;
    }

    .container:hover {
      transform: translateY(-5px);
    }

    .bilhete-container {
      position: relative;
      width: 600px;
    }

    .bilhete {
      background: #fff;
      color: #000;
      padding: 20px;
      border-radius: 12px;
      width: 100%;
      font-family: 'Courier New', monospace;
      font-size: 16.5px;
      line-height: 1.6;
      white-space: pre-line;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      min-height: 400px;
      display: flex;
      align-items: center;
      border: 1px solid #ccc;
      overflow: auto;
      transition: all 0.3s ease;
    }

    h2 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 30px;
      color: #fff;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
    }

    .form-group {
      margin-bottom: 22.5px;
      position: relative;
    }

    label {
      display: block;
      margin-top: 18px;
      font-weight: bold;
      font-size: 18px;
      color: #fff;
    }

    input, select, textarea {
      width: 100%;
      padding: 15px;
      margin-top: 7.5px;
      border: none;
      border-radius: 12px;
      outline: none;
      font-size: 18px;
      background: rgba(255, 255, 255, 0.9);
      transition: all 0.3s ease;
    }

    input:focus, select:focus, textarea:focus {
      box-shadow: 0 0 0 3px rgba(255, 204, 0, 0.5);
    }

    textarea {
      resize: none;
      height: 105px;
      font-family: 'Courier New', monospace;
    }

    #total {
      background: #222;
      color: #0f0;
      font-weight: bold;
      font-size: 21px;
      text-align: center;
      padding: 15px;
    }

    .button-group {
      display: flex;
      gap: 15px;
      margin-top: 30px;
    }

    button {
      flex: 1;
      padding: 15px;
      color: white;
      border: none;
      border-radius: 15px;
      font-size: 21px;
      cursor: pointer;
      transition: 0.3s;
      font-weight: bold;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
    }

    #btnConfirmar {
      background: #ffcc00;
      color: #000;
    }

    #btnConfirmar:hover {
      background: #e6b800;
      transform: translateY(-2px);
    }

    #btnPdf {
      display: none;
      background: #ff3333;
    }

    #btnPdf:hover {
      background: #cc0000;
      transform: translateY(-2px);
    }

    #btnLimpar {
      background: #666;
    }

    #btnLimpar:hover {
      background: #555;
      transform: translateY(-2px);
    }

    .valor-info {
      font-size: 15px;
      color: #ddd;
      margin-top: 4.5px;
    }

    .operacao-group {
      display: flex;
      gap: 15px;
      margin-top: 15px;
    }

    .operacao-btn {
      flex: 1;
      padding: 12px;
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      color: white;
      cursor: pointer;
      text-align: center;
      font-size: 15px;
      transition: all 0.3s ease;
    }

    .operacao-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .operacao-btn.active {
      background: #00c6ff;
      font-weight: bold;
    }

    .aposta-info {
      font-size: 14px;
      color: #ffcc00;
      margin-top: 5px;
      font-weight: bold;
    }

    .aposta-error {
      font-size: 14px;
      color: #ff6666;
      margin-top: 5px;
      font-weight: bold;
    }

    .aposta-success {
      font-size: 14px;
      color: #66ff66;
      margin-top: 5px;
      font-weight: bold;
    }

    .input-hint {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 3px 8px;
      border-radius: 5px;
      font-size: 12px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    input:focus + .input-hint {
      opacity: 1;
    }

    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .toast.show {
      opacity: 1;
    }

    .switch-container {
      display: flex;
      align-items: center;
      margin-top: 15px;
      gap: 10px;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 30px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 30px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: #2196F3;
    }

    input:checked + .slider:before {
      transform: translateX(30px);
    }

    @media print {
      body * {
        visibility: hidden;
      }
      .bilhete, .bilhete * {
        visibility: visible;
      }
      .bilhete {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        box-shadow: none;
        border: none;
        font-size: 12px;
        padding: 10px;
        min-height: auto;
      }
    }

    @media (max-width: 1300px) {
      body {
        flex-direction: column;
        align-items: center;
      }
      
      .container, .bilhete-container {
        width: 90%;
        max-width: 600px;
      }
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
        gap: 20px;
      }
      
      .container {
        padding: 20px;
      }
      
      h2 {
        font-size: 24px;
      }
      
      input, select, textarea {
        padding: 12px;
        font-size: 16px;
      }
      
      button {
        font-size: 18px;
        padding: 12px;
      }
      
      .button-group {
        flex-direction: column;
      }
    }

    .shake {
      animation: shake 0.5s;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    .fade-in {
      animation: fadeIn 0.5s;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Novos estilos para melhorias */
    .modalidade-info {
      background: rgba(255, 255, 255, 0.1);
      padding: 10px;
      border-radius: 8px;
      margin-top: 5px;
      font-size: 14px;
      display: none;
    }

    .bilhete-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .bilhete-actions {
      display: flex;
      gap: 10px;
    }

    .bilhete-action-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 5px;
      color: white;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 12px;
    }

    .bilhete-action-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .valor-sugerido {
      display: flex;
      gap: 5px;
      margin-top: 5px;
      flex-wrap: wrap;
    }

    .valor-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 5px;
      color: white;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 12px;
    }

    .valor-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .valor-btn.active {
      background: #ffcc00;
      color: #000;
    }

    .historico-apostas {
      position: absolute;
      background: white;
      color: #000;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      padding: 10px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      display: none;
    }

    .historico-item {
      padding: 5px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    .historico-item:hover {
      background: #f0f0f0;
    }

    .premiacao-info {
      font-size: 12px;
      color: #ddd;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üé≤ Apostas Sysbanca</h2>

    <div class="form-group">
    <label for="extracao">Escolha a Extra√ß√£o</label>
    <select id="extracao">
      {% for extracao in extracoes %}
        <option value="{{ extracao.extracao }}">{{ extracao.extracao }}</option>
      {% endfor %}
    </select>
</div>

<div class="form-group">
    <label for="modalidade">Escolha a Modalidade</label>
    <select id="modalidade" onchange="atualizarValidacaoAposta()">
      {% for modalidade in modalidades %}
        <option value="{{ modalidade.modalidade }}">{{ modalidade.modalidade }}</option>
      {% endfor %}
    </select>
    <div id="modalidadeInfo" class="modalidade-info"></div>
</div>

    <div class="form-group">
      <label for="aposta">Digite a(s) Aposta(s)</label>
      <textarea id="aposta" placeholder="Ex: 1234, 567, 8910 (separadas por v√≠rgula)" oninput="validarAposta()" onkeydown="limitarCaracteres(event)"></textarea>
      <div id="apostaInfo" class="aposta-info"></div>
      <div id="apostaError" class="aposta-error"></div>
      <div id="apostaSuccess" class="aposta-success"></div>
      
      <div class="switch-container">
        <label class="switch">
          <input type="checkbox" id="repetirAposta">
          <span class="slider"></span>
        </label>
        <span>Repetir aposta com outra premia√ß√£o</span>
      </div>
    </div>

    <div class="form-group">
      <label for="premiacao">Premia√ß√£o</label>
      <select id="premiacao" onchange="calcularTotal()">
        <option value="1P">1P</option>
        <option value="1/2P">1/2P</option>
        <option value="1/3P">1/3P</option>
        <option value="1/4P">1/4P</option>
        <option value="1/5P">1/5P</option>
        <option value="1/6P">1/6P</option>
        <option value="1/7P">1/7P</option>
        <option value="1/8P">1/8P</option>
        <option value="1/9P">1/9P</option>
        <option value="1/10P">1/10P</option>
        <option value="6/10P">6/10P</option>
        <option value="1P e 1/5P">1P e 1/5P</option>
        <option value="1P e 1/10P">1P e 1/10P</option>
      </select>
      <div class="premiacao-info" id="premiacaoInfo"></div>
    </div>

    <div class="form-group">
      <label for="valor">Valor Unit√°rio (R$)</label>
      <input type="number" id="valor" placeholder="Ex: 2.00" step="0.01" min="0" oninput="calcularTotal()">
      <span class="input-hint">0.00</span>
      <div class="valor-info">Valores acima de R$ 2,00 em milhar geram brinde</div>
      
      <div class="valor-sugerido">
        <button class="valor-btn" onclick="definirValor(1)">R$ 1,00</button>
        <button class="valor-btn" onclick="definirValor(2)">R$ 2,00</button>
        <button class="valor-btn" onclick="definirValor(5)">R$ 5,00</button>
        <button class="valor-btn" onclick="definirValor(10)">R$ 10,00</button>
      </div>
      
      <div class="operacao-group">
        <div class="operacao-btn active" id="btnMultiplicar" onclick="toggleOperacao('multiplicar')">Multiplicar</div>
        <div class="operacao-btn" id="btnDividir" onclick="toggleOperacao('dividir')">Dividir</div>
      </div>
    </div>

    <div class="form-group">
        <label for="quantidade">Quantidade de Jogos</label>
        <input type="number" id="quantidade" readonly>
    </div>

    <div class="form-group">
      <label for="total">Valor Total</label>
      <input type="text" id="total" readonly>
    </div>

    <div class="button-group">
      <button id="btnConfirmar" onclick="exibirResultado()">
        <span class="icon">‚úì</span> Confirmar Aposta
      </button>
      <button id="btnPdf" onclick="imprimirPDF()">
        <span class="icon">üìÑ</span> Imprimir PDF
      </button>
      <button id="btnLimpar" onclick="limparFormulario()">
        <span class="icon">üóëÔ∏è</span> Limpar
      </button>
    </div>
  </div>

  <div class="bilhete-container">
    <div class="bilhete-header">
      <h3>Bilhete de Aposta</h3>
      <div class="bilhete-actions">
        <button class="bilhete-action-btn" onclick="copiarBilhete()">Copiar</button>
        <button class="bilhete-action-btn" onclick="limparBilhete()">Limpar</button>
      </div>
    </div>
    <div class="bilhete" id="bilhete">Seu bilhete aparecer√° aqui ap√≥s confirmar a aposta.</div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    let operacao = 'multiplicar';
    let numeroBilhete = 1;
    let modalidadeAtual = 'Milhar';
    let maxCaracteres = 4;
    let todasApostas = [];
    let bilheteCompleto = "";
    let valorTotalBilhete = 0;
    let milharBrinde = "";
    let ultimaAposta = null;
    let repetindoAposta = false;
    let apostasComMilharBrinde = [];
    let historicoApostas = [];
    let primeiraAposta = true;
    
    // Tabela de combina√ß√µes para modalidades invertidas
    const tabelaCombinacoes = {
      // Padr√£o: [d√≠gitos, centenas, milhares, total]
      "123": [3, 6, 0, 6],
      "112": [3, 3, 0, 3],
      "1234": [4, 24, 24, 48],
      "1123": [4, 12, 12, 24],
      "1122": [4, 6, 6, 12],
      "1112": [4, 4, 4, 8],
      "12345": [5, 60, 120, 180],
      "11234": [5, 33, 60, 93],
      "11223": [5, 18, 30, 48],
      "11123": [5, 13, 20, 33],
      "11122": [5, 8, 10, 18],
      "123456": [6, 120, 360, 480],
      "112345": [6, 72, 192, 264],
      "112234": [6, 42, 102, 144],
      "112233": [6, 24, 54, 78],
      "111234": [6, 34, 72, 106],
      "111223": [6, 19, 38, 57],
      "111222": [6, 8, 14, 22],
      "1234567": [7, 210, 840, 1050],
      "1123456": [7, 135, 480, 615],
      "1122345": [7, 90, 270, 360],
      "1122334": [7, 51, 150, 201],
      "1112345": [7, 73, 208, 281],
      "1122344": [7, 43, 114, 157],
      "1112233": [7, 25, 70, 95],
      "1112234": [7, 20, 46, 66],
      "11112": [5, 0, 5, 5],
      "111123": [6, 0, 21, 21],
      "111122": [6, 0, 11, 11],
      "1112222": [7, 0, 15, 15]
    };
    
    // Tabela de combina√ß√µes para ternos e duques
    const tabelaCombinacoesTernos = {
      2: 1,
      3: 3,
      4: 6,
      5: 10,
      6: 15,
      7: 21,
      8: 28,
      9: 36,
      10: 45
    };

    const tabelaCombinacoesDuques = {
      3: 1,
      4: 4,
      5: 10,
      6: 20,
      7: 35,
      8: 56,
      9: 84,
      10: 120
    };
    
    // Informa√ß√µes sobre modalidades
    const infoModalidades = {
      "Milhar": "Aposta em 4 d√≠gitos. Ex: 1234",
      "Centena": "Aposta em 3 d√≠gitos. Ex: 123",
      "Dezena": "Aposta em 2 d√≠gitos. Ex: 12",
      "Grupo": "Aposta em 2 d√≠gitos representando um grupo. Ex: 12",
      "Milhar Invertida": "Aposta em 3 a 7 d√≠gitos que gera combina√ß√µes de milhar. Ex: 1234",
      "Centena Invertida": "Aposta em 3 a 7 d√≠gitos que gera combina√ß√µes de centena. Ex: 123",
      "Milhar e Centena Invertida": "Aposta em 3 a 7 d√≠gitos que gera combina√ß√µes de milhar e centena. Ex: 1234",
      "Milhar e Centena": "Aposta em 4 d√≠gitos que vale para milhar and centena. Ex: 1234",
      "Dezena Combinada": "Combina√ß√£o de dezenas. Ex: 12, 34",
      "Dezena Combinada Cercada": "Dezenas combinadas and cercadas. Ex: 12, 34",
      "Duque de Dezena": "Par de dezenas. Ex: 12 x 34",
      "Duque de Dezena Combinado": "Pares de dezenas combinados. Ex: 12 x 34, 56 x 78",
      "Terno de Dezena": "Trio de dezenas. Ex: 12 x 34 x 56",
      "Terno de Dezena Combinado": "Trios de dezenas combinados. Ex: 12 x 34 x 56",
      "Terno de Dezena Cercado": "Trios de dezenas cercados. Ex: 12 x 34 x 56",
      "Grupo Combinado": "Combina√ß√£o de grupos. Ex: 12, 34",
      "Grupo Combinado Cercado": "Grupos combinados and cercados. Ex: 12, 34",
      "Duque de Grupo": "Par de grupos. Ex: 12 x 34",
      "Terno de Grupo": "Trio de grupos. Ex: 12 x 34 x 56",
      "Terno de Grupo Combinado": "Trios de grupos combinados. Ex: 12 x 34 x 56",
      "Terno de Grupo Cercado": "Trios de grupos cercados. Ex: 12 x 34 x 56",
      "Passe Vai": "Aposta especial passe vai",
      "Passe Vai e Vem": "Aposta especial passe vai e vem"
    };
    
    // Informa√ß√µes sobre premia√ß√µes
    const infoPremiacoes = {
      "1P": "Pr√™mio integral - 1 vez o valor",
      "1/2P": "Meio pr√™mio - 2 vezes o valor",
      "1/3P": "Ter√ßo do pr√™mio - 3 vezes o valor",
      "1/4P": "Quarto do pr√™mio - 4 vezes o valor",
      "1/5P": "Quinto do pr√™mio - 5 vezes o valor",
      "1/6P": "Sexto do pr√™mio - 6 vezes o valor",
      "1/7P": "S√©timo do pr√™mio - 7 vezes o valor",
      "1/8P": "Oitavo do pr√™mio - 8 vezes o valor",
      "1/9P": "Nono do pr√™mio - 9 vezes o valor",
      "1/10P": "D√©cimo do pr√™mio - 10 vezes o valor",
      "6/10P": "Seis d√©cimos do pr√™mio - valor especial",
      "1P e 1/5P": "Pr√™mio integral mais quinto do pr√™mio",
      "1P e 1/10P": "Pr√™mio integral mais d√©cimo do pr√™mio"
    };
    
    // Fun√ß√£o para gerar milhar brinde autom√°tica
    function gerarMilharBrinde() {
      return Math.floor(Math.random() * 10000).toString().padStart(4, '0');
    }
    
    // Fun√ß√£o para identificar o padr√£o de uma aposta
    function identificarPadraoAposta(aposta) {
      // Converte a aposta para um array de d√≠gitos
      const digitos = aposta.split('');
      
      // Cria um identificador de padr√£o baseado na repeti√ß√£o de d√≠gitos
      let contador = {};
      let padrao = '';
      
      for (let i = 0; i < digitos.length; i++) {
        const digito = digitos[i];
        if (!contador[digito]) {
          contador[digito] = Object.keys(contador).length + 1;
        }
        padrao += contador[digito];
      }
      
      return padrao;
    }
    
    // Fun√ß√£o para calcular combina√ß√µes baseadas no padr√£o
    function calcularCombinacoesPorPadrao(aposta, modalidade) {
      const padrao = identificarPadraoAposta(aposta);
      
      // Verifica se o padr√£o existe na tabela
      if (tabelaCombinacoes.hasOwnProperty(padrao)) {
        const [digitos, centenas, milhares, total] = tabelaCombinacoes[padrao];
        
        // Retorna o valor apropriado baseado na modalidade
        if (modalidade === "Milhar Invertida") {
          return milhares;
        } else if (modalidade === "Centena Invertida") {
          return centenas;
        } else if (modalidade === "Milhar e Centena Invertida") {
          return total;
        }
      }
      
      // Se n√£o encontrou o padr√£o, retorna o n√∫mero de d√≠gitos (fallback)
      return aposta.length;
    }
    
    function atualizarValidacaoAposta() {
      modalidadeAtual = document.getElementById('modalidade').value;
      
      // Atualiza informa√ß√µes da modalidade
      document.getElementById('modalidadeInfo').innerText = infoModalidades[modalidadeAtual] || "";
      document.getElementById('modalidadeInfo').style.display = infoModalidades[modalidadeAtual] ? "block" : "none";
      
      // Define o n√∫mero m√°ximo de caracteres por aposta
      const modalidadesInvertidas = ["Milhar Invertida", "Centena Invertida", "Milhar e Centena Invertida"];
      const modalidadesCombinadas = ["Dezena Combinada", "Dezena Combinada Cercada", "Grupo Combinado", "Grupo Combinado Cercado"];
      const modalidadesDuqueTerno = ["Duque de Dezena", "Duque de Dezena Combinado", "Terno de Dezena", 
                                   "Terno de Dezena Combinado", "Terno de Dezena Cercado", "Duque de Grupo", 
                                   "Terno de Grupo", "Terno de Grupo Combinado", "Terno de Grupo Cercado"];

      // Para modalidades combinadas, permite at√© 7 dezenas (14 d√≠gitos)
      if (modalidadesCombinadas.includes(modalidadeAtual)) {
        maxCaracteres = 14; // 7 dezenas * 2 d√≠gitos cada
      } 
      else if (modalidadesInvertidas.includes(modalidadeAtual)) {
        // Para modalidades invertidas, permite at√© 7 d√≠gitos
        maxCaracteres = 7;
      } 
      else if (modalidadesDuqueTerno.includes(modalidadeAtual)) {
        // Para duques e ternos, n√£o h√° limite espec√≠fico de caracteres, mas validaremos a quantidade
        maxCaracteres = 100; // Valor alto para n√£o limitar a digita√ß√£o
      }
      else {
        switch(modalidadeAtual) {
          case 'Milhar':
          case 'Milhar e Centena':
            maxCaracteres = 4;
            break;
          case 'Centena':
            maxCaracteres = 3;
            break;
          case 'Dezena':
          case 'Grupo':
          case 'Passe Vai':
          case 'Passe Vai e Vem':
            maxCaracteres = 2;
            break;
        }
      }
      
      // Restringe premia√ß√£o para duques e ternos apenas a 1/5P and 6/10P
      const premiacaoSelect = document.getElementById('premiacao');
      if (modalidadeAtual.includes('Duque') || modalidadeAtual.includes('Terno')) {
        // Mant√©m apenas 1/5P and 6/10P
        for (let i = 0; i < premiacaoSelect.options.length; i++) {
          const option = premiacaoSelect.options[i];
          if (option.value === '1/5P' || option.value === '6/10P') {
            option.style.display = '';
          } else {
            option.style.display = 'none';
          }
        }
        // Seleciona 1/5P como padr√£o
        premiacaoSelect.value = '1/5P';
      } else {
        // Mostra todas as op√ß√µes
        for (let i = 0; i < premiacaoSelect.options.length; i++) {
          premiacaoSelect.options[i].style.display = '';
        }
      }
      
      document.getElementById('apostaInfo').innerText = getMensagemInfo();
      validarAposta();
    }
    
    function getMensagemInfo() {
      const modalidadesInvertidas = ["Milhar Invertida", "Centena Invertida", "Milhar e Centena Invertida"];
      const modalidadesCombinadas = ["Dezena Combinada", "Dezena Combinada Cercada", "Grupo Combinado", "Grupo Combinado Cercado"];
      const modalidadesDuqueTerno = ["Duque de Dezena", "Duque de Dezena Combinado", "Terno de Dezena", 
                                   "Terno de Dezena Combinado", "Terno de Dezena Cercado", "Duque de Grupo", 
                                   "Terno de Grupo", "Terno de Grupo Combinado", "Terno de Grupo Cercado"];

      if (modalidadesInvertidas.includes(modalidadeAtual)) {
        return 'Digite n√∫meros de 3 a 7 d√≠gitos (ex: 123, 1234, 12345, 123456, 1234567)';
      }
      
      if (modalidadesCombinadas.includes(modalidadeAtual)) {
        return 'Digite at√© 7 dezenas de 2 d√≠gitos (ex: 12,34,56,78,90,13,24)';
      }
      
      if (modalidadesDuqueTerno.includes(modalidadeAtual)) {
        if (modalidadeAtual.includes('Duque')) {
          return 'Digite n√∫meros em pares para duque (ex: 12x34, 56x78)';
        } else {
          return 'Digite n√∫meros em trios para terno (ex: 12x34x56, 78x90x13)';
        }
      }
      
      switch(modalidadeAtual) {
        case 'Milhar': 
        case 'Milhar e Centena':
          return 'Digite n√∫meros de 4 d√≠gitos (ex: 1234, 5678)';
        case 'Centena':
          return 'Digite n√∫meros de 3 d√≠gitos (ex: 123, 456)';
        case 'Dezena':
        case 'Grupo':
        case 'Passe Vai':
        case 'Passe Vai e Vem':
          return 'Digite n√∫meros de 2 d√≠gitos (ex: 12, 34)';
        default: return '';
      }
    }
    
    // Fun√ß√£o para limitar caracteres durante a digita√ß√£o
    function limitarCaracteres(event) {
      const apostaInput = document.getElementById('aposta');
      const cursorPosition = apostaInput.selectionStart;
      const texto = apostaInput.value;
      
      // Se for v√≠rgula, espa√ßo ou enter, permite
      if (event.key === ',' || event.key === ' ' || event.key === 'Enter') {
        return true;
      }
      
      // Se for backspace ou delete, permite
      if (event.key === 'Backspace' || event.key === 'Delete') {
        return true;
      }
      
      // Se for tecla de controle, permite
      if (event.ctrlKey || event.altKey || event.metaKey) {
        return true;
      }
      
      // Se n√£o for n√∫mero, impede
      if (!/^\d$/.test(event.key)) {
        event.preventDefault();
        return false;
      }
      
      // Encontra a aposta atual (onde o cursor est√°)
      const textoAteCursor = texto.substring(0, cursorPosition);
      const ultimaVirgula = textoAteCursor.lastIndexOf(',');
      const inicioApostaAtual = ultimaVirgula !== -1 ? ultimaVirgula + 1 : 0;
      const apostaAtual = texto.substring(inicioApostaAtual, cursorPosition).trim();
      
      // Se a aposta atual j√° tem o n√∫mero m√°ximo de caracteres, impede
      if (apostaAtual.length >= maxCaracteres) {
        event.preventDefault();
        return false;
      }
      
      return true;
    }
    
    function validarAposta() {
      const apostaInput = document.getElementById('aposta');
      const apostaError = document.getElementById('apostaError');
      const apostaInfo = document.getElementById('apostaInfo');
      const apostaSuccess = document.getElementById('apostaSuccess');
      const btnConfirmar = document.getElementById('btnConfirmar');
      
      apostaInfo.innerText = getMensagemInfo();
      apostaError.innerText = '';
      apostaSuccess.innerText = '';
      
      if (apostaInput.value.trim() === '') {
        btnConfirmar.disabled = false;
        btnConfirmar.style.opacity = '1';
        return;
      }
      
      const modalidadesCombinadas = ["Dezena Combinada", "Dezena Combinada Cercada", "Grupo Combinado", "Grupo Combinado Cercado"];
      const modalidadesDuqueTerno = ["Duque de Dezena", "Duque de Dezena Combinado", "Terno de Dezena", 
                                   "Terno de Dezena Combinado", "Terno de Dezena Cercado", "Duque de Grupo", 
                                   "Terno de Grupo", "Terno de Grupo Combinado", "Terno de Grupo Cercado"];
      
      let apostas = [];
      let todasValidas = true;
      let mensagemErro = '';
      
      // Processamento diferente para modalidades combinadas
      if (modalidadesCombinadas.includes(modalidadeAtual)) {
        apostas = apostaInput.value.split(',').map(a => a.trim()).filter(a => a !== '');
        
        // Verifica se h√° mais de 7 dezenas
        if (apostas.length > 7) {
          mensagemErro = `${modalidadeAtual} permite no m√°ximo 7 dezenas. Voc√™ digitou ${apostas.length}.`;
          todasValidas = false;
        }
      } 
      // Processamento diferente para duques e ternos
      else if (modalidadesDuqueTerno.includes(modalidadeAtual)) {
        // Para duques e ternos, separamos por 'x' antes das v√≠rgulas
        const grupos = apostaInput.value.split(',').map(a => a.trim()).filter(a => a !== '');
        
        for (let grupo of grupos) {
          const numeros = grupo.split('x').map(n => n.trim()).filter(n => n !== '');
          
          if (modalidadeAtual.includes('Duque') && numeros.length !== 2) {
            mensagemErro = `Cada duque deve ter exatamente 2 n√∫meros separados por 'x'.`;
            todasValidas = false;
            break;
          }
          
          if (modalidadeAtual.includes('Terno') && numeros.length !== 3) {
            mensagemErro = `Cada terno deve ter exatamente 3 n√∫meros separados por 'x'.`;
            todasValidas = false;
            break;
          }
          
          // Adiciona todos os n√∫meros ao array de apostas
          apostas = [...apostas, ...numeros];
        }
      } 
      else {
        // Processamento normal para outras modalidades
        apostas = apostaInput.value.split(',').map(a => a.trim()).filter(a => a !== '');
      }
      
      // Valida√ß√£o de n√∫meros individuais
      for (let i = 0; i < apostas.length && todasValidas; i++) {
        const aposta = apostas[i];
        
        // Verifica se √© um n√∫mero v√°lido
        if (!/^\d+$/.test(aposta)) {
          mensagemErro = `Aposta "${aposta}" n√£o √© um n√∫mero v√°lido.`;
          todasValidas = false;
          break;
        }
        
        // Verifica o comprimento com base na modalidade
        const modalidadesInvertidas = ["Milhar Invertida", "Centena Invertida", "Milhar e Centena Invertida"];
        
        if (modalidadesInvertidas.includes(modalidadeAtual)) {
          // Para modalidades invertidas, aceita de 3 a 7 d√≠gitos
          if (aposta.length < 3 || aposta.length > 7) {
            mensagemErro = `${modalidadeAtual} deve ter entre 3 and 7 d√≠gitos. "${aposta}" tem ${aposta.length}.`;
            todasValidas = false;
            break;
          }
        } 
        else if (!modalidadesDuqueTerno.includes(modalidadeAtual) && aposta.length !== maxCaracteres) {
          mensagemErro = `${modalidadeAtual} deve ter exatamente ${maxCaracteres} d√≠gitos. "${aposta}" tem ${aposta.length}.`;
          todasValidas = false;
          break;
        }
      }
      
      if (mensagemErro) {
        apostaError.innerText = mensagemErro;
        btnConfirmar.disabled = true;
        btnConfirmar.style.opacity = '0.6';
        
        // Adiciona efeito de shake no campo de aposta
        apostaInput.classList.add('shake');
        setTimeout(() => {
          apostaInput.classList.remove('shake');
        }, 500);
      } else {
        apostaError.innerText = '';
        const mensagemSucesso = `${apostas.length} n√∫mero(s) v√°lido(s) para ${modalidadeAtual}.`;
        apostaSuccess.innerText = mensagemSucesso;
        btnConfirmar.disabled = false;
        btnConfirmar.style.opacity = '1';
        calcularTotal();
      }
    }
    
    function toggleOperacao(tipo) {
      operacao = tipo;
      document.getElementById('btnMultiplicar').classList.toggle('active', tipo === 'multiplicar');
      document.getElementById('btnDividir').classList.toggle('active', tipo === 'dividir');
      calcularTotal();
    }

    function calcularTotal() {
      let valor = parseFloat(document.getElementById('valor').value) || 0;
      let premiacao = document.getElementById('premiacao').value;
      let aposta = document.getElementById('aposta').value;
      let modalidade = document.getElementById('modalidade').value;
      
      // Atualiza informa√ß√µes da premia√ß√£o
      document.getElementById('premiacaoInfo').innerText = infoPremiacoes[premiacao] || "";
      
      // Calcula quantos n√∫meros foram apostados
      let numerosApostados = 0;
      let quantidadeJogos = 0;
      
      if (aposta.trim() !== '') {
        const modalidadesCombinadas = ["Dezena Combinada", "Dezena Combinada Cercada", "Grupo Combinado", "Grupo Combinado Cercado"];
        const modalidadesDuqueTerno = ["Duque de Dezena", "Duque de Dezena Combinado", "Terno de Dezena", 
                                     "Terno de Dezena Combinado", "Terno de Dezena Cercado", "Duque de Grupo", 
                                     "Terno de Grupo", "Terno de Grupo Combinado", "Terno de Grupo Cercado"];
        const modalidadesInvertidas = ["Milhar Invertida", "Centena Invertida", "Milhar e Centena Invertida"];
        const modalidadesCercadas = ["Dezena Combinada Cercada", "Terno de Dezena Cercado", "Grupo Combinado Cercado", "Terno de Grupo Cercado"];
        
        // Processa as apostas de acordo com a modalidade
        if (modalidadesCombinadas.includes(modalidade)) {
          const apostasArray = aposta.split(',').map(a => a.trim()).filter(a => a !== '');
          numerosApostados = apostasArray.length;
          
          // Para combinadas, o n√∫mero de jogos is calculado por combina√ß√£o
          if (modalidade === "Dezena Combinada" || modalidade === "Grupo Combinado") {
            quantidadeJogos = numerosApostados; // Apenas uma combina√ß√£o simples
          } else if (modalidade === "Dezena Combinada Cercada" || modalidade === "Grupo Combinado Cercado") {
            quantidadeJogos = numerosApostados * 3; // Cercado multiplica por 3
          }
        } 
        else if (modalidadesDuqueTerno.includes(modalidade)) {
          // Para duques e ternos, processamos os grupos
          const grupos = aposta.split(',').map(a => a.trim()).filter(a => a !== '');
          let totalNumeros = 0;
          
          for (let grupo of grupos) {
            const numeros = grupo.split('x').map(n => n.trim()).filter(n => n !== '');
            totalNumeros += numeros.length;
            
            // ALTERA√á√ÉO: Para duques, conta apenas 1 aposta a cada 2 dezenas
            if (modalidade.includes('Duque')) {
              quantidadeJogos += 1; // Cada duque conta como 1 aposta
            } 
            else if (modalidade.includes("Combinado")) {
              if (modalidade.includes("Duque")) {
                quantidadeJogos += tabelaCombinacoesTernos[numeros.length] || 0;
              } else if (modalidade.includes("Terno")) {
                quantidadeJogos += tabelaCombinacoesDuques[numeros.length] || 0;
              }
            } else {
              // Para n√£o combinados, cada grupo √© um jogo
              quantidadeJogos += 1;
            }
          }
          
          numerosApostados = totalNumeros;
          
          // Aplica multiplicador para cercados
          if (modalidadesCercadas.includes(modalidade)) {
            quantidadeJogos *= 3;
          }

          // ALTERA√á√ÉO: Dividir por 2 para Duque e por 3 para Terno
          if (modalidade.includes('Duque')) {
            quantidadeJogos = Math.ceil(quantidadeJogos / 2);
          } else if (modalidade.includes('Terno')) {
            quantidadeJogos = Math.ceil(quantidadeJogos / 3);
          }
        } 
        else if (modalidadesInvertidas.includes(modalidade)) {
          // Para modalidades invertidas, calcula as combina√ß√µes baseadas no padr√£o
          const apostasArray = aposta.split(',').map(a => a.trim()).filter(a => a !== '');
          numerosApostados = 0;
          
          for (let i = 0; i < apostasArray.length; i++) {
            numerosApostados += calcularCombinacoesPorPadrao(apostasArray[i], modalidade);
          }
          
          quantidadeJogos = numerosApostados;
        } 
        else {
          // Para modalidades normais
          const apostasArray = aposta.split(',').map(a => a.trim()).filter(a => a !== '');
          numerosApostados = apostasArray.length;
          quantidadeJogos = numerosApostados;
        }
      }
      
      let multiplicador = 1;
      if (premiacao === "1/2P") multiplicador = 2;
      if (premiacao === "1/3P") multiplicador = 3;
      if (premiacao === "1/4P") multiplicador = 4;
      if (premiacao === "1/5P") multiplicador = 5;
      if (premiacao === "1/6P") multiplicador = 6;
      if (premiacao === "1/7P") multiplicador = 7;
      if (premiacao === "1/8P") multiplicador = 8;
      if (premiacao === "1/9P") multiplicador = 9;
      if (premiacao === "1/10P") multiplicador = 10;
      if (premiacao === "6/10P") multiplicador = 5;
      
      let quantidade = quantidadeJogos * multiplicador;
      
      // Aplica a opera√ß√£o selecionada (multiplicar ou dividir)
      if (operacao === 'dividir' && quantidade > 0) {
        valor = valor / quantidade;
        quantidade = 1;
      }
      
      document.getElementById('quantidade').value = quantidade;

      let total = valor * quantidade;
      document.getElementById('total').value = "R$ " + total.toFixed(2);
    }

    // Fun√ß√£o para formatar apostas com X para duques and ternos
    function formatarApostasComX(apostas, modalidade) {
      if (apostas.length === 0) return '';
      
      let resultado = '';
      
      // Verifica se √© uma modalidade que precisa de formata√ß√£o com X
      const modalidadesComX = [
        'Duque de Dezena', 'Duque de Dezena Combinado', 
        'Duque de Grupo', 'Terno de Dezena', 
        'Terno de Dezena Combinado', 'Terno de Dezena Cercado',
        'Terno de Grupo', 'Terno de Grupo Combinado', 'Terno de Grupo Cercado'
      ];
      
      if (!modalidadesComX.includes(modalidade)) {
        // Para modalidades sem X, apenas junta com v√≠rgulas
        return apostas.join(', ');
      }
      
      // Para duques (2 n√∫meros)
      if (modalidade.includes('Duque')) {
        for (let i = 0; i < apostas.length; i += 2) {
          if (i + 1 < apostas.length) {
            resultado += `${apostas[i]} x ${apostas[i+1]}`;
            if (i + 2 < apostas.length) resultado += ', ';
          } else {
            resultado += `${apostas[i]}`;
          }
        }
      } 
      // Para ternos (3 n√∫meros)
      else if (modalidade.includes('Terno')) {
        for (let i = 0; i < apostas.length; i += 3) {
          if (i + 2 < apostas.length) {
            resultado += `${apostas[i]} x ${apostas[i+1]} x ${apostas[i+2]}`;
            if (i + 3 < apostas.length) resultado += ', ';
          } else if (i + 1 < apostas.length) {
            resultado += `${apostas[i]} x ${apostas[i+1]}`;
          } else {
            resultado += `${apostas[i]}`;
          }
        }
      }
      
      return resultado;
    }

    // Fun√ß√£o para buscar o valor de um cookie
    function getCookie(name) {
      const nameEQ = name + "=";
      const ca = document.cookie.split(';');
      for(let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
      }
      return null;
    }

    function exibirResultado() {
      let extracao = document.getElementById('extracao').value;
      let modalidade = document.getElementById('modalidade').value;
      let aposta = document.getElementById('aposta').value;
      let premiacao = document.getElementById('premiacao').value;
      let valor = parseFloat(document.getElementById('valor').value) || 0;
      let quantidade = document.getElementById('quantidade').value;
      let total = document.getElementById('total').value;
      const repetirAposta = document.getElementById('repetirAposta').checked;

      // Valida√ß√£o b√°sica
      if (aposta.trim() === '' || valor <= 0) {
        mostrarToast('Por favor, preencha todas as informa√ß√µes corretamente.', 'error');
        return;
      }

      // Valida√ß√£o espec√≠fica para duques e ternos
      const modalidadesDuqueTerno = ["Duque de Dezena", "Duque de Dezena Combinado", "Terno de Dezena", 
                                   "Terno de Dezena Combinado", "Terno de Dezena Cercado", "Duque de Grupo", 
                                   "Terno de Grupo", "Terno de Grupo Combinado", "Terno de Grupo Cercado"];
      
      let apostasArray = [];
      
      if (modalidadesDuqueTerno.includes(modalidade)) {
        // Para duques e ternos, processamos os grupos
        const grupos = aposta.split(',').map(a => a.trim()).filter(a => a !== '');
        
        for (let grupo of grupos) {
          const numeros = grupo.split('x').map(n => n.trim()).filter(n => n !== '');
          apostasArray = [...apostasArray, ...numeros];
        }
      } else {
        apostasArray = aposta.split(',').map(a => a.trim()).filter(a => a !== '');
      }
      
      if (modalidade.includes('Duque') && apostasArray.length % 2 !== 0) {
        mostrarToast('Duque precisa de n√∫meros em pares (2, 4, 6, etc). Complete com mais um n√∫mero.', 'error');
        return;
      } else if (modalidade.includes('Terno') && apostasArray.length % 3 !== 0) {
        const numerosFaltantes = 3 - (apostasArray.length % 3);
        mostrarToast(`Terno precisa de n√∫meros em grupos de 3. Faltam ${numerosFaltantes} n√∫mero(s).`, 'error');
        return;
      }

      // Verifica se estamos repetindo a aposta
      repetindoAposta = repetirAposta && ultimaAposta && ultimaAposta.apostas.join(',') === apostasArray.join(',');

      // Adiciona a aposta atual ao array de todas as apostas
      todasApostas = [...todasApostas, ...apostasArray];
      
      // Adiciona ao hist√≥rico de apostas
      historicoApostas.push({
        numeros: apostasArray,
        modalidade: modalidade,
        premiacao: premiacao,
        valorTotalAposta: parseFloat(total.replace("R$ ", "")), // ADI√á√ÉO
        unidadeAposta: valor // ADI√á√ÉO
      });
      
      // Adiciona ao valor total do bilhete
      const valorTotalAposta = parseFloat(total.replace("R$ ", ""));
      valorTotalBilhete += valorTotalAposta;

      // Formata as apostas com X se necess√°rio
      const apostasFormatadas = formatarApostasComX(apostasArray, modalidade);

      // Gera milhar brinde autom√°tica se for milhar e valor > 2
      let temMilharBrinde = false;
      if (valor > 2 && modalidade === "Milhar") {
        milharBrinde = gerarMilharBrinde();
        temMilharBrinde = true;
        // Armazena a aposta com milhar brinde
        apostasComMilharBrinde.push({
          numeros: apostasArray,
          milharBrinde: milharBrinde
        });
      }

      // Formata o texto da aposta atual
      let apostaAtualTexto = '';
      
      if (repetindoAposta) {
        // Se estiver repetindo a aposta, mostra apenas modalidade, premia√ß√£o e valores
        apostaAtualTexto = `${modalidade} - ${premiacao}
Unitario: R$ ${valor.toFixed(2)} Total: R$ ${parseFloat(total.replace("R$ ", "")).toFixed(2)}`;
      } else {
        // Se for uma nueva aposta, mostra todos os detalhes
        apostaAtualTexto = `${modalidade} - ${premiacao}
${apostasFormatadas}
Unitario: R$ ${valor.toFixed(2)} Total: R$ ${parseFloat(total.replace("R$ ", "")).toFixed(2)}`;
      }
      
      // Obt√©m o nome do vendedor do cookie, ou usa um valor padr√£o se n√£o encontrar
      const vendedor = getCookie('username') || 'VENDEDOR_N√ÉO_ENCONTRADO';
      const area = 'ONLINE';

      // Se for a primeira aposta, cria o cabe√ßalho
      if (primeiraAposta) {
        bilheteCompleto = `          LOTERIA SYSBANCA
------------------------------
EXT: ${extracao}
N¬∫ Bilhete: ${numeroBilhete.toString().padStart(6, '0')}
NSU: ${Math.floor(Math.random() * 1000000).toString().padStart(7, '0')}
Vendedor: ${vendedor}
√Årea: ${area}
Data e Hora: ${new Date().toLocaleString('pt-BR')}
------------------------------`;
        primeiraAposta = false;
      } else if (!repetindoAposta) {
        // Adiciona linha separadora apenas se n√£o for uma aposta de repeti√ß√£o
        bilheteCompleto += "\n------------------------------";
      }

      // Adiciona a aposta atual ao bilhete completo
      bilheteCompleto += `\n${apostaAtualTexto}`;

      // Adiciona milhar brinde se houver
      if (temMilharBrinde) {
        bilheteCompleto += `
M Brinde: ${milharBrinde}
MB 1P -> Premia√ß√£o R$ 500,00`;
      }

      // Atualiza o bilhete na tela
      const bilheteElement = document.getElementById('bilhete');
      
      // Formata o bilhete para exibi√ß√£o (centralizado)
      let bilheteExibicao = bilheteCompleto;
      
      // Adiciona o total do bilhete and rodap√©
      bilheteExibicao += `
------------------------------
TOTAL DO BILHETE: R$ ${valorTotalBilhete.toFixed(2)}
------------------------------
PREMIA√á√ÉO APENAS V√ÅLIDA COM 
APRESENTA√á√ÉO DESSE BILHETE. 
V√ÅLIDO POR 7 DIAS.
------------------------------
         BOA SORTE!
------------------------------`;
      
      // Centraliza o texto removendo espa√ßos em blanco das laterais
      bilheteExibicao = bilheteExibicao.split('\n').map(line => {
        return line.trim();
      }).join('\n');
      
      bilheteElement.innerText = bilheteExibicao;
      bilheteElement.classList.add('fade-in');
      
      // Mostra o bot√£o de PDF ap√≥s confirmar a aposta
      document.getElementById('btnPdf').style.display = "block";
      
      // Salva a aposta atual para poss√≠vel repeti√ß√£o
      ultimaAposta = {
        apostas: apostasArray,
        modalidade: modalidade,
        premiacao: premiacao,
        valor: valor,
        quantidade: quantidade,
        total: total
      };
      
      // Limpa apenas os campos da aposta atual se n√£o estiver no modo repeti√ß√£o
      if (!repetirAposta) {
        limparCamposAposConfirmacao();
      } else {
        // Mant√©m as apostas mas limpa os outros campos
        document.getElementById('premiacao').selectedIndex = 0;
        document.getElementById('valor').value = '';
        document.getElementById('quantidade').value = '';
        document.getElementById('total').value = '';
        calcularTotal();
      }
      
      mostrarToast('Aposta adicionada ao bilhete!', 'success');
    }

    function imprimirPDF() {
      // Obt√©m data e hora atuais
      const agora = new Date();
      const data_atual = agora.toLocaleDateString('pt-BR');
      const hora_atual = agora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
      
      // 1. Prepara os dados do bilhete para a requisi√ß√£o POST com a nova estrutura
      const bilheteParaSalvar = {
        extracao: document.getElementById('extracao').value,
        data_agendada: "05/06/2025",
        data_atual: data_atual,
        hora_atual: hora_atual,
        pre_datar: false,
        vendedor: getCookie('username') || 'VENDEDOR_N√ÉO_ENCONTRADO',
        area: 'ONLINE',
        apostas: historicoApostas.map(aposta => ({
          numeros: aposta.numeros.map(n => n),
          modalidade: aposta.modalidade,
          premio: aposta.premiacao,
          valorTotalAposta: aposta.valorTotalAposta,
          unidadeAposta: aposta.unidadeAposta
        })),
        valor_total: valorTotalBilhete,
      };

      // 2. Faz a requisi√ß√£o POST para a rota corrigida
      fetch('/aposta/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(bilheteParaSalvar)
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Falha ao salvar a aposta. Servidor retornou ' + response.status);
        }
        return response.json();
      })
      .then(data => {
        // 3. Se a requisi√ß√£o for bem-sucedida, gera o PDF
        console.log('Aposta salva com sucesso:', data);
        mostrarToast('Bilhete salvo e PDF gerado!', 'success');

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
          orientation: 'portrait',
          unit: 'mm',
          format: [80, 200]
        });
        
        // Configura√ß√£o para impressora t√©rmica
        doc.setProperties({
          title: 'Bilhete de Aposta - Sysbanca',
        });
        
        // Prepara o texto do bilhete para PDF
        let bilheteParaPDF = bilheteCompleto;
        
        // Adiciona o total do bilhete and rodap√©
        bilheteParaPDF += `
------------------------------
TOTAL DO BILHETE: R$ ${valorTotalBilhete.toFixed(2)}
------------------------------
PREMIA√á√ÉO APENAS V√ÅLIDA COM 
APRESENTA√á√ÉO DESSE BILHETE. 
V√ÅLIDO POR 7 DIAS.
------------------------------
         BOA SORTE!
------------------------------`;
        
        // Centraliza o texto removendo espa√ßos em branco das laterais
        bilheteParaPDF = bilheteParaPDF.split('\n').map(line => {
          return line.trim();
        }).join('\n');
        
        const lines = doc.splitTextToSize(bilheteParaPDF, 70);
        doc.text(lines, 5, 5);
        
        // Adiciona data e hora
        doc.setFontSize(8);
        doc.text(`Emitido: ${new Date().toLocaleString('pt-BR')}`, 5, 190);
        
        doc.save(`bilhete-sysbanca-${numeroBilhete}.pdf`);
        
        // Incrementa o n√∫mero do bilhete ap√≥s imprimir
        numeroBilhete++;
        
        // Limpa tudo ap√≥s imprimir
        limparFormulario();

      })
      .catch(error => {
        // 4. Se a requisi√ß√£o falhar, mostra uma mensagem de erro
        console.error('Erro ao salvar a aposta:', error);
        mostrarToast('Erro ao salvar o bilhete no servidor.', 'error');
      });
    }
    
    function limparFormulario() {
      const repetirAposta = document.getElementById('repetirAposta').checked;
      
      // S√≥ limpa se o bot√£o de repeti√ß√£o n√£o estiver ativo
      if (!repetirAposta) {
        document.getElementById('aposta').value = '';
        document.getElementById('valor').value = '';
        document.getElementById('quantidade').value = '';
        document.getElementById('total').value = '';
        document.getElementById('apostaError').innerText = '';
        document.getElementById('apostaSuccess').innerText = '';
        document.getElementById('bilhete').innerText = 'Seu bilhete aparecer√° aqui ap√≥s confirmar a aposta.';
        document.getElementById('btnPdf').style.display = 'none';
        document.getElementById('repetirAposta').checked = false;
        
        // Reset para valores padr√£o
        document.getElementById('extracao').selectedIndex = 0;
        document.getElementById('modalidade').selectedIndex = 0;
        document.getElementById('premiacao').selectedIndex = 0;
        operacao = 'multiplicar';
        document.getElementById('btnMultiplicar').classList.add('active');
        document.getElementById('btnDividir').classList.remove('active');
        
        // Limpa arrays de confirma√ß√£o
        todasApostas = [];
        bilheteCompleto = "";
        valorTotalBilhete = 0;
        milharBrinde = "";
        ultimaAposta = null;
        repetindoAposta = false;
        apostasComMilharBrinde = [];
        historicoApostas = [];
        primeiraAposta = true;
        
        atualizarValidacaoAposta();
        mostrarToast('Formul√°rio limpo com sucesso!', 'success');
      } else {
        mostrarToast('Desative "Repetir aposta" para limpar o formul√°rio', 'info');
      }
    }
    
    function limparBilhete() {
      document.getElementById('bilhete').innerText = 'Seu bilhete aparecer√° aqui ap√≥s confirmar a aposta.';
      document.getElementById('btnPdf').style.display = 'none';
      
      // Limpa arrays de confirma√ß√£o
      todasApostas = [];
      bilheteCompleto = "";
      valorTotalBilhete = 0;
      milharBrinde = "";
      apostasComMilharBrinde = [];
      historicoApostas = [];
      primeiraAposta = true;
      
      mostrarToast('Bilhete limpo com sucesso!', 'success');
    }
    
    function copiarBilhete() {
      const bilheteText = document.getElementById('bilhete').innerText;
      navigator.clipboard.writeText(bilheteText)
        .then(() => {
          mostrarToast('Bilhete copiado para a √°rea de transfer√™ncia!', 'success');
        })
        .catch(err => {
          mostrarToast('Falha ao copiar o bilhete.', 'error');
        });
    }
    
    function limparCamposAposConfirmacao() {
      document.getElementById('aposta').value = '';
      document.getElementById('valor').value = '';
      document.getElementById('quantidade').value = '';
      document.getElementById('total').value = '';
      document.getElementById('apostaError').innerText = '';
      document.getElementById('apostaSuccess').innerText = '';
      document.getElementById('repetirAposta').checked = false;
    }
    
    function mostrarToast(mensagem, tipo = 'info') {
      const toast = document.getElementById('toast');
      toast.innerText = mensagem;
      
      // Define a cor com base no tipo
      if (tipo === 'error') {
        toast.style.background = 'rgba(204, 0, 0, 0.8)';
      } else if (tipo === 'success') {
        toast.style.background = 'rgba(0, 102, 0, 0.8)';
      } else {
        toast.style.background = 'rgba(0, 0, 0, 0.8)';
      }
      
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }
    
    function definirValor(valor) {
      document.getElementById('valor').value = valor.toFixed(2);
      calcularTotal();
      
      // Destaca o bot√£o selecionado
      document.querySelectorAll('.valor-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
    }

    // Inicializar a valida√ß√£o
    window.onload = function() {
      // Configurar campo de valor para formata√ß√£o da direita para esquerda
      const valorInput = document.getElementById('valor');
      valorInput.style.textAlign = 'right';
      valorInput.style.direction = 'rtl';
      
      valorInput.addEventListener('focus', function() {
        this.style.direction = 'ltr';
        this.style.textAlign = 'left';
      });
      
      valorInput.addEventListener('blur', function() {
        if (this.value) {
          this.value = parseFloat(this.value).toFixed(2);
          this.style.direction = 'rtl';
          this.style.textAlign = 'right';
        }
      });
      
      // Configurar campo total para formata√ß√£o da direita para esquerda
      const totalInput = document.getElementById('total');
      totalInput.style.textAlign = 'right';
      totalInput.style.direction = 'rtl';
      
      // Resto da inicializa√ß√£o
      atualizarValidacaoAposta();
      document.getElementById('aposta').addEventListener('input', validarAposta);
      document.getElementById('aposta').addEventListener('input', calcularTotal);
      
      // Adicionar m√°scara autom√°tica para o campo de valor
      valorInput.addEventListener('blur', function() {
        if (this.value) {
          this.value = parseFloat(this.value).toFixed(2);
        }
      });
      
      // Adicionar informa√ß√µes de premia√ß√£o ao carregar
      document.getElementById('premiacao').addEventListener('change', function() {
        document.getElementById('premiacaoInfo').innerText = infoPremiacoes[this.value] || "";
      });
      
      // Inicializar informa√ß√µes de premia√ß√£o
      document.getElementById('premiacaoInfo').innerText = infoPremiacoes[document.getElementById('premiacao').value] || "";
    };
  </script>
</body>
</html>