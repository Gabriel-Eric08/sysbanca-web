<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cadastro de Coletor</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    tbody > tr:nth-child(odd) { background-color: #cfd8dd; }
    .botao-estiloso, .botao-salvar, .botao-voltar {
      padding: 5px 20px;
      font-size: 18px;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
      margin-right: 10px;
    }
    .botao-estiloso { background-color: #072749; }
    .botao-estiloso:hover { background-color: #0056b3; }
    .botao-salvar { background-color: #be0d0d; }
    .botao-salvar:hover { background-color: #ec5050; }
    .botao-voltar { background-color: #1fa53c; }
    .botao-voltar:hover { background-color: #128d2e; }
  </style>
</head>
<body class="container py-4">

  <h2 class="mb-4">Cadastro de Coletor</h2>

  <form id="formColetor" method="POST" action="/coletor/" onsubmit="prepararEnvio()">
    <div class="row g-3 align-items-end">
      <div class="col-md-4">
        <label for="nome" class="form-label">Nome</label>
        <input type="text" id="nome" class="form-control" />
      </div>
      <div class="col-md-4">
        <label for="area" class="form-label">√Årea</label>
        <select id="area" name="area" class="form-select">
          <option value="">Selecione</option>
          {% for a in areas %}
            <option value="{{ a.regiao_area }}">{{ a.regiao_area }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label for="login" class="form-label">Login</label>
        <input type="text" id="login" class="form-control" />
      </div>
      <div class="col-md-4">
        <label for="senha" class="form-label">Senha</label>
        <input type="text" id="senha" class="form-control" />
      </div>
      <div class="col-md-4">
        <label for="ativar" class="form-label">Ativar</label>
        <select id="ativar" class="form-select">
          <option value=""></option>
          <option value="sim">Sim</option>
          <option value="nao">N√£o</option>
        </select>
      </div>
      <div class="col-md-4">
        <label for="buscaNome" class="form-label">Buscar por Nome</label>
        <input type="text" id="buscaNome" class="form-control" placeholder="Digite o nome para buscar" />
      </div>
    </div>

    <div class="mt-4">
      <button type="button" class="botao-estiloso" onclick="adicionarLinha()">‚ûï Adicionar</button>
      <button type="submit" class="botao-salvar">üíæ Salvar</button>
      <a href="{{ url_for('Home.home') }}">
        <button type="button" class="botao-voltar">Sair</button>
      </a>
    </div>

    <div id="hiddenFields"></div>
  </form>

  <div class="mt-4 table-responsive">
    <table class="table table-bordered table-striped">
      <thead class="table-success">
        <tr>
          <th>Coletor</th>
          <th>√Årea</th>
          <th>Login</th>
          <th>Senha</th>
          <th>Ativar</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="tabela">
        {% if coletores %}
          {% for c in coletores %}
            <tr>
              <td>{{ c.nome_coletor }}</td>
              <td>{{ c.area }}</td>
              <td>{{ c.login }}</td>
              <td>{{ c.senha }}</td>
              <td>{{ c.ativar_coletor }}</td>
              <td>
                <button type="button" class="botao-estiloso" onclick="editarLinha(this)">‚úèÔ∏è Editar</button>
                <button type="button" class="botao-salvar" onclick="excluirLinha(this)">üóëÔ∏è Excluir</button>
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="6" class="text-center">Nenhum coletor cadastrado</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <script id="areas-data" type="application/json">
    {{ areas_json | tojson }}
  </script>

  <script>
    const areasData = JSON.parse(document.getElementById('areas-data').textContent);

    function editarLinha(botao) {
      const linha = botao.closest("tr");
      const valoresOriginais = [];

      for (let i = 0; i < 5; i++) {
        valoresOriginais.push(linha.cells[i].textContent.trim());
      }

      linha.setAttribute("data-original", JSON.stringify(valoresOriginais));

      linha.cells[0].innerHTML = `<input class="form-control" value="${valoresOriginais[0]}">`;

      const selectArea = document.createElement("select");
      selectArea.className = "form-select";
      areasData.forEach(area => {
        const opt = new Option(area.regiao_area, area.regiao_area);
        if (opt.value === valoresOriginais[1]) opt.selected = true;
        selectArea.appendChild(opt);
      });
      linha.cells[1].innerHTML = '';
      linha.cells[1].appendChild(selectArea);

      linha.cells[2].innerHTML = `<input class="form-control" value="${valoresOriginais[2]}">`;
      linha.cells[3].innerHTML = `<input class="form-control" value="${valoresOriginais[3]}">`;

      const selectAtivar = document.createElement("select");
      selectAtivar.className = "form-select";
      selectAtivar.innerHTML = `
        <option value="sim" ${valoresOriginais[4].toLowerCase() === 'sim' ? 'selected' : ''}>Sim</option>
        <option value="nao" ${valoresOriginais[4].toLowerCase() === 'nao' ? 'selected' : ''}>N√£o</option>
      `;
      linha.cells[4].innerHTML = '';
      linha.cells[4].appendChild(selectAtivar);

      linha.cells[5].innerHTML = `
        <button class="botao-voltar" onclick="salvarEdicao(this)">üíæ Salvar</button>
        <button class="botao-salvar" onclick="cancelarEdicao(this)">‚ùå Cancelar</button>
      `;
    }

    function salvarEdicao(botao) {
      const linha = botao.closest("tr");
      const valores = linha.querySelectorAll("input, select");

      const dados = {
        nome_original: JSON.parse(linha.getAttribute("data-original"))[0],
        nome_coletor: valores[0].value,
        area: valores[1].value,
        login: valores[2].value,
        senha: valores[3].value,
        ativar_coletor: valores[4].value
      };

      fetch('/coletor/editar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dados)
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          linha.cells[0].textContent = dados.nome_coletor;
          linha.cells[1].textContent = dados.area;
          linha.cells[2].textContent = dados.login;
          linha.cells[3].textContent = dados.senha;
          linha.cells[4].textContent = dados.ativar_coletor;
          linha.cells[5].innerHTML = `
            <button type="button" class="botao-estiloso" onclick="editarLinha(this)">‚úèÔ∏è Editar</button>
            <button type="button" class="botao-salvar" onclick="excluirLinha(this)">üóëÔ∏è Excluir</button>
          `;
        } else {
          alert(data.message);
        }
      })
      .catch(err => {
        console.error("Erro ao editar:", err);
        alert("Erro ao editar coletor.");
      });
    }

    function cancelarEdicao(botao) {
      const linha = botao.closest("tr");
      const originais = JSON.parse(linha.getAttribute("data-original"));

      for (let i = 0; i < 5; i++) {
        linha.cells[i].textContent = originais[i];
      }

      linha.cells[5].innerHTML = `
        <button type="button" class="botao-estiloso" onclick="editarLinha(this)">‚úèÔ∏è Editar</button>
        <button type="button" class="botao-salvar" onclick="excluirLinha(this)">üóëÔ∏è Excluir</button>
      `;
    }

    function excluirLinha(botao) {
      const linha = botao.closest("tr");
      const nome = linha.cells[0].textContent;

      if (!confirm(`Tem certeza que deseja excluir o coletor "${nome}"?`)) return;

      fetch('/coletor/deletar_coletor', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nome })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          linha.remove();
        } else {
          alert(data.message || 'Erro ao excluir coletor');
        }
      })
      .catch(err => {
        console.error('Erro:', err);
        alert('Erro ao conectar com o servidor');
      });
    }

    function adicionarLinha() {
      const nome = document.getElementById('nome').value.trim();
      const area = document.getElementById('area').value.trim();
      const login = document.getElementById('login').value.trim();
      const senha = document.getElementById('senha').value.trim();
      const ativar = document.getElementById('ativar').value.trim();

      if (!nome || !area || !login || !senha || !ativar) {
        alert('Preencha todos os campos!');
        return;
      }

      const tabela = document.getElementById('tabela');
      const novaLinha = tabela.insertRow();
      novaLinha.insertCell(0).textContent = nome;
      novaLinha.insertCell(1).textContent = area;
      novaLinha.insertCell(2).textContent = login;
      novaLinha.insertCell(3).textContent = senha;
      novaLinha.insertCell(4).textContent = ativar;
      novaLinha.insertCell(5).innerHTML = `
        <button type="button" class="botao-estiloso" onclick="editarLinha(this)">‚úèÔ∏è Editar</button>
        <button type="button" class="botao-salvar" onclick="excluirLinha(this)">üóëÔ∏è Excluir</button>
      `;

      limparCampos();
    }

    function limparCampos() {
      ['nome', 'area', 'login', 'senha', 'ativar', 'buscaNome'].forEach(id => {
        document.getElementById(id).value = '';
      });
    }

    document.getElementById('buscaNome').addEventListener('input', function () {
      const termo = this.value.toLowerCase();
      const linhas = document.querySelectorAll("#tabela tr");

      linhas.forEach(linha => {
        const nome = linha.cells[0].textContent.toLowerCase();
        if (nome.includes(termo)) {
          document.getElementById('nome').value = linha.cells[0].textContent;
          document.getElementById('area').value = linha.cells[1].textContent;
          document.getElementById('login').value = linha.cells[2].textContent;
          document.getElementById('senha').value = linha.cells[3].textContent;
          document.getElementById('ativar').value = linha.cells[4].textContent;
        }
      });
    });

    function prepararEnvio() {
      const tbody = document.querySelector("#tabela");
      const hidden = document.getElementById("hiddenFields");
      hidden.innerHTML = '';

      const campos = ['nome', 'area', 'login', 'senha', 'ativar'];

      tbody.querySelectorAll("tr").forEach(linha => {
        campos.forEach((campo, i) => {
          const input = document.createElement("input");
          input.type = "hidden";
          input.name = campo + "[]";
          input.value = linha.cells[i].textContent.trim();
          hidden.appendChild(input);
        });
      });
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
