<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cadastro de Descarrego</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    tbody > tr:nth-child(odd) {
      background-color: #cfd8dd;
    }

    .botao-adicionar { background-color: #072749; }
    .botao-salvar { background-color: #ff9900; }
    .botao-salvar1 { background-color: #be0d0d; }
    .botao-editar { background-color: #1fa53c; }
    .botao-excluir { background-color: #be0d0d; }

    .botao-adicionar, .botao-salvar1,  .botao-salvar, .botao-editar, .botao-excluir {
      font-size: 18px;
      color: white;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      border: none;
      padding: 6px 20px;
      cursor: pointer;
      margin-right: 10px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .botao-adicionar:hover { background-color: #0056b3; }
    .botao-salvar:hover { background-color: #ffa733; }
    .botao-editar:hover { background-color: #128d2e; }
    .botao-excluir:hover { background-color: #ec5050; }

    .form-label {
      font-weight: bold;
    }

    input[readonly] {
      background-color: #f1f1f1;
    }
  </style>
</head>
<body>

  <div class="container">
    <h2 class="mb-4">Cadastro de Descarrego</h2>

    <form id="formDescarrego" onsubmit="return false;">
      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <label for="usuario" class="form-label">Usu√°rio</label>
          <select id="usuario" class="form-select" multiple>
            {% for u in users_acess %}
              <option value="{{ u.username }}">{{ u.username }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label for="novaArea" class="form-label">√Årea</label>
          <select id="novaArea" class="form-select" multiple>
            {% for a in areas %}
              <option value="{{ a.regiao_area }}">{{ a.regiao_area }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label for="novaExtracao" class="form-label">Extra√ß√£o</label>
          <select id="novaExtracao" class="form-select" multiple>
            {% for e in extracoes %}
              <option value="{{ e.extracao }}">{{ e.extracao }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label for="novaModalidade" class="form-label">Modalidade</label>
          <select id="novaModalidade" class="form-select" multiple>
            {% for m in modalidades %}
              <option value="{{ m.modalidade }}">{{ m.modalidade }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label for="novoLimite" class="form-label">Limite (R$)</label>
          <input type="number" step="0.01" id="novoLimite" class="form-control" />
        </div>

        <div class="col-md-4">
          <label for="buscaModalidade" class="form-label">Filtrar por Modalidade</label>
          <select id="buscaModalidade" class="form-select" multiple>
            {% for m in modalidades %}
              <option value="{{ m.modalidade }}">{{ m.modalidade }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="my-4">
        <button class="botao-adicionar" type="button" onclick="adicionarLinha()">‚ûï Adicionar</button>
        <button class="botao-salvar" type="button" onclick="salvarTabela()">üíæ Salvar</button>
        <a href="{{ url_for('Home.home') }}">
          <button type="button" class="botao-salvar1">Sair</button>
        </a>
      </div>
    </form>

    <table class="table table-bordered table-striped">
      <thead class="table-primary">
        <tr>
          <th>√Årea</th>
          <th>Extra√ß√£o</th>
          <th>Modalidade</th>
          <th>Limite</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="tabela">
        {% for d in descarregos %}
          <tr>
            <td>{{ d.areas }}</td>
            <td>{{ d.extracao }}</td>
            <td>{{ d.modalidade }}</td>
            <td>{{ "%.2f"|format(d.limite) }}</td>
            <td>
              <button class="botao-editar btn btn-sm me-2" type="button" onclick="editarLinha(this)">‚úèÔ∏è Editar</button>
              <button class="botao-excluir btn btn-sm" type="button" onclick="excluirLinha(this)">üóë Excluir</button>
            </td>
          </tr>
        {% else %}
          <tr><td colspan="5" class="text-center">Nenhum descarrego cadastrado</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

  <script>
    const usuarioSelect = new Choices('#usuario', { removeItemButton: true, placeholder: true, searchEnabled: true });
    const areaSelect = new Choices('#novaArea', { removeItemButton: true, placeholder: true, searchEnabled: true });
    const extracaoSelect = new Choices('#novaExtracao', { removeItemButton: true, placeholder: true, searchEnabled: true });
    const modalidadeSelect = new Choices('#novaModalidade', { removeItemButton: true, placeholder: true, searchEnabled: true });
    const buscaModalidadeSelect = new Choices('#buscaModalidade', { removeItemButton: true, placeholder: true, searchEnabled: true });

    document.getElementById('buscaModalidade').addEventListener('change', () => {
      const selecionadas = buscaModalidadeSelect.getValue().map(opt => opt.value.toLowerCase());
      const linhas = document.querySelectorAll('#tabela tr');

      linhas.forEach(linha => {
        const modalidadesTexto = linha.cells[2]?.textContent?.toLowerCase() || '';
        const deveExibir = selecionadas.length === 0 || selecionadas.some(sel => modalidadesTexto.includes(sel));
        linha.style.display = deveExibir ? '' : 'none';
      });
    });

    function adicionarLinha() {
      const areas = Array.from(document.querySelectorAll('#novaArea option:checked')).map(o => o.value).join(', ');
      const extracoes = Array.from(document.querySelectorAll('#novaExtracao option:checked')).map(o => o.value).join(', ');
      const modalidades = Array.from(document.querySelectorAll('#novaModalidade option:checked')).map(o => o.value).join(', ');
      const limite = document.getElementById('novoLimite').value.trim();

      if (!areas || !extracoes || !modalidades || !limite) {
        alert('Preencha todos os campos!');
        return;
      }

      const tabela = document.getElementById('tabela');
      const novaLinha = tabela.insertRow();

      novaLinha.insertCell(0).textContent = areas;
      novaLinha.insertCell(1).textContent = extracoes;
      novaLinha.insertCell(2).textContent = modalidades;
      novaLinha.insertCell(3).textContent = parseFloat(limite).toFixed(2);

      const acoes = novaLinha.insertCell(4);
      acoes.innerHTML = `
        <button class="botao-editar btn btn-sm me-2" type="button" onclick="editarLinha(this)">‚úèÔ∏è Editar</button>
        <button class="botao-excluir btn btn-sm" type="button" onclick="excluirLinha(this)">üóë Excluir</button>
      `;

      limparCampos();
    }

    function limparCampos() {
      areaSelect.removeActiveItems();
      extracaoSelect.removeActiveItems();
      modalidadeSelect.removeActiveItems();
      document.getElementById('novoLimite').value = '';
      buscaModalidadeSelect.removeActiveItems();
    }

    function editarLinha(botao) {
      const linha = botao.closest('tr');
      const [areas, extracoes, modalidades, limite] = Array.from(linha.cells).slice(0,4).map(cell => cell.textContent);

      areaSelect.setChoiceByValue(areas.split(', ').filter(Boolean));
      extracaoSelect.setChoiceByValue(extracoes.split(', ').filter(Boolean));
      modalidadeSelect.setChoiceByValue(modalidades.split(', ').filter(Boolean));
      document.getElementById('novoLimite').value = limite;

      linha.remove();
    }

    function excluirLinha(botao) {
      const linha = botao.closest('tr');
      const area = linha.cells[0].textContent.trim();
      const extracao = linha.cells[1].textContent.trim();
      const modalidade = linha.cells[2].textContent.trim();

      if (!confirm('Tem certeza que deseja excluir este descarrego?')) return;

      fetch('/cadastrodescarrego/excluir', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ area, extracao, modalidade }),
      })
      .then(res => {
        if (res.ok) {
          linha.remove();
          limparCampos();
          alert('Descarrego exclu√≠do com sucesso.');
        } else {
          alert('Erro ao excluir descarrego.');
        }
      })
      .catch(() => alert('Erro na comunica√ß√£o com o servidor.'));
    }

    function salvarTabela() {
      const linhas = document.querySelectorAll('#tabela tr');
      const dados = [];

      linhas.forEach(tr => {
        const area = tr.cells[0].textContent.trim();
        const extracao = tr.cells[1].textContent.trim();
        const modalidade = tr.cells[2].textContent.trim();
        const limite = tr.cells[3].textContent.trim();

        dados.push({ area, extracao, modalidade, limite });
      });

      fetch('/cadastrodescarrego/salvar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dados),
      })
      .then(res => {
        if (res.ok) return res.json();
        throw new Error('Erro ao salvar.');
      })
      .then(data => {
        alert('Salvo com sucesso!');
        location.reload();
      })
      .catch(err => alert(err.message));
    }
  </script>
</body>
</html>
