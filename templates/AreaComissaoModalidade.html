<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cadastro Comiss√£o por √Årea</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <style>
        tbody > tr:nth-child(odd) { background-color: #cfd8dd; }
        .botao-estiloso, .botao-voltar, .botao-salvar {
            padding: 5px 20px;
            font-size: 18px;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            margin-right: 10px;
        }
        .botao-estiloso { background-color: #072749; }
        .botao-estiloso:hover { background-color: #0056b3; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3); }
        .botao-voltar { background-color: #1fa53c; }
        .botao-voltar:hover { background-color: #14802a; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3); }
        .botao-salvar { background-color: #be0d0d; }
        .botao-salvar:hover { background-color: #ec5050; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3); }
    </style>
</head>
<body class="container py-4">
    <h2 class="mb-4">Cadastro das Comiss√µes por √Årea</h2>

    <form id="formComissao">
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label for="area" class="form-label">√Årea</label>
                <select id="area" class="form-select" multiple>
                    {% for a in areas %}<option value="{{ a.regiao_area }}">{{ a.regiao_area }}</option>{% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="modalidade" class="form-label">Modalidade</label>
                <select id="modalidade" class="form-select" multiple>
                    {% for m in modalidades %}<option value="{{ m.modalidade }}">{{ m.modalidade }}</option>{% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="comissao" class="form-label">Comiss√£o</label>
                <input type="number" id="comissao" class="form-control" />
            </div>
            <div class="col-md-2">
                <label for="ativar" class="form-label">Ativar</label>
                <select id="ativar" class="form-select">
                    <option value=""></option>
                    <option value="sim">Sim</option>
                    <option value="nao">N√£o</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="vendedor" class="form-label">Vendedor</label>
                <select id="vendedor" class="form-select" multiple>
                    {% for v in vendedores %}<option value="{{ v.nome }}">{{ v.nome }}</option>{% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="extracao" class="form-label">Extra√ß√£o</label>
                <select id="extracao" class="form-select" multiple>
                    {% for e in extracoes %}<option value="{{ e.extracao }}">{{ e.extracao }}</option>{% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <button type="button" class="botao-estiloso mt-4" onclick="adicionarLinha()">‚ûï Adicionar</button>
            </div>
        </div>

        <div class="row my-4">
            <div class="col-md-6">
                <input type="text" id="buscaNome" class="form-control" placeholder="üîé Digite a √°rea para buscar" />
            </div>
            <div class="col-md-6">
                <button type="submit" class="botao-salvar">üíæ Salvar</button>
                <a href="{{ url_for('Home.home') }}" class="botao-voltar">‚ùå Sair</a>
            </div>
        </div>
    </form>

    <table class="table table-bordered table-striped" id="tabela">
        <thead class="table-success">
            <tr>
                <th>#</th>
                <th>√Årea</th>
                <th>Modalidade</th>
                <th>Comiss√£o</th>
                <th>Ativar</th>
                <th>Vendedor</th>
                <th>Extra√ß√£o</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
            {% for c in comissao_area %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ c.area }}</td>
                    <td>{{ c.modalidade }}</td>
                    <td>{{ c.comissao }}</td>
                    <td>{{ c.ativar }}</td>
                    <td>{{ c.vendedor if c.vendedor is not none else '' }}</td>
                    <td>{{ c.extracao if c.extracao is not none else '' }}</td>
                    <td>
                        <button type="button" class="botao-estiloso" onclick="editarLinha(this)">‚úèÔ∏è Editar</button>
                        <button type="button" class="botao-salvar" onclick="excluirLinha(this)">üóëÔ∏è Excluir</button>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

    <script>
        const AREAS = {{ areas|map(attribute='regiao_area')|list|tojson|safe }};
        const MODALIDADES = {{ modalidades|map(attribute='modalidade')|list|tojson|safe }};
        const VENDEDORES = {{ vendedores|map(attribute='nome')|list|tojson|safe }};
        const EXTRACOES = {{ extracoes|map(attribute='extracao')|list|tojson|safe }};
        let contador = parseInt("{{ comissao_area|length + 1 }}");

        // Inicializa Choices.js para os seletores
        const areaSelect = document.getElementById('area');
        const modalidadeSelect = document.getElementById('modalidade');
        const vendedorSelect = document.getElementById('vendedor');
        const extracaoSelect = document.getElementById('extracao');

        const escolhaArea = new Choices(areaSelect, { removeItemButton: true, searchEnabled: true, shouldSort: false });
        const escolhaModalidade = new Choices(modalidadeSelect, { removeItemButton: true, searchEnabled: true, shouldSort: false });
        const escolhaVendedor = new Choices(vendedorSelect, { removeItemButton: true, searchEnabled: true, shouldSort: false });
        const escolhaExtracao = new Choices(extracaoSelect, { removeItemButton: true, searchEnabled: true, shouldSort: false });

        function adicionarLinha() {
            // Obter valores dos seletores m√∫ltiplos
            const areasSelecionadas = escolhaArea.getValue(true);
            const modalidadesSelecionadas = escolhaModalidade.getValue(true);
            const comissao = document.getElementById('comissao').value;
            const ativar = document.getElementById('ativar').value;
            const vendedoresSelecionados = escolhaVendedor.getValue(true);
            const extracoesSelecionadas = escolhaExtracao.getValue(true);

            // Juntar os valores em strings separadas por v√≠rgula
            const areaTexto = areasSelecionadas.join(', ');
            const modalidadeTexto = modalidadesSelecionadas.join(', ');
            const vendedorTexto = vendedoresSelecionados.join(', ');
            const extracaoTexto = extracoesSelecionadas.join(', ');

            if (areasSelecionadas.length === 0 || modalidadesSelecionadas.length === 0 || !comissao || !ativar) {
                alert('Preencha os campos obrigat√≥rios (√Årea, Modalidade, Comiss√£o, Ativar)!');
                return;
            }

            const tbody = document.querySelector('#tabela tbody');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${contador}</td>
                <td>${areaTexto}</td>
                <td>${modalidadeTexto}</td>
                <td>${comissao}</td>
                <td>${ativar}</td>
                <td>${vendedorTexto}</td>
                <td>${extracaoTexto}</td>
                <td>
                    <button type="button" class="botao-estiloso" onclick="editarLinha(this)">‚úèÔ∏è Editar</button>
                    <button type="button" class="botao-salvar" onclick="excluirLinha(this)">üóëÔ∏è Excluir</button>
                </td>
            `;
            tbody.appendChild(tr);
            contador++;

            // Limpar os campos do formul√°rio e resetar os multiselects
            escolhaArea.clearStore();
            escolhaModalidade.clearStore();
            document.getElementById('comissao').value = '';
            document.getElementById('ativar').value = '';
            escolhaVendedor.clearStore();
            escolhaExtracao.clearStore();
        }

        function editarLinha(btn) {
            const tr = btn.closest('tr');
            const tds = tr.querySelectorAll('td');
            const areaAtual = tds[1].textContent.trim();
            const modalidadeAtual = tds[2].textContent.trim();
            const comissaoAtual = tds[3].textContent.trim();
            const ativarAtual = tds[4].textContent.trim();
            const vendedorAtual = tds[5].textContent.trim();
            const extracaoAtual = tds[6].textContent.trim();

            tr.dataset.original = JSON.stringify({ 
                area: areaAtual, 
                modalidade: modalidadeAtual, 
                comissao: comissaoAtual, 
                ativar: ativarAtual,
                vendedor: vendedorAtual,
                extracao: extracaoAtual
            });

            // √Årea (multiselect com Choice.js)
            const selectArea = document.createElement('select');
            selectArea.className = 'form-select';
            selectArea.setAttribute('multiple', 'multiple');
            AREAS.forEach(a => {
                const selected = areaAtual.split(', ').includes(a);
                const opt = new Option(a, a, selected, selected);
                selectArea.appendChild(opt);
            });
            tds[1].innerHTML = '';
            tds[1].appendChild(selectArea);
            new Choices(selectArea, { removeItemButton: true, searchEnabled: true });

            // Modalidade (multiselect com Choice.js)
            const selectMod = document.createElement('select');
            selectMod.className = 'form-select';
            selectMod.setAttribute('multiple', 'multiple');
            MODALIDADES.forEach(m => {
                const selected = modalidadeAtual.split(', ').includes(m);
                const opt = new Option(m, m, selected, selected);
                selectMod.appendChild(opt);
            });
            tds[2].innerHTML = '';
            tds[2].appendChild(selectMod);
            new Choices(selectMod, { removeItemButton: true, searchEnabled: true });

            // Comiss√£o (input number)
            tds[3].innerHTML = `<input type="number" class="form-control" value="${comissaoAtual}"/>`;

            // Ativar (select simples)
            const selectAtivar = document.createElement('select');
            selectAtivar.className = 'form-select';
            selectAtivar.innerHTML = `
                <option value="sim" ${ativarAtual === 'sim' ? 'selected' : ''}>Sim</option>
                <option value="nao" ${ativarAtual === 'nao' ? 'selected' : ''}>N√£o</option>`;
            tds[4].innerHTML = '';
            tds[4].appendChild(selectAtivar);

            // Vendedor (multiselect com Choice.js)
            const selectVendedor = document.createElement('select');
            selectVendedor.className = 'form-select';
            selectVendedor.setAttribute('multiple', 'multiple');
            VENDEDORES.forEach(v => {
                const selected = vendedorAtual.split(', ').includes(v);
                const opt = new Option(v, v, selected, selected);
                selectVendedor.appendChild(opt);
            });
            tds[5].innerHTML = '';
            tds[5].appendChild(selectVendedor);
            new Choices(selectVendedor, { removeItemButton: true, searchEnabled: true });

            // Extra√ß√£o (multiselect com Choice.js)
            const selectExtracao = document.createElement('select');
            selectExtracao.className = 'form-select';
            selectExtracao.setAttribute('multiple', 'multiple');
            EXTRACOES.forEach(e => {
                const selected = extracaoAtual.split(', ').includes(e);
                const opt = new Option(e, e, selected, selected);
                selectExtracao.appendChild(opt);
            });
            tds[6].innerHTML = '';
            tds[6].appendChild(selectExtracao);
            new Choices(selectExtracao, { removeItemButton: true, searchEnabled: true });

            // Bot√µes salvar e cancelar
            tds[7].innerHTML = `
                <button type="button" class="botao-voltar" onclick="salvarEdicao(this)">üíæ Salvar</button>
                <button type="button" class="botao-salvar" onclick="cancelarEdicao(this)">‚ùå Cancelar</button>`;
        }

        function salvarEdicao(btn) {
            const tr = btn.closest('tr');
            const tds = tr.querySelectorAll('td');

            // Get selected values from the Choices.js instances in the table
            const areaSelect = tds[1].querySelector('select');
            const escolhaAreaEdicao = new Choices(areaSelect, { silent: true });
            const area = escolhaAreaEdicao.getValue(true).join(', ');

            const modalidadeSelect = tds[2].querySelector('select');
            const escolhaModalidadeEdicao = new Choices(modalidadeSelect, { silent: true });
            const modalidade = escolhaModalidadeEdicao.getValue(true).join(', ');

            const comissao = tds[3].querySelector('input').value;
            const ativar = tds[4].querySelector('select').value;
            
            const vendedorSelect = tds[5].querySelector('select');
            const escolhaVendedorEdicao = new Choices(vendedorSelect, { silent: true });
            const vendedor = escolhaVendedorEdicao.getValue(true).join(', ');

            const extracaoSelect = tds[6].querySelector('select');
            const escolhaExtracaoEdicao = new Choices(extracaoSelect, { silent: true });
            const extracao = escolhaExtracaoEdicao.getValue(true).join(', ');
            
            // NOTE: The fetch call on the server side needs to be updated to handle multiple values
            // The provided Flask code will likely not work as-is with multiple selections.
            fetch('/area-comissao/editar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ area, modalidade, comissao, ativar, vendedor, extracao })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    tds[1].textContent = area;
                    tds[2].textContent = modalidade;
                    tds[3].textContent = comissao;
                    tds[4].textContent = ativar;
                    tds[5].textContent = vendedor;
                    tds[6].textContent = extracao;
                    tds[7].innerHTML = `
                        <button type="button" class="botao-estiloso" onclick="editarLinha(this)">‚úèÔ∏è Editar</button>
                        <button type="button" class="botao-salvar" onclick="excluirLinha(this)">üóëÔ∏è Excluir</button>`;
                } else {
                    alert(data.message || 'Erro ao salvar');
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('Erro ao salvar edi√ß√£o.');
            });
        }

        function cancelarEdicao(btn) {
            const tr = btn.closest('tr');
            const tds = tr.querySelectorAll('td');
            const original = JSON.parse(tr.dataset.original);
            tds[1].textContent = original.area;
            tds[2].textContent = original.modalidade;
            tds[3].textContent = original.comissao;
            tds[4].textContent = original.ativar;
            tds[5].textContent = original.vendedor;
            tds[6].textContent = original.extracao;
            tds[7].innerHTML = `
                <button type="button" class="botao-estiloso" onclick="editarLinha(this)">‚úèÔ∏è Editar</button>
                <button type="button" class="botao-salvar" onclick="excluirLinha(this)">üóëÔ∏è Excluir</button>`;
        }

        function excluirLinha(btn) {
            const tr = btn.closest('tr');
            const tds = tr.querySelectorAll('td');
            const area = tds[1].textContent;
            const modalidade = tds[2].textContent;

            if (confirm(`Deseja excluir a comiss√£o da √°rea "${area}" e modalidade "${modalidade}"?`)) {
                fetch('/area-comissao/excluir', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ area, modalidade })
                })
                .then(res => res.json())
                .then(data => {
                    alert(data.message);
                    if (data.success) tr.remove();
                })
                .catch(() => alert('Erro ao excluir.'));
            }
        }

        document.getElementById('formComissao').addEventListener('submit', function (e) {
            e.preventDefault();
            const linhas = [];
            document.querySelectorAll('#tabela tbody tr').forEach(tr => {
                const tds = tr.querySelectorAll('td');
                linhas.push({
                    area: tds[1].textContent,
                    modalidade: tds[2].textContent,
                    comissao: tds[3].textContent,
                    ativar: tds[4].textContent,
                    vendedor: tds[5].textContent,
                    extracao: tds[6].textContent
                });
            });

            fetch('/area-comissao/salvar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dados: linhas })
            })
            .then(res => res.json())
            .then(data => alert(data.message || 'Salvo com sucesso'))
            .catch((error) => {
                console.error('Error:', error);
                alert('Erro ao salvar.');
            });
        });

        document.getElementById('buscaNome').addEventListener('keyup', function() {
            const filter = this.value.toLowerCase();
            const rows = document.querySelectorAll('#tabela tbody tr');
            rows.forEach(row => {
                const areaCell = row.querySelectorAll('td')[1];
                if (areaCell) {
                    const areaText = areaCell.textContent.toLowerCase();
                    row.style.display = areaText.includes(filter) ? '' : 'none';
                }
            });
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>