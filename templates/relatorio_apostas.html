<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Relatório Financeiro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* (Seus estilos CSS permanecem os mesmos) */
        body {
            font-family: 'Roboto', sans-serif;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .table tbody tr:nth-child(odd) {
            background-color: #ffffff;
        }
        .table tbody tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .table-light-green thead {
            background-color: #d4edda;
            color: #155724;
            border-bottom: 2px solid #28a745;
        }
        .table-light-green th {
            padding: 0.75rem 1rem;
        }
        .form-control, .form-select {
            border-radius: 0.35rem;
            border: 1px solid #ced4da;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        .botao-estiloso {
            font-size: 1rem;
            color: white;
            border-radius: 0.35rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            vertical-align: middle;
            text-decoration: none;
            background-color: #072749;
        }
        .botao-estiloso:hover {
            background-color: #0056b3;
            box-shadow: 0 6px 18px rgba(0,0,0,0.2);
            transform: translateY(-2px);
        }
        .summary-info {
            font-size: 1.25em;
            margin-bottom: 10px;
            padding: 5px 0;
        }
        .summary-info strong {
            color: #072749;
        }
        .negative-value {
            color: #dc3545;
            font-weight: 600;
        }
        .positive-value {
            color: #28a745;
            font-weight: 600;
        }
        .table {
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
        }
        .table thead th {
            border-bottom: none;
        }
        .table td, .table th {
            padding: 0.8rem;
            vertical-align: middle;
            border-top: 1px solid #dee2e6;
        }
        @media print {
            body { 
                padding: 0; 
                margin: 0; 
                font-family: 'Roboto', sans-serif; 
                background-color: #ffffff !important;
                color: #000;
            }
            .container { 
                width: 100%; 
                margin: 0; 
                padding: 20px; 
            }
            .no-print { 
                display: none !important; 
            }
            .print-only { 
                display: block !important; 
            }
            .print-only h1 { 
                text-align: center; 
                margin-bottom: 20px; 
                color: #072749; 
                font-size: 2em; 
            }
            .print-only .print-details p, 
            .print-only .print-summary p { 
                margin-bottom: 8px; 
                font-size: 1.25em; 
            }
            .print-only .print-details strong, 
            .print-only .print-summary strong { 
                color: #072749; 
            }
            .print-only .print-summary { 
                margin-top: 30px; 
                border-top: 1px solid #ccc; 
                padding-top: 20px; 
            }
            .negative-value { 
                color: #dc3545; 
                font-weight: 600; 
            }
            .positive-value { 
                color: #28a745; 
                font-weight: 600; 
            }
            .table {
                border-collapse: collapse;
                width: 100%;
                margin-bottom: 1rem;
                background-color: transparent;
                box-shadow: none;
            }
            .table thead th {
                background-color: #d4edda !important;
                color: #155724 !important;
                border-bottom: 2px solid #28a745 !important;
                font-weight: bold;
            }
            .table tbody tr:nth-child(odd) {
                background-color: #f2f2f2 !important;
            }
            .table tbody tr:nth-child(even) {
                background-color: #ffffff !important;
            }
            .table td, .table th {
                padding: 0.75rem;
                vertical-align: top;
                border-top: 1px solid #dee2e6;
                color: #000;
            }
            .table-bordered th, .table-bordered td {
                border: 1px solid #dee2e6 !important;
            }
            .table thead th {
                font-size: 10px; 
                padding: 4px; 
                text-align: center;
                white-space: nowrap; 
            }
            .table td { 
                padding: 4px;
                border: 1px solid #dee2e6;
                font-size: 12px;
                white-space: nowrap;
                text-align: center;
            }

            .table.table-bordered {
                width: 100%;
                table-layout: auto;
            }
            .table td:nth-child(1), .table th:nth-child(1) { 
                text-align: left;
                width: 15%;
            }
            .table td:nth-child(2), .table th:nth-child(2) { 
                width: 10%;
            }
            .table td:nth-child(3), .table th:nth-child(3), 
            .table td:nth-child(4), .table th:nth-child(4), 
            .table td:nth-child(5), .table th:nth-child(5) { 
                width: 15%;
            }
        }
    </style>
</head>
<body class="bg-light p-4">
    <div class="container mt-4 no-print">
        <h3 class="mb-4">Relatório</h3>

        <div class="row mb-3 g-3">
            <div class="col-md-3">
                <label for="selectVendedor" class="form-label">Vendedor:</label>
                <select id="selectVendedor" class="form-select">
                    <option value="">Todos os Vendedores</option>
                    {% for vendedor in vendedores %}
                        <option value="{{ vendedor }}">{{ vendedor }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="selectModalidade" class="form-label">Modalidade:</label>
                <select id="selectModalidade" class="form-select">
                    <option value="">Todas as Modalidades</option>
                    {% for modalidade in modalidades %}
                        <option value="{{ modalidade }}">{{ modalidade }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="selectExtracao" class="form-label">Extração:</label>
                <select id="selectExtracao" class="form-select">
                    <option value="">Todas as Extrações</option>
                    {% for extracao in extracoes %}
                        <option value="{{ extracao }}">{{ extracao }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="selectArea" class="form-label">Área:</label>
                <select id="selectArea" class="form-select">
                    <option value="">Todas as Áreas</option>
                    {% for area in areas %}
                        <option value="{{ area }}">{{ area }}</option>
                    {% endfor %}
                </select>
            </div>
             <div class="col-md-3">
                <label for="comissaoRetida" class="form-label">Comissão Retida:</label>
                <select id="comissaoRetida" class="form-select">
                    <option value="">Todas</option>
                    <option value="Sim">Sim</option>
                    <option value="Não">Não</option>
                </select>
            </div>
        </div>
        <div class="row mb-4 align-items-end">
            <div class="col-md-3">
                <label for="filterDate" class="form-label">Data:</label>
                <input type="date" id="filterDate" class="form-control">
            </div>
            <div class="col-md-auto">
                <button type="button" class="btn botao-estiloso" onclick="fetchAndRenderData()">Filtrar</button>
            </div>
        </div>
        
        <h3 class="mb-4 mt-5">Geral Caixa</h3>
        <table id="tabela-resumo" class="table table-bordered table-hover bg-white table-light-green">
            <thead>
                <tr>
                    <th>Vendedor</th>
                    <th>Área</th>
                    <th>Apurado</th>
                    <th>Comissão</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="5" class="text-center">Selecione os filtros e clique em "Filtrar" para ver os dados.</td>
                </tr>
            </tbody>
        </table>

        <h3 class="mb-4 mt-5">Todas as apostas</h3>
        <table class="table table-bordered table-hover bg-white table-light-green" id="apostasTable">
            <thead>
                <tr>
                    <th>Bilhete</th>
                    <th>Data</th>
                    <th>Vendedor</th>
                    <th>Extração</th>
                    <th>Área</th>
                    <th>Modalidade</th>
                    <th>Números</th>
                    <th>Prêmio (Tipo)</th>
                    <th>Valor Apostado (Individual)</th>
                    <th>Unidade Aposta</th>
                    <th>Comissão (%)</th>
                    <th>Valor Comissão</th>
                </tr>
            </thead>
            <tbody id="apostasTableBody">
                <tr>
                    <td colspan="12" class="text-center">Selecione os filtros e clique em "Filtrar" para ver os dados.</td>
                </tr>
            </tbody>
        </table>

        <hr>

        <h3 class="mb-4 mt-5">Apostas Premiadas</h3>
        <table class="table table-bordered table-hover bg-white table-light-green" id="apostasPremiadasTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Bilhete #</th>
                    <th>Data</th>
                    <th>Hora</th>
                    <th>Vendedor</th>
                    <th>Extração</th>
                    <th>Área</th>
                    <th>Valor Prêmio</th>
                    <th>Impresso</th>
                    <th>Pago</th>
                </tr>
            </thead>
            <tbody id="apostasPremiadasTableBody">
                <tr>
                    <td colspan="10" class="text-center">Selecione os filtros e clique em "Filtrar" para ver os dados.</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="print-only">
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const debitoAnteriorValue = {{ debito_anterior | tojson }};

        function normalizeString(str) {
            if (str === null || typeof str === 'undefined') {
                return '';
            }
            return String(str).normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim();
        }

        function parseCurrencyToFloat(currencyStr) {
            if (currencyStr === null || typeof currencyStr === 'undefined') {
                return 0.0;
            }
            const cleanedStr = String(currencyStr).replace('R$', '').trim().replace(',', '.');
            const parsed = parseFloat(cleanedStr);
            return isNaN(parsed) ? 0.0 : parsed;
        }

        async function fetchAndRenderData() {
            const selectedVendedor = document.getElementById('selectVendedor').value;
            const selectedModalidade = document.getElementById('selectModalidade').value;
            const selectedExtracao = document.getElementById('selectExtracao').value;
            const selectedArea = document.getElementById('selectArea').value;
            const selectedComissaoRetida = document.getElementById('comissaoRetida').value; // NOVO CAMPO
            const selectedDate = document.getElementById('filterDate').value;
            
            // Coloca as tabelas no estado de "carregando"
            const apostasTableBody = document.getElementById('apostasTableBody');
            const apostasPremiadasTableBody = document.getElementById('apostasPremiadasTableBody');
            const tabelaResumoBody = document.querySelector('#tabela-resumo tbody');
            
            apostasTableBody.innerHTML = '<tr><td colspan="12" class="text-center">Carregando...</td></tr>';
            apostasPremiadasTableBody.innerHTML = '<tr><td colspan="10" class="text-center">Carregando...</td></tr>';
            tabelaResumoBody.innerHTML = '<tr><td colspan="5" class="text-center">Carregando...</td></tr>';
            
            try {
                const response = await fetch('/aposta/api/relatorio-caixa-dados', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        vendedor: selectedVendedor,
                        modalidade: selectedModalidade,
                        extracao: selectedExtracao,
                        area: selectedArea,
                        comissao_retida: selectedComissaoRetida, // ADICIONA O NOVO CAMPO NO REQUEST
                        data: selectedDate
                    })
                });

                if (!response.ok) {
                    throw new Error('Erro ao buscar os dados do relatório.');
                }

                const data = await response.json();
                
                renderApostasTable(data.apostas_detalhadas);
                renderApostasPremiadasTable(data.apostas_premiadas);
                renderResumoTable(data.apostas_detalhadas, data.apostas_premiadas);
                
            } catch (error) {
                console.error('Erro:', error);
                apostasTableBody.innerHTML = '<tr><td colspan="12" class="text-center">Erro ao carregar os dados.</td></tr>';
                apostasPremiadasTableBody.innerHTML = '<tr><td colspan="10" class="text-center">Erro ao carregar os dados.</td></tr>';
                tabelaResumoBody.innerHTML = '<tr><td colspan="5" class="text-center">Erro ao carregar os dados.</td></tr>';
            }
        }
        
        function renderApostasTable(apostas) {
            const apostasTableBody = document.getElementById('apostasTableBody');
            apostasTableBody.innerHTML = '';
            
            if (apostas.length === 0) {
                apostasTableBody.innerHTML = '<tr><td colspan="12" class="text-center">Nenhuma aposta encontrada.</td></tr>';
                return;
            }
            
            apostas.forEach(aposta => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>#${aposta.bilhete_id}</td>
                    <td>${aposta.data_aposta}</td>
                    <td>${aposta.vendedor}</td>
                    <td>${aposta.extracao}</td>
                    <td>${aposta.area}</td>
                    <td>${aposta.modalidade}</td>
                    <td>${aposta.numeros}</td>
                    <td>${aposta.premio_str}</td>
                    <td>R$ ${aposta.valor_apostado_individual.toFixed(2).replace('.', ',')}</td>
                    <td>${aposta.unidade_aposta.toFixed(2).replace('.', ',')}</td>
                    <td>${aposta.comissao_percentual.toFixed(2).replace('.', ',')}%</td>
                    <td>R$ ${aposta.valor_comissao.toFixed(2).replace('.', ',')}</td>
                `;
                apostasTableBody.appendChild(row);
            });
        }
        
        function renderApostasPremiadasTable(premiadas) {
            const apostasPremiadasTableBody = document.getElementById('apostasPremiadasTableBody');
            apostasPremiadasTableBody.innerHTML = '';
            
            if (premiadas.length === 0) {
                apostasPremiadasTableBody.innerHTML = '<tr><td colspan="10" class="text-center">Nenhuma aposta premiada encontrada.</td></tr>';
                return;
            }
            
            premiadas.forEach(premiada => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${premiada.id}</td>
                    <td>#${premiada.numero_bilhete}</td>
                    <td>${premiada.data_atual}</td>
                    <td>${premiada.hora_atual}</td>
                    <td>${premiada.vendedor}</td>
                    <td>${premiada.extracao}</td>
                    <td>${premiada.area}</td>
                    <td>R$ ${premiada.valor_premio.replace('.', ',')}</td>
                    <td>${premiada.impresso == 1 ? 'Sim' : 'Não'}</td>
                    <td>${premiada.pago == 1 ? 'Sim' : 'Não'}</td>
                `;
                apostasPremiadasTableBody.appendChild(row);
            });
        }
        
        function renderResumoTable(apostas, premiadas) {
            const tabelaResumoBody = document.querySelector('#tabela-resumo tbody');
            tabelaResumoBody.innerHTML = '';
            
            const resumoVendedores = {};
            const resumoPremios = {};

            apostas.forEach(aposta => {
                const vendedor = normalizeString(aposta.vendedor);
                if (!resumoVendedores[vendedor]) {
                    resumoVendedores[vendedor] = { apurado: 0, comissao: 0, area: aposta.area };
                }
                resumoVendedores[vendedor].apurado += aposta.valor_apostado_individual;
                resumoVendedores[vendedor].comissao += aposta.valor_comissao;
            });

            premiadas.forEach(premiada => {
                const vendedor = normalizeString(premiada.vendedor);
                if (premiada.pago == 1) {
                    if (!resumoPremios[vendedor]) {
                        resumoPremios[vendedor] = 0;
                    }
                    resumoPremios[vendedor] += parseCurrencyToFloat(premiada.valor_premio);
                }
            });

            const allVendedores = new Set([...Object.keys(resumoVendedores), ...Object.keys(resumoPremios)]);

            if (allVendedores.size === 0) {
                tabelaResumoBody.innerHTML = '<tr><td colspan="5" class="text-center">Nenhum dado encontrado para os filtros aplicados.</td></tr>';
            } else {
                for (const vendedor of allVendedores) {
                    const dadosAposta = resumoVendedores[vendedor] || { apurado: 0, comissao: 0, area: 'N/A' };
                    const premioPago = resumoPremios[vendedor] || 0;

                    const apurado = dadosAposta.apurado;
                    const comissao = dadosAposta.comissao;
                    const area = dadosAposta.area;
                    const total = apurado - comissao - premioPago;
                    
                    const newRow = tabelaResumoBody.insertRow();
                    newRow.innerHTML = `
                        <td>${vendedor}</td>
                        <td>${area}</td>
                        <td>R$ ${apurado.toFixed(2).replace('.', ',')}</td>
                        <td>R$ ${comissao.toFixed(2).replace('.', ',')}</td>
                        <td>R$ ${total.toFixed(2).replace('.', ',')}</td>
                    `;
                }
            }
        }
        
        function printReport() {
            // (Esta função pode permanecer a mesma, mas agora ela vai pegar os dados das tabelas já renderizadas no DOM)
            // Lógica de impressão...
            const selectedDateText = document.getElementById('filterDate').value ? new Date(document.getElementById('filterDate').value + 'T12:00:00').toLocaleDateString('pt-BR') : 'Todo o período';
            const selectedVendedorText = document.getElementById('selectVendedor').options[document.getElementById('selectVendedor').selectedIndex].text;
            const selectedModalidadeText = document.getElementById('selectModalidade').options[document.getElementById('selectModalidade').selectedIndex].text;
            const selectedExtracaoText = document.getElementById('selectExtracao').options[document.getElementById('selectExtracao').selectedIndex].text;
            const selectedAreaText = document.getElementById('selectArea').options[document.getElementById('selectArea').selectedIndex].text;

            const resumoTable = document.getElementById('tabela-resumo').cloneNode(true);
            
            resumoTable.querySelector('thead tr').innerHTML = `
                <th>Vendedor</th>
                <th>Área</th>
                <th>Apurado</th>
                <th>Comissão</th>
                <th>Total</th>
            `;

            const printContent = `
                <div class="container print-only">
                    <h1 class="text-center mb-4">Relatório Financeiro</h1>
                    <div class="print-details mb-4">
                        <p><strong>Data:</strong> ${selectedDateText}</p>
                        <p><strong>Vendedor:</strong> ${selectedVendedorText}</p>
                        <p><strong>Extração:</strong> ${selectedExtracaoText}</p>
                        <p><strong>Modalidade:</strong> ${selectedModalidadeText}</p>
                        <p><strong>Área:</strong> ${selectedAreaText}</p>
                    </div>
                    
                    <h2>Geral Caixa</h2>
                    ${resumoTable.outerHTML}
                </div>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="pt-br">
                <head>
                    <title>Relatório Financeiro</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
                    <style>
                        /* (Seus estilos de impressão aqui) */
                        body { font-family: 'Roboto', sans-serif; padding: 20px; }
                        h1, h2 { text-align: center; margin-bottom: 20px; color: #072749; }
                        .print-details p { margin-bottom: 8px; }
                        .print-details strong { color: #072749; }
                        .table { margin-bottom: 20px; border-collapse: collapse; width: 100%; }
                        .table thead th { 
                            background-color: #d4edda !important; 
                            color: #155724 !important;
                            font-size: 10px; 
                            padding: 4px; 
                            text-align: center;
                            white-space: nowrap; 
                        }
                        .table tbody tr:nth-child(odd) { background-color: #ffffff !important; }
                        .table tbody tr:nth-child(even) { background-color: #f2f2f2 !important; }
                        .table td { 
                            padding: 4px;
                            border: 1px solid #dee2e6;
                            font-size: 12px;
                            white-space: nowrap;
                            text-align: center;
                        }

                        .table.table-bordered {
                            width: 100%;
                            table-layout: auto;
                        }
                        .table td:nth-child(1), .table th:nth-child(1) { 
                            text-align: left;
                            width: 15%;
                        }
                        .table td:nth-child(2), .table th:nth-child(2) { 
                            width: 10%;
                        }
                        .table td:nth-child(3), .table th:nth-child(3), 
                        .table td:nth-child(4), .table th:nth-child(4), 
                        .table td:nth-child(5), .table th:nth-child(5) { 
                            width: 15%;
                        }
                    </style>
                </head>
                <body>
                    ${printContent}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }
    </script>
</body>
</html>