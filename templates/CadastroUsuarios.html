<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cadastro de Usu√°rios</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <style>
    .botao-estiloso, .botao-voltar, .botao-salvar {
      font-size: 18px;
      color: white;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      border: none;
      padding: 6px 20px;
      cursor: pointer;
    }
    .botao-estiloso { background-color: #072749; }
    .botao-voltar { background-color: #1fa53c; }
    .botao-salvar { background-color: #be0d0d; }
    .botao-estiloso:hover { background-color: #0056b3; }
    .botao-voltar:hover { background-color: #128d2e; }
    .botao-salvar:hover { background-color: #ec5050; }
    .botao-estiloso::after, .botao-voltar::after, .botao-salvar::after {
      content: "";
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.2);
      transform: skewX(-20deg);
      transition: left 0.5s ease;
    }
    .botao-estiloso:hover::after,
    .botao-voltar:hover::after,
    .botao-salvar:hover::after {
      left: 100%;
    }
    tbody > tr:nth-child(odd) {
      background-color: #f2f2f2;
    }
  </style>
</head>
<body class="p-4">
<div class="container">
  <h2 class="mb-4">Cadastro de Usu√°rios</h2>

  <form id="form-usuario">
    <div class="row g-3 mb-3">
      <div class="col-md-4">
        <label for="login" class="form-label">Login:</label>
        <input type="text" id="login" class="form-control" />
      </div>
      <div class="col-md-4">
        <label for="senha" class="form-label">Senha:</label>
        <input type="text" id="senha" class="form-control" />
      </div>
      <div class="col-md-4">
        <label for="ativo" class="form-label">Ativo:</label>
        <select id="ativo" class="form-select">
          <option value="Sim">Sim</option>
          <option value="N√£o">N√£o</option>
        </select>
      </div>
      <div class="col-12">
        <label for="permissoes" class="form-label">Permiss√µes:</label>
        <select id="permissoes" class="form-select" multiple>
          <option value="usuario">Usu√°rio</option>
          <option value="modalidade">Modalidade</option>
          <option value="regiao">Regi√£o</option>
          <option value="extracao">Extra√ß√£o</option>
          <option value="area extracao">√Årea Extra√ß√£o</option>
          <option value="area cotacao">√Årea Cota√ß√£o</option>
          <option value="area comissao modalidade">Comiss√£o Modalidade</option>
          <option value="coletor">Coletor</option>
          <option value="vendedor">Vendedor</option>
          <option value="vendas por periodo operador">Vendas por Per√≠odo Operador</option>
          <option value="relatorio geral de vendas">Geral Vendas</option>
          <option value="numeros cotados">N√∫meros Cotados</option>
          <option value="programacao extracao">Programa√ß√£o Extra√ß√£o</option>
          <option value="descarrego">Descarrego</option>
          <option value="cancelamento fora do horario">Cancelamento Fora do Hor√°rio</option>
          <option value="administracao">Administra√ß√£o</option>
          <option value="area">√Årea</option>
        </select>
      </div>
    </div>
    <div class="d-flex flex-wrap gap-2 mb-3">
      <button type="button" class="botao-estiloso" onclick="adicionarUsuario()">Adicionar</button>
      <input type="text" id="busca" placeholder="Buscar usu√°rio" class="form-control w-auto" />
      <button type="button" class="botao-estiloso" onclick="buscarUsuario()">Buscar</button>
      <button type="button" class="botao-voltar" onclick="salvarUsuarios()">Salvar</button>
      <a href="{{ url_for('Home.home') }}" class="btn botao-salvar">Sair</a>
    </div>
  </form>

  <table class="table table-bordered table-striped">
    <thead class="table-success">
      <tr>
        <th>Login</th>
        <th>Senha</th>
        <th>Permiss√µes</th>
        <th>Ativo</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody id="tabela-usuario">
      {% if usuarios_permissoes %}
        {% for u in usuarios_permissoes %}
          <tr>
            <td>{{ u.username }}</td>
            <td>{{ u.senha }}</td>
            <td>{{ u.permissoes }}</td>
            <td>{{ "Sim" if u.ativo else "N√£o" }}</td>
            <td>
              <button type="button" class="botao-estiloso" onclick="editarLinha(this)">‚úèÔ∏è Editar</button>
              <button type="button" class="botao-salvar" onclick="excluirUsuario(this, '{{ u.username }}')">üóëÔ∏è Excluir</button>
            </td>
          </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="5" class="text-center">Nenhum usu√°rio cadastrado.</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script>
  const choices = new Choices('#permissoes', { removeItemButton: true });

  function adicionarUsuario() {
    const login = document.getElementById("login").value;
    const senha = document.getElementById("senha").value;
    const ativo = document.getElementById("ativo").value;
    const permissoes = choices.getValue(true).join(", ");

    if (!login || !senha || !permissoes || !ativo) {
      alert("Preencha todos os campos.");
      return;
    }

    const tbody = document.getElementById("tabela-usuario");
    const novaLinha = document.createElement("tr");

    novaLinha.innerHTML = `
      <td>${login}</td>
      <td>${senha}</td>
      <td>${permissoes}</td>
      <td>${ativo}</td>
      <td>
        <button class="botao-estiloso" onclick="editarLinha(this)">‚úèÔ∏è Editar</button>
        <button class="botao-salvar" onclick="excluirUsuario(this, '${login}')">üóëÔ∏è Excluir</button>
      </td>
    `;

    tbody.appendChild(novaLinha);
    document.getElementById("form-usuario").reset();
    choices.clearStore();
  }

  function editarLinha(botao) {
    const linha = botao.closest("tr");
    const valores = Array.from(linha.children).slice(0, 4).map(td => td.textContent);

    linha.innerHTML = `
      <td><input class="form-control" value="${valores[0]}"></td>
      <td><input class="form-control" value="${valores[1]}"></td>
      <td><input class="form-control" value="${valores[2]}"></td>
      <td>
        <select class="form-select">
          <option value="Sim" ${valores[3] === "Sim" ? "selected" : ""}>Sim</option>
          <option value="N√£o" ${valores[3] === "N√£o" ? "selected" : ""}>N√£o</option>
        </select>
      </td>
      <td>
        <button class="botao-voltar" onclick="salvarEdicao(this)">üíæ Salvar</button>
        <button class="botao-salvar" onclick="cancelarEdicao(this, ${JSON.stringify(valores)})">‚ùå Cancelar</button>
      </td>
    `;
  }

  function salvarEdicao(botao) {
    const linha = botao.closest("tr");
    const inputs = linha.querySelectorAll("input");
    const select = linha.querySelector("select");

    const login = inputs[0].value;
    const senha = inputs[1].value;
    const permissoes = inputs[2].value;
    const ativo = select.value;

    linha.innerHTML = `
      <td>${login}</td>
      <td>${senha}</td>
      <td>${permissoes}</td>
      <td>${ativo}</td>
      <td>
        <button class="botao-estiloso" onclick="editarLinha(this)">‚úèÔ∏è Editar</button>
        <button class="botao-salvar" onclick="excluirUsuario(this, '${login}')">üóëÔ∏è Excluir</button>
      </td>
    `;
  }

  function cancelarEdicao(botao, valores) {
    const linha = botao.closest("tr");
    linha.innerHTML = `
      <td>${valores[0]}</td>
      <td>${valores[1]}</td>
      <td>${valores[2]}</td>
      <td>${valores[3]}</td>
      <td>
        <button class="botao-estiloso" onclick="editarLinha(this)">‚úèÔ∏è Editar</button>
        <button class="botao-salvar" onclick="excluirUsuario(this, '${valores[0]}')">üóëÔ∏è Excluir</button>
      </td>
    `;
  }

  function excluirUsuario(botao, login) {
  if (!confirm(`Deseja excluir o usu√°rio ${login}?`)) return;

  fetch(`/admin/${login}`, {
    method: "DELETE"
  })
  .then(res => res.json())
  .then(data => {
    if(data.success) {
      alert(data.message);
      botao.closest("tr").remove();
    } else {
      alert("Erro: " + data.message);
    }
  })
  .catch(err => alert("Erro: " + err.message));
}

  function buscarUsuario() {
    const termo = document.getElementById("busca").value.toLowerCase();
    const linhas = document.querySelectorAll("#tabela-usuario tr");

    linhas.forEach(linha => {
      const login = linha.cells[0]?.textContent?.toLowerCase();
      linha.style.display = login && login.includes(termo) ? "" : "none";
    });
  }

  function salvarUsuarios() {
  const linhas = document.querySelectorAll("#tabela-usuario tr");
  const usuarios = [];

  linhas.forEach(linha => {
    const colunas = linha.querySelectorAll("td");
    if (colunas.length < 5) return; // ignorar linha "Nenhum usu√°rio"

    usuarios.push({
      Username: colunas[0].textContent.trim(),
      Password: colunas[1].textContent.trim(),
      "Permiss√µes": colunas[2].textContent.trim(),
      Ativo: colunas[3].textContent.trim().toLowerCase() === "sim"
    });
  });

  fetch("/admin/", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(usuarios)
  })
  .then(res => res.json())
  .then(data => {
    if(data.success) {
      alert(data.message);
      // Pode opcionalmente atualizar a tabela, recarregar p√°gina etc
    } else {
      alert("Erro: " + data.message);
    }
  })
  .catch(err => alert("Erro: " + err.message));
}
</script>
</body>
</html>
