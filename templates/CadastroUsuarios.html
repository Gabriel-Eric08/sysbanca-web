<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cadastro de Usu√°rios</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <style>
    .botao-estiloso, .botao-voltar, .botao-salvar {
      font-size: 18px;
      color: white;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      border: none;
      padding: 6px 20px;
      cursor: pointer;
    }
    .botao-estiloso { background-color: #072749; }
    .botao-voltar { background-color: #1fa53c; }
    .botao-salvar { background-color: #be0d0d; }
    .botao-estiloso:hover { background-color: #0056b3; }
    .botao-voltar:hover { background-color: #128d2e; }
    .botao-salvar:hover { background-color: #ec5050; }
    .botao-estiloso::after, .botao-voltar::after, .botao-salvar::after {
      content: "";
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.2);
      transform: skewX(-20deg);
      transition: left 0.5s ease;
    }
    .botao-estiloso:hover::after,
    .botao-voltar:hover::after,
    .botao-salvar:hover::after {
      left: 100%;
    }
    tbody > tr:nth-child(odd) {
      background-color: #f2f2f2;
    }
  </style>
</head>
<body class="p-4">
<div class="container">
  <h2 class="mb-4">Cadastro de Usu√°rios</h2>

  <form id="form-usuario">
    <div class="row g-3 mb-3">
      <div class="col-md-4">
        <label for="login" class="form-label">Login:</label>
        <input type="text" id="login" class="form-control" />
      </div>
      <div class="col-md-4">
        <label for="senha" class="form-label">Senha:</label>
        <input type="text" id="senha" class="form-control" />
      </div>
      <div class="col-md-4">
        <label for="ativo" class="form-label">Ativo:</label>
        <select id="ativo" class="form-select">
          <option value="sim">Sim</option>
          <option value="nao">N√£o</option>
        </select>
      </div>
      <div class="col-12">
        <label for="permissoes" class="form-label">Permiss√µes:</label>
        <select id="permissoes" class="form-select" multiple>
          <option value="usuario">Usu√°rio</option>
          <option value="modalidade">Modalidade</option>
          <option value="regiao">Regi√£o</option>
          <option value="extracao">Extra√ß√£o</option>
          <option value="area extracao">√Årea Extra√ß√£o</option>
          <option value="area cotacao">√Årea Cota√ß√£o</option>
          <option value="area comissao modalidade">Comiss√£o Modalidade</option>
          <option value="coletor">Coletor</option>
          <option value="vendedor">Vendedor</option>
          <option value="vendas por periodo operador">Vendas por Per√≠odo Operador</option>
          <option value="relatorio geral de vendas">Geral Vendas</option>
          <option value="numeros cotados">N√∫meros Cotados</option>
          <option value="programacao extracao">Programa√ß√£o Extra√ß√£o</option>
          <option value="descarrego">Descarrego</option>
          <option value="cancelamento fora do horario">Cancelamento Fora do Hor√°rio</option>
          <option value="administracao">Administra√ß√£o</option>
          <option value="area">√Årea</option>
        </select>
      </div>
    </div>
    <div class="d-flex flex-wrap gap-2 mb-3">
      <button type="button" class="botao-estiloso" onclick="adicionarUsuario()">Adicionar</button>
      <input type="text" id="busca" placeholder="Buscar usu√°rio" class="form-control w-auto" />
      <button type="button" class="botao-estiloso" onclick="buscarUsuario()">Buscar</button>
      <button type="button" class="botao-voltar" onclick="prepararEnvioUsuario()">Salvar</button>
      <a href="#" class="btn botao-salvar">Sair</a>
    </div>
  </form>

  <table class="table table-bordered table-striped">
    <thead class="table-success">
      <tr>
        <th>Login</th>
        <th>Senha</th>
        <th>Permiss√µes</th>
        <th>Ativo</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody id="tabela-usuario">
      {% if usuarios_permissoes %}
        {% for u in usuarios_permissoes %}
          <tr>
            <td>{{ u.username }}</td>
            <td>{{ u.senha }}</td>
            <td>{{ u.permissoes }}</td>
            <td>{{ "Sim" if u.ativo else "N√£o" }}</td>
            <td>
              <button type="button" class="botao-estiloso" onclick="editarLinha(this)">‚úèÔ∏è Editar</button>
              <button type="button" class="botao-salvar" onclick="excluirUsuario(this, '{{ u.username }}')">üóëÔ∏è Excluir</button>
            </td>
          </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="5" class="text-center">Nenhum usu√°rio cadastrado.</td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script>
  const choices = new Choices('#permissoes', {
    removeItemButton: true,
    placeholderValue: 'Selecione as permiss√µes',
    searchEnabled: true
  });

  function adicionarUsuario() {
    const login = document.getElementById("login").value.trim();
    const senha = document.getElementById("senha").value.trim();
    const ativo = document.getElementById("ativo").value;
    const permissoes = choices.getValue(true);

    if (!login || !senha) {
      alert("Login e senha s√£o obrigat√≥rios!");
      return;
    }

    const tabela = document.getElementById("tabela-usuario");
    const novaLinha = tabela.insertRow();
    
    novaLinha.insertCell(0).textContent = login;
    novaLinha.insertCell(1).textContent = senha;
    novaLinha.insertCell(2).textContent = permissoes.join(", ");
    novaLinha.insertCell(3).textContent = ativo === "sim" ? "Sim" : "N√£o";
    
    const cellAcoes = novaLinha.insertCell(4);
    cellAcoes.innerHTML = `
      <button type="button" class="botao-estiloso" onclick="editarLinha(this)">‚úèÔ∏è Editar</button>
      <button type="button" class="botao-salvar" onclick="excluirUsuario(this, '${login}')">üóëÔ∏è Excluir</button>
    `;

    // Limpar campos
    document.getElementById("login").value = "";
    document.getElementById("senha").value = "";
    document.getElementById("ativo").value = "sim";
    choices.removeActiveItems();
  }

  function buscarUsuario() {
    const termo = document.getElementById("busca").value.toLowerCase();
    const linhas = document.querySelectorAll("#tabela-usuario tr");

    linhas.forEach(linha => {
      const login = linha.cells[0].textContent.toLowerCase();
      linha.style.display = login.includes(termo) ? "" : "none";
    });
  }

  function prepararEnvioUsuario() {
    const linhas = document.querySelectorAll("#tabela-usuario tr");
    if (linhas.length === 0 || (linhas.length === 1 && linhas[0].cells[0].textContent === "Nenhum usu√°rio cadastrado.")) {
      alert("N√£o h√° usu√°rios para salvar.");
      return;
    }

    const usuarios = Array.from(linhas).map(linha => {
      if (linha.cells[0].textContent === "Nenhum usu√°rio cadastrado.") return null;
      
      return {
        "Username": linha.cells[0].textContent.trim(),
        "Password": linha.cells[1].textContent.trim(),
        "Permiss√µes": linha.cells[2].textContent.trim(),
        "Ativo": linha.cells[3].textContent.trim() === "Sim"
      };
    }).filter(user => user !== null);

    fetch('/admin/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(usuarios)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert(`Sucesso: ${data.message}\nSalvos: ${data.salvos.join(', ')}\nIgnorados: ${data.ignorados.join(', ')}`);
      } else {
        alert(`Erro: ${data.message}`);
      }
    })
    .catch(error => {
      console.error("Erro:", error);
      alert("Erro ao comunicar com o servidor");
    });
  }

  function editarLinha(botao) {
    const linha = botao.closest('tr');
    const cells = linha.cells;
    
    // Transformar c√©lulas em edit√°veis
    cells[0].innerHTML = `<input type="text" value="${cells[0].textContent}" class="form-control">`;
    cells[1].innerHTML = `<input type="text" value="${cells[1].textContent}" class="form-control">`;
    
    // Atualizar bot√£o para "Salvar Edi√ß√£o"
    botao.textContent = "üíæ Salvar";
    botao.onclick = function() { salvarEdicao(this); };
  }

  function salvarEdicao(botao) {
    const linha = botao.closest('tr');
    const inputs = linha.querySelectorAll('input');
    
    // Atualizar conte√∫do das c√©lulas
    linha.cells[0].textContent = inputs[0].value;
    linha.cells[1].textContent = inputs[1].value;
    
    // Restaurar bot√£o original
    botao.textContent = "‚úèÔ∏è Editar";
    botao.onclick = function() { editarLinha(this); };
  }

  function excluirUsuario(botao, username) {
    if (confirm(`Tem certeza que deseja excluir o usu√°rio ${username}?`)) {
      botao.closest('tr').remove();
    }
  }
</script>
</body>
</html>